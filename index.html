
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERSYS - Gestão de Diesel</title>

    <link rel="icon" type="image/png" href="https://gfivmnnysomfwrffybeh.supabase.co/storage/v1/object/public/logo//LOGO_TERSYS-removebg-preview%20(1).png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <style>
        .login-bg-image-new {
            background-image: url('https://ikypygpbdmoxozfmwewr.supabase.co/storage/v1/object/sign/Loginpage/unnamed%20(1).png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9lMGJiMDk5Zi1jZmE5LTQ5Y2UtYjUwNy0wZmE2ZWZkYWYxOTIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJMb2dpbnBhZ2UvdW5uYW1lZCAoMSkucG5nIiwiaWF0IjoxNzU5MjYxNjYwLCJleHAiOjIwNzQ2MjE2NjB9.rulaTJo6deZqm5CNYCEfbKBf1K3HzljRLHRPoqAl_V8');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e0e0e0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #bdbdbd; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script type="text/javascript">
        // Definição dos ícones Lucide que usaremos
        const icons = {
            LayoutDashboard: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>',
            Ticket: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9a3 3 0 0 1 0 6v1a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-1a3 3 0 0 1 0-6V8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>',
            Fuel: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" x2="15" y1="22" y2="22"/><line x1="4" x2="14" y1="9" y2="9"/><path d="M14 22V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v18"/><path d="M14 13h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2v-4Z"/></svg>',
            Ship: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 21c.6.5 1.2 1 2.5 1 1.6 0 2.5-.5 5-1 2.5-.5 3.4 0 5 1 1.6.5 2.5 0 5-1 2.5-1 3-1.5 3-2 0 0 0-6.5-2-8l-2-2-2.5 1-1.5-2-3-2-3 2-1.5 2-2.5-1-2 2c-2 1.5-2 8-2 8Z"/><path d="M2 15h20"/><path d="M8 21V9l2-3 2 3v12"/><path d="m18 21-1-3-1 3h2Z"/></svg>',
            Beaker: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-16V3"/><path d="M6 14h12"/></svg>',
            Users: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            LogOut: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 16 22 12 17 8"/><line x1="22" x2="11" y1="12" y2="12"/></svg>',
            Menu: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>',
            ChevronUp: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up"><path d="m18 15-6-6-6 6"/></svg>',
            ChevronDown: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>',
            Trash2: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>',
            PlusCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>',
            Building: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M12 18h.01"/></svg>',
            FileText: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L15 2z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>',
            Tank: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="6" rx="2"/><path d="M12 6V4"/><path d="M12 2v2"/><path d="M10 2h4"/><path d="m14 6-1 1-1-1"/><path d="m10 6-1 1-1-1"/><path d="M6 22h12"/><path d="M6 18h2"/><path d="M16 18h2"/></svg>',
            ChevronsLeft: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m11 17-5-5 5-5"/><path d="m18 17-5-5 5-5"/></svg>',
            CalendarDays: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>',
            Settings: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.28a2 2 0 0 0 .73 2.73l.04.02a2 2 0 0 1 .97 1.95v.44a2 2 0 0 1-.97 1.95l-.04.02a2 2 0 0 0-.73 2.73l.78 1.28a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.28a2 2 0 0 0-.73-2.73l-.04-.02a2 2 0 0 1-.97-1.95v-.44a2 2 0 0 1 .97-1.95l-.04-.02a2 2 0 0 0 .73-2.73l-.78-1.28a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>',
            ChevronsRight: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 17 5-5-5-5"/><path d="m13 17 5-5-5-5"/></svg>',
            Edit: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>',
        };
        window.onload = function() {
            // ================================================================
            // 1. CONFIGURAÇÃO
            // ================================================================
            const SUPABASE_URL = 'https://ikypygpbdmoxozfmwewr.supabase.co';
            // ATENÇÃO: A CHAVE ABAIXO PARECE ESTAR INCORRETA/INVALIDADA. SUBSTITUA PELA CHAVE DO SEU PAINEL SUPABASE.
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlreXB5Z3BiZG1veG96Zm13ZXdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTE0MTYsImV4cCI6MjA3NDcyNzQxNn0.IWoX896KWVC9p1M9EcFTOk6YhSljDOtxIl3yPxZS0Xg';
            let supabase;

            const SUPABASE_URL_PROJETO_2 = 'https://gfivmnnysomfwrffybeh.supabase.co';
            const SUPABASE_ANON_KEY_PROJETO_2 = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmaXZtbm55c29tZndyZmZ5YmVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyOTY3NjgsImV4cCI6MjA2ODg3Mjc2OH0.NxetXJoCLh4q9zAqn_olimziI3YP4MAJzB8ed4qf8cg';
            let supabaseProjeto2;
            
            // ================================================================
            // 2. COMPONENTES AUXILIARES (Helpers)
            // ================================================================

            async function gerarAlertasEmLote(dadosImportados, plataformaAtual, combustivelMap) {
                if (!dadosImportados || dadosImportados.length === 0) return;

                console.log("Iniciando geração de alertas em lote...");
                const novosAlertas = [];
                
                const dadosMapeados = dadosImportados.map(item => ({
                    placa: item.placa,
                    data: new Date(item.data),
                    combustivelOriginal: item.combustivelOriginal
                }));

                const placasUnicas = [...new Set(dadosMapeados.map(d => d.placa).filter(Boolean))];
                if (placasUnicas.length === 0) return;

                const tipoAlertaPlacaNaoEncontrada = 'Placa não encontrada na base de equipamentos';
                const tipoAlertaDuplicidade = 'Abastecimento em 2 plataformas';
                const tipoAlertaCombustivel = 'Combustível não mapeado'; // Usaremos sempre o valor genérico
                const periodosUnicos = [...new Set(dadosMapeados.map(d => d.data.toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric' })))];

                const [
                    { data: placasExternasExistentes },
                    { data: abastecimentosOutraPlataforma },
                    { data: alertasJaExistentes }
                ] = await Promise.all([
                    supabaseProjeto2.from('equipamentos').select('plate').in('plate', placasUnicas),
                    supabase.from(plataformaAtual === 'ticket' ? 'shell_abastecimentos' : 'ticket_abastecimentos').select('placa').in('placa', placasUnicas).gte(plataformaAtual === 'ticket' ? 'data_hora_transacao' : 'data_transacao', new Date(dadosMapeados[0].data.getFullYear(), dadosMapeados[0].data.getMonth(), 1).toISOString()).lte(plataformaAtual === 'ticket' ? 'data_hora_transacao' : 'data_transacao', new Date(dadosMapeados[0].data.getFullYear(), dadosMapeados[0].data.getMonth() + 1, 0, 23, 59, 59).toISOString()),
                    supabase.from('alertas').select('placa, periodo, tipo_alerta').in('placa', placasUnicas).in('periodo', periodosUnicos).in('tipo_alerta', [tipoAlertaPlacaNaoEncontrada, tipoAlertaDuplicidade, tipoAlertaCombustivel])
                ]);
                
                const setPlacasExternas = new Set(placasExternasExistentes?.map(p => p.plate));
                const setPlacasOutraPlataforma = new Set(abastecimentosOutraPlataforma?.map(a => a.placa));
                const setAlertasExistentes = new Set(alertasJaExistentes?.map(a => `${a.placa}-${a.periodo}-${a.tipo_alerta}`));

                for (const item of dadosMapeados) {
                    if (!item.placa || !item.data) continue;
                    const periodo = item.data.toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric' });

                    if (!setPlacasExternas.has(item.placa)) {
                        const chave = `${item.placa}-${periodo}-${tipoAlertaPlacaNaoEncontrada}`;
                        if (!setAlertasExistentes.has(chave)) {
                            novosAlertas.push({ placa: item.placa, periodo, tipo_alerta: tipoAlertaPlacaNaoEncontrada, status: 'pendente' });
                            setAlertasExistentes.add(chave);
                        }
                    }
                    
                    if (setPlacasOutraPlataforma.has(item.placa)) {
                         const chave = `${item.placa}-${periodo}-${tipoAlertaDuplicidade}`;
                         if (!setAlertasExistentes.has(chave)) {
                            novosAlertas.push({ placa: item.placa, periodo, tipo_alerta: tipoAlertaDuplicidade, status: 'pendente' });
                            setAlertasExistentes.add(chave);
                         }
                    }

                    if (item.combustivelOriginal && !combustivelMap.has(item.combustivelOriginal)) {
                        const chave = `${item.placa}-${periodo}-${tipoAlertaCombustivel}`;
                        if (!setAlertasExistentes.has(chave)) {
                            novosAlertas.push({ 
                                placa: item.placa, 
                                periodo, 
                                tipo_alerta: tipoAlertaCombustivel, 
                                detalhes: item.combustivelOriginal, // <-- Salva o nome específico aqui
                                status: 'pendente' 
                            });
                            setAlertasExistentes.add(chave);
                        }
                    }
                }

                if (novosAlertas.length > 0) {
                    console.log(`Inserindo ${novosAlertas.length} novos alertas...`);
                    const { error: insertError } = await supabase.from('alertas').insert(novosAlertas);
                    if (insertError) throw insertError;
                }
                console.log("Geração de alertas em lote concluída.");
            }
            function formatarNumeroBR(numero, casasDecimais = 2) {
                if (typeof numero !== 'number' || isNaN(numero)) {
                    return (0).toLocaleString('pt-BR', {
                        minimumFractionDigits: casasDecimais,
                        maximumFractionDigits: casasDecimais
                    });
                }
                return numero.toLocaleString('pt-BR', {
                    minimumFractionDigits: casasDecimais,
                    maximumFractionDigits: casasDecimais
                });
            }
            function LucideIcon({ name, className }) {
                return React.createElement('span', {
                    className: className,
                    dangerouslySetInnerHTML: { __html: icons[name] || '' }
                });
            }

            function Toast({ message, type, onClose }) {
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                React.useEffect(() => {
                    const timer = setTimeout(() => onClose(), 3000);
                    return () => clearTimeout(timer);
                }, [onClose]);
                return React.createElement('div', { className: `fixed bottom-4 right-4 ${bgColor} text-white p-4 rounded-lg shadow-lg flex items-center z-50` }, message);
            }

            function DateRangePicker({ onDatesChange, placeholder }) {
                const inputRef = React.useRef(null);
                React.useEffect(() => {
                    if (!inputRef.current) return;
                    const fp = flatpickr(inputRef.current, {
                        mode: 'range',
                        dateFormat: "Y-m-d",
                        altInput: true,
                        altFormat: "d/m/Y",
                        locale: "pt",
                        onChange: (selectedDates) => {
                            if (selectedDates.length === 2) {
                                onDatesChange(selectedDates);
                            } else if (selectedDates.length === 0) {
                                onDatesChange([]);
                            }
                        },
                    });
                    return () => fp.destroy();
                }, [onDatesChange]);
                return React.createElement('div', { className: "relative w-full" },
                    React.createElement('div', { className: "absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none" },
                        React.createElement(LucideIcon, { name: "CalendarDays", className: "h-5 w-5 text-gray-400" })
                    ),
                    React.createElement('input', {
                        ref: inputRef,
                        type: 'text',
                        placeholder: placeholder || 'Selecione o período...',
                        className: 'w-full p-2 pl-10 border rounded'
                    })
                );
            }

            function ConfirmationModal({ message, onConfirm, onCancel }) {
                return React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" },
                    React.createElement('div', { className: "bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center" },
                        React.createElement('p', { className: "text-lg font-semibold text-gray-800 mb-6" }, message),
                        React.createElement('div', { className: "flex justify-center space-x-4" },
                            React.createElement('button', { onClick: onConfirm, className: "px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition" }, "Confirmar"),
                            React.createElement('button', { onClick: onCancel, className: "px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition" }, "Cancelar")
                        )
                    )
                );
            }

            // ================================================================
            // 3. COMPONENTES DE PÁGINA (Módulos)
            // ================================================================

            function LoginPage({ onLogin }) {
                const [usuario, setUsuario] = React.useState('');
                const [senha, setSenha] = React.useState('');
                const [error, setError] = React.useState('');
                const [isLoggingIn, setIsLoggingIn] = React.useState(false);
                const handleLogin = async (e) => {
                    e.preventDefault();
                    setIsLoggingIn(true);
                    setError('');
                    try {
                        const { data, error: fetchError } = await supabase
                            .from('usuarios')
                            .select('*')
                            .eq('usuario', usuario.toLowerCase())
                            .eq('senha', senha)
                            .single();
                        if (fetchError || !data) {
                            setError('Usuário ou senha inválidos.');
                        } else {
                            onLogin(data);
                        }
                    } catch (e) {
                        setError("Erro ao autenticar. Tente novamente.");
                    }
                    setIsLoggingIn(false);
                };
                return (
                    React.createElement('div', { className: "min-h-screen flex" },
                        React.createElement('div', { className: "w-full lg:w-1/2 flex items-center justify-center p-8 bg-white" },
                            React.createElement('div', { className: "max-w-md w-full" },
                                React.createElement('div', { className: "flex justify-center mb-6" },
                                    React.createElement('img', {
                                        src: "https://ikypygpbdmoxozfmwewr.supabase.co/storage/v1/object/sign/logo/LOGO_TERSYS-removebg-preview%20(1)%20(1).png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9lMGJiMDk5Zi1jZmE5LTQ5Y2UtYjUwNy0wZmE2ZWZkYWYxOTIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJsb2dvL0xPR09fVEVSU1lTLXJlbW92ZWJnLXByZXZpZXcgKDEpICgxKS5wbmciLCJpYXQiOjE3NTk5NjY4OTUsImV4cCI6MjA3NTMyNjg5NX0.s5l16HeRsUTzw0wECTs63OECJcOoaA03DYTopziVawk",
                                        alt: "TERSYS Logo",
                                        className: "h-auto w-auto"
                                    })
                                ),
                                error && React.createElement('div', { className: "bg-red-100 text-red-700 p-3 rounded text-center mb-4" }, error),
                                React.createElement('form', { onSubmit: handleLogin, className: "space-y-6" },
                                    React.createElement('div', null,
                                        React.createElement('label', { htmlFor: "username", className: "block text-sm font-medium text-gray-700" }, "Usuário"),
                                        React.createElement('input', { type: "text", id: "username", value: usuario, onChange: (e) => setUsuario(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500", placeholder: "Seu usuário", required: true, disabled: isLoggingIn })
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('label', { htmlFor: "password", className: "block text-sm font-medium text-gray-700" }, "Senha"),
                                        React.createElement('input', { type: "password", id: "password", value: senha, onChange: (e) => setSenha(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500", placeholder: "Sua senha", required: true, disabled: isLoggingIn })
                                    ),
                                    React.createElement('button', { type: "submit", className: "w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50", disabled: isLoggingIn }, isLoggingIn ? 'Entrando...' : 'Entrar')
                                )
                            )
                        ),
                        React.createElement('div', { className: "hidden lg:block lg:w-1/2 login-bg-image-new" })
                    )
                );
            }

            function Alertas({ user, showToast, onViewPlaca }) {
    const [alertas, setAlertas] = React.useState([]);
    const [prioridades, setPrioridades] = React.useState(new Map());
    const [isLoading, setIsLoading] = React.useState(true);
    const [filterStatus, setFilterStatus] = React.useState('pendente');
    const [searchTerm, setSearchTerm] = React.useState('');
    const [selectedPeriods, setSelectedPeriods] = React.useState([]);
    const [allPeriods, setAllPeriods] = React.useState([]);
    const [selectedAlerts, setSelectedAlerts] = React.useState(new Set());
    const [detailedAlert, setDetailedAlert] = React.useState(null);
    const [detailedAbastecimentos, setDetailedAbastecimentos] = React.useState([]);
    const [isDetailLoading, setIsDetailLoading] = React.useState(false);
    const [showBulkObservacao, setShowBulkObservacao] = React.useState(false);
    const [bulkObservacao, setBulkObservacao] = React.useState('');
    const [filterPrioridade, setFilterPrioridade] = React.useState('todas');

    const MultiPeriodoPicker = ({ allPeriods, selectedPeriods, onChange }) => {
        const [isOpen, setIsOpen] = React.useState(false);
        const ref = React.useRef(null);

        const handlePeriodToggle = (period) => {
            const newSelection = new Set(selectedPeriods);
            if (newSelection.has(period)) {
                newSelection.delete(period);
            } else {
                newSelection.add(period);
            }
            onChange(Array.from(newSelection));
        };
        
        React.useEffect(() => {
            const handleClickOutside = (event) => {
                if (ref.current && !ref.current.contains(event.target)) {
                    setIsOpen(false);
                }
            };
            document.addEventListener("mousedown", handleClickOutside);
            return () => document.removeEventListener("mousedown", handleClickOutside);
        }, [ref]);

        const displayLabel = selectedPeriods.length === 0 ? 'Selecione o(s) período(s)...' :
                           selectedPeriods.length === 1 ? selectedPeriods[0] :
                           `${selectedPeriods.length} períodos selecionados`;

        return React.createElement('div', { className: 'relative', ref: ref },
            React.createElement('button', { onClick: () => setIsOpen(!isOpen), className: 'w-full p-2 border rounded bg-white text-left flex justify-between items-center' },
                React.createElement('span', { className: 'truncate' }, displayLabel),
                React.createElement(LucideIcon, { name: isOpen ? 'ChevronUp' : 'ChevronDown', className: 'h-5 w-5 text-gray-400' })
            ),
            isOpen && React.createElement('div', { className: 'absolute z-10 w-full mt-1 bg-white border rounded shadow-lg max-h-60 overflow-y-auto' },
                allPeriods.map(period =>
                    React.createElement('label', { key: period, className: 'flex items-center p-2 hover:bg-gray-100 cursor-pointer' },
                        React.createElement('input', {
                            type: 'checkbox',
                            className: 'h-4 w-4 mr-2',
                            checked: selectedPeriods.includes(period),
                            onChange: () => handlePeriodToggle(period)
                        }),
                        period
                    )
                )
            )
        );
    };

    const fetchAlertas = React.useCallback(async () => {
        setIsLoading(true);
        try {
            const { data: alertasData, error: alertasError } = await supabase
                .from('alertas')
                .select('*, alerta_prioridades ( prioridade, cor_badge )')
                .order('data_criacao', { ascending: false });

            if (alertasError) throw alertasError;
            
            const prioridadesMap = new Map();
            const alertasComPrioridade = alertasData.map(a => {
                const tipoBase = a.tipo_alerta.startsWith('Combustível não mapeado') ? 'Combustível não mapeado' : a.tipo_alerta;
                const p = a.alerta_prioridades;
                if (p && !prioridadesMap.has(tipoBase)) {
                    prioridadesMap.set(tipoBase, { prioridade: p.prioridade, cor: p.cor_badge });
                }
                return { ...a, prioridadeInfo: p || null };
            });
            
            setAlertas(alertasComPrioridade || []);
            setPrioridades(prioridadesMap);

            const uniquePeriods = [...new Set(alertasData.map(a => a.periodo).filter(Boolean))];
            uniquePeriods.sort((a, b) => {
                const [mesA, anoA] = a.split('/');
                const [mesB, anoB] = b.split('/');
                return new Date(anoB, mesB - 1) - new Date(anoA, mesA - 1);
            });
            setAllPeriods(uniquePeriods);

        } catch (err) {
            showToast("Erro ao carregar dados.", "error");
        }
        setIsLoading(false);
    }, [showToast]);

    React.useEffect(() => {
        fetchAlertas();
    }, [fetchAlertas]);

    const filteredAlerts = React.useMemo(() => {
        return alertas.filter(alerta => {
            const matchStatus = filterStatus === 'todos' || alerta.status === filterStatus;
            const matchSearch = !searchTerm || (alerta.placa && alerta.placa.toLowerCase().includes(searchTerm.toLowerCase()));
            const matchPeriod = selectedPeriods.length === 0 || selectedPeriods.includes(alerta.periodo);
            const matchPrioridade = filterPrioridade === 'todas' || alerta.prioridadeInfo?.prioridade === filterPrioridade;
            return matchStatus && matchSearch && matchPeriod && matchPrioridade;
        });
    }, [alertas, filterStatus, searchTerm, selectedPeriods, filterPrioridade]);

    const handleSelectAlert = (id) => {
        const newSelection = new Set(selectedAlerts);
        if (newSelection.has(id)) {
            newSelection.delete(id);
        } else {
            newSelection.add(id);
        }
        setSelectedAlerts(newSelection);
        setShowBulkObservacao(false);
    };

    const handleBulkConclude = async () => {
        if (selectedAlerts.size === 0) return;
        setIsLoading(true);
        
        const { error } = await supabase
            .from('alertas')
            .update({ 
                status: 'concluido', 
                observacao: bulkObservacao.trim(),
                usuario_conclusao: user.nome,
                data_conclusao: new Date().toISOString()
            })
            .in('id', [...selectedAlerts]);

        if (error) {
            showToast("Erro ao concluir alertas.", "error");
        } else {
            showToast(`${selectedAlerts.size} alertas concluídos com sucesso!`, "success");
            setSelectedAlerts(new Set());
            setShowBulkObservacao(false);
            setBulkObservacao('');
            fetchAlertas();
        }
        setIsLoading(false);
    };

    const handleShowDetails = async (alerta) => {
        setDetailedAlert(alerta);
        setIsDetailLoading(true);
        try {
            if (alerta.tipo_alerta === 'Aferição não realizada') {
                setDetailedAbastecimentos([]);
                setIsDetailLoading(false);
                return;
            }

            const [mes, ano] = alerta.periodo.split('/');
            const primeiroDia = new Date(ano, mes - 1, 1);
            const ultimoDia = new Date(ano, mes, 0, 23, 59, 59);

            const [ticketRes, shellRes] = await Promise.all([
                supabase.from('ticket_abastecimentos').select('*').eq('placa', alerta.placa).gte('data_transacao', primeiroDia.toISOString()).lte('data_transacao', ultimoDia.toISOString()),
                supabase.from('shell_abastecimentos').select('*').eq('placa', alerta.placa).gte('data_hora_transacao', primeiroDia.toISOString()).lte('data_hora_transacao', ultimoDia.toISOString())
            ]);

            if(ticketRes.error || shellRes.error) throw new Error("Falha ao buscar abastecimentos.");

            const combined = [
                ...(ticketRes.data || []).map(a => ({...a, plataforma: 'Ticket'})),
                ...(shellRes.data || []).map(a => ({...a, plataforma: 'Shell'}))
            ];
            setDetailedAbastecimentos(combined);

        } catch (err) {
            showToast(err.message, "error");
        } finally {
            setIsDetailLoading(false);
        }
    };

    const AlertCard = ({ alerta }) => {
        const tipoAlertaBase = alerta.tipo_alerta.startsWith('Combustível não mapeado') ? 'Combustível não mapeado' : alerta.tipo_alerta;
        const alertaPrioridade = prioridades.get(tipoAlertaBase) || { prioridade: 'N/D', cor: 'bg-gray-400 text-white' };
        const labelPrincipal = alerta.tipo_alerta === 'Aferição não realizada' ? 'Tanque' : 'Placa';

        return React.createElement('div', { className: `bg-white p-4 rounded-lg shadow-md border-l-4 ${alerta.status === 'pendente' ? 'border-yellow-500' : 'border-green-500'} flex items-start gap-4` },
            alerta.status === 'pendente' && React.createElement('input', { type: 'checkbox', className: 'h-5 w-5 mt-1 text-blue-600 border-gray-300 rounded focus:ring-blue-500', checked: selectedAlerts.has(alerta.id), onChange: () => handleSelectAlert(alerta.id) }),
            React.createElement('div', { className: 'flex-grow' },
                React.createElement('div', { className: 'flex justify-between items-start' },
                    React.createElement('p', { className: "text-sm text-gray-500" }, `Período: ${alerta.periodo || 'N/A'}`),
                    React.createElement('span', { className: `text-xs font-semibold px-2 py-1 rounded-full ${alertaPrioridade.cor}` }, alertaPrioridade.prioridade)
                ),
                React.createElement('p', { 
                    className: `text-lg font-bold text-gray-800 mt-1 ${labelPrincipal === 'Placa' ? 'cursor-pointer hover:text-blue-600' : ''}`,
                    onClick: labelPrincipal === 'Placa' ? () => onViewPlaca(alerta.placa) : null
                }, `${labelPrincipal}: ${alerta.placa || 'N/A'}`),
                React.createElement('p', { className: "text-sm text-gray-600 mt-1" }, `Alerta: ${alerta.tipo_alerta}`),
                alerta.detalhes && React.createElement('p', { className: "text-sm text-red-600 font-semibold mt-1" }, `Detalhe: ${alerta.detalhes}`),
                alerta.status === 'concluido' && React.createElement('p', { className: 'text-xs text-gray-500 mt-1 italic' }, `Concluído por ${alerta.usuario_conclusao} com a obs: "${alerta.observacao}"`),
                React.createElement('div', { className: 'mt-2' },
                    React.createElement('button', { onClick: () => handleShowDetails(alerta), className: 'text-sm font-semibold text-blue-600 hover:underline' }, 'Ver Detalhes')
                )
            )
        );
    };

    const AlertDetailsModal = () => (
        React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50", onClick: () => setDetailedAlert(null) },
            React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-2xl max-w-4xl w-full text-left mx-4", onClick: (e) => e.stopPropagation() },
                React.createElement('h3', { className: 'text-xl font-bold mb-4' }, `Detalhes do Alerta - ${detailedAlert?.tipo_alerta === 'Aferição não realizada' ? 'Tanque' : 'Placa'} ${detailedAlert?.placa}`),
                isDetailLoading ? React.createElement('p', null, 'Carregando detalhes...') :
                detailedAlert?.tipo_alerta === 'Aferição não realizada' ? React.createElement('p', null, 'Este tipo de alerta não possui abastecimentos detalhados.') :
                detailedAbastecimentos.length === 0 ? React.createElement('p', null, 'Nenhum abastecimento encontrado para este alerta.') :
                React.createElement('div', { className: 'max-h-96 overflow-y-auto' },
                    React.createElement('table', { className: 'w-full text-sm' },
                        React.createElement('thead', {className: 'bg-gray-100'}, 
                            React.createElement('tr', null, ['Data', 'Plataforma', 'Litros', 'Valor Total'].map(h => React.createElement('th', { key: h, className: 'p-2 text-left font-semibold' }, h)))
                        ),
                        React.createElement('tbody', null, 
                            detailedAbastecimentos.map(a => React.createElement('tr', { key: a.id, className: 'border-b' },
                                React.createElement('td', { className: 'p-2' }, new Date(a.data_transacao || a.data_hora_transacao).toLocaleString('pt-BR')),
                                React.createElement('td', { className: 'p-2' }, a.plataforma),
                                React.createElement('td', { className: 'p-2' }, a.litros),
                                React.createElement('td', { className: 'p-2' }, `R$ ${(a.valor_emissao || a.total_abastecimento || 0).toFixed(2)}`)
                            ))
                        )
                    )
                ),
                React.createElement('button', { onClick: () => setDetailedAlert(null), className: 'mt-6 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300' }, 'Fechar')
            )
        )
    );

    return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
        detailedAlert && React.createElement(AlertDetailsModal, null),
        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-2 text-center" }, "Painel de Alertas"),
        React.createElement('p', { className: 'text-center text-gray-500 mb-6' }, 'Filtre, analise e gerencie os alertas do sistema.'),
        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 border rounded-lg bg-gray-50 items-end' },
            React.createElement('div', null, 
                React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Status'),
                React.createElement('select', { value: filterStatus, onChange: e => setFilterStatus(e.target.value), className: 'w-full p-2 border rounded bg-white' },
                    React.createElement('option', { value: 'pendente' }, 'Pendentes'),
                    React.createElement('option', { value: 'concluido' }, 'Concluídas'),
                    React.createElement('option', { value: 'todos' }, 'Todos')
                )
            ),
            React.createElement('div', null,
                React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Prioridade'),
                React.createElement('select', { value: filterPrioridade, onChange: e => setFilterPrioridade(e.target.value), className: 'w-full p-2 border rounded bg-white' },
                    React.createElement('option', { value: 'todas' }, 'Todas'),
                    React.createElement('option', { value: 'Alta' }, 'Alta'),
                    React.createElement('option', { value: 'Média' }, 'Média'),
                    React.createElement('option', { value: 'Baixa' }, 'Baixa')
                )
            ),
            React.createElement('div', null,
                React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Buscar por Placa/Tanque'),
                React.createElement('input', { type: 'text', placeholder: 'Digite a placa ou tanque...', value: searchTerm, onChange: e => setSearchTerm(e.target.value), className: 'w-full p-2 border rounded' })
            ),
            React.createElement('div', null,
                React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Filtrar por Período(s)'),
                React.createElement(MultiPeriodoPicker, { allPeriods: allPeriods, selectedPeriods: selectedPeriods, onChange: setSelectedPeriods })
            )
        ),
        
        selectedAlerts.size > 0 && React.createElement('div', { className: 'mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg' },
            React.createElement('div', { className: 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4' },
                React.createElement('p', { className: 'font-semibold' }, `${selectedAlerts.size} alertas selecionados`),
                !showBulkObservacao && React.createElement('button', { onClick: () => setShowBulkObservacao(true), className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700' }, 'Concluir Selecionados'),
                showBulkObservacao && React.createElement('div', { className: 'flex flex-col sm:flex-row items-stretch gap-2 w-full sm:w-auto' },
                    React.createElement('input', {
                        type: 'text',
                        placeholder: 'Adicionar observação (opcional)...',
                        value: bulkObservacao,
                        onChange: (e) => setBulkObservacao(e.target.value),
                        className: 'p-2 border rounded w-full sm:w-64'
                    }),
                    React.createElement('button', { onClick: handleBulkConclude, className: 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700' }, 'Confirmar'),
                    React.createElement('button', { onClick: () => setShowBulkObservacao(false), className: 'px-4 py-2 bg-gray-300 text-black rounded-lg hover:bg-gray-400' }, 'Cancelar')
                )
            )
        ),

        isLoading ?
        React.createElement('p', null, 'Carregando alertas...') :
        filteredAlerts.length === 0 ?
        React.createElement('p', { className: 'text-center text-gray-500 py-8' }, 'Nenhum alerta encontrado para os filtros aplicados.') :
        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4' }, 
            filteredAlerts.map(alerta => React.createElement(AlertCard, { key: alerta.id, alerta: alerta }))
        )
    );
}
            function PerfilVeiculo({ user, showToast, placa, onBack }) {
                const [veiculo, setVeiculo] = React.useState(null);
                const [abastecimentos, setAbastecimentos] = React.useState([]);
                const [alertas, setAlertas] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(true);

                const ChartComponent = ({ chartId, type, data, options }) => {
                    const canvasRef = React.useRef(null);
                    React.useEffect(() => {
                        if (!canvasRef.current || !data) return;
                        const chart = new Chart(canvasRef.current, { type, data, options });
                        return () => chart.destroy();
                    }, [data, type, options]);
                    return React.createElement('canvas', { ref: canvasRef, id: chartId });
                };

                React.useEffect(() => {
                    const fetchData = async () => {
                        if (!placa) return;
                        setIsLoading(true);
                        try {
                            const [eqRes, ticketRes, shellRes, ctaRes, alertasRes] = await Promise.all([
                                supabaseProjeto2.from('equipamentos').select('type, brand, model').eq('plate', placa).single(),
                                supabase.from('ticket_abastecimentos').select('*').eq('placa', placa).order('data_transacao', { ascending: false }),
                                supabase.from('shell_abastecimentos').select('*').eq('placa', placa).order('data_hora_transacao', { ascending: false }),
                                supabase.from('cta_abastecimentos').select('*').eq('placa', placa).order('data_hora_inicio', { ascending: false }),
                                supabase.from('alertas').select('*').eq('placa', placa).order('data_criacao', { ascending: false })
                            ]);

                            // Verificação individual de cada resposta da API
                            if (eqRes.error && eqRes.error.code !== 'PGRST116') { // PGRST116 = "o resultado não contém exatamente uma linha", o que é ok se a placa não existir
                                throw new Error(`Erro ao buscar equipamento: ${eqRes.error.message}`);
                            }
                            if (ticketRes.error) throw new Error(`Erro ao buscar abastecimentos Ticket: ${ticketRes.error.message}`);
                            if (shellRes.error) throw new Error(`Erro ao buscar abastecimentos Shell: ${shellRes.error.message}`);
                            if (ctaRes.error) throw new Error(`Erro ao buscar abastecimentos CTA: ${ctaRes.error.message}`);
                            if (alertasRes.error) throw new Error(`Erro ao buscar alertas: ${alertasRes.error.message}`);

                            setVeiculo(eqRes.data || { type: 'N/A', brand: 'N/A', model: 'N/A' });

                            const todosAbastecimentos = [
                                ...(ticketRes.data || []),
                                ...(shellRes.data || []),
                                ...(ctaRes.data || [])
                            ].sort((a, b) => new Date(b.data_transacao || b.data_hora_transacao || b.data_hora_inicio) - new Date(a.data_transacao || a.data_hora_transacao || a.data_hora_inicio));
                            setAbastecimentos(todosAbastecimentos);

                            setAlertas(alertasRes.data || []);

                        } catch (err) {
                            // MUDANÇA PRINCIPAL: Agora o erro detalhado será exibido no console
                            console.error("Erro detalhado ao carregar perfil do veículo:", err);
                            showToast("Erro ao carregar perfil. Verifique o console.", "error");
                        } finally {
                            // Garante que o "carregando" sempre termine
                            setIsLoading(false);
                        }
                    };
                    fetchData();
                }, [placa, showToast]);

                const stats = React.useMemo(() => {
                    if (!abastecimentos) return {};
                    const custoTotal = abastecimentos.reduce((sum, a) => sum + (a.valor_emissao || a.total_abastecimento || a.custo_total || 0), 0);
                    const volumeTotal = abastecimentos.reduce((sum, a) => sum + (a.litros || a.volume || 0), 0);
                    return {
                        custoTotal: `R$ ${custoTotal.toFixed(2)}`,
                        volumeTotal: `${volumeTotal.toFixed(2)} L`,
                        precoMedio: `R$ ${(custoTotal / volumeTotal || 0).toFixed(3)} /L`,
                        totalAbastecimentos: abastecimentos.length,
                    };
                }, [abastecimentos]);
                
                const chartData = React.useMemo(() => {
                    if (!abastecimentos) return null;
                    const ultimosAbastecimentos = abastecimentos.slice(0, 12).reverse();
                    return {
                        labels: ultimosAbastecimentos.map(a => new Date(a.data_transacao || a.data_hora_transacao || a.data_hora_inicio).toLocaleDateString('pt-BR')),
                        datasets: [{
                            label: 'Custo Total (R$)',
                            data: ultimosAbastecimentos.map(a => (a.valor_emissao || a.total_abastecimento || a.custo_total || 0)),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            yAxisID: 'yCusto',
                            tension: 0.1
                        }, {
                            label: 'Volume (L)',
                            data: ultimosAbastecimentos.map(a => (a.litros || a.volume || 0)),
                            borderColor: 'rgb(234, 179, 8)',
                            backgroundColor: 'rgba(234, 179, 8, 0.5)',
                            yAxisID: 'yVolume',
                            tension: 0.1
                        }]
                    };
                }, [abastecimentos]);

                if (isLoading) {
                    return React.createElement('p', {className: "text-center p-10 font-semibold text-blue-600"}, 'Carregando perfil do veículo...');
                }

                return React.createElement('div', null,
                    React.createElement('button', { onClick: onBack, className: 'flex items-center gap-2 text-sm font-semibold text-blue-600 mb-6 hover:underline' }, React.createElement(LucideIcon, { name: 'ChevronsLeft' }), 'Voltar'),
                    React.createElement('div', { className: 'bg-white p-6 rounded-xl shadow-lg' },
                        React.createElement('h2', { className: "text-3xl font-bold text-gray-800" }, `Perfil do Veículo: ${placa}`),
                        React.createElement('p', { className: 'text-gray-500' }, `${veiculo.type} ${veiculo.brand} ${veiculo.model}`),
                        
                        React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4 my-6' },
                            React.createElement('div', { className: 'bg-gray-50 p-4 rounded-lg text-center' }, React.createElement('p', { className: 'text-sm' }, 'Custo Total'), React.createElement('p', { className: 'font-bold text-xl' }, stats.custoTotal)),
                            React.createElement('div', { className: 'bg-gray-50 p-4 rounded-lg text-center' }, React.createElement('p', { className: 'text-sm' }, 'Volume Total'), React.createElement('p', { className: 'font-bold text-xl' }, stats.volumeTotal)),
                            React.createElement('div', { className: 'bg-gray-50 p-4 rounded-lg text-center' }, React.createElement('p', { className: 'text-sm' }, 'Preço Médio'), React.createElement('p', { className: 'font-bold text-xl' }, stats.precoMedio)),
                            React.createElement('div', { className: 'bg-gray-50 p-4 rounded-lg text-center' }, React.createElement('p', { className: 'text-sm' }, 'Nº de Abastecimentos'), React.createElement('p', { className: 'font-bold text-xl' }, stats.totalAbastecimentos))
                        ),

                        React.createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-6' },
                            React.createElement('div', null, 
                                React.createElement('h3', { className: 'font-semibold mb-2' }, 'Histórico de Consumo (Últimos 12)'),
                                React.createElement('div', { className: 'h-80 bg-gray-50 p-2 rounded-lg' },
                                    React.createElement(ChartComponent, { chartId: 'perfilConsumo', type: 'line', data: chartData, options: { maintainAspectRatio: false, responsive: true, scales: { yCusto: { type: 'linear', display: true, position: 'left' }, yVolume: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } } } } })
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('h3', { className: 'font-semibold mb-2' }, 'Histórico de Alertas'),
                                React.createElement('div', { className: 'space-y-2 max-h-80 overflow-y-auto bg-gray-50 p-2 rounded-lg' },
                                    !alertas || alertas.length === 0 ? React.createElement('p', {className: 'p-4 text-sm text-center'}, 'Nenhum alerta para este veículo.') :
                                    alertas.map(alerta => React.createElement('div', { key: alerta.id, className: `p-2 rounded text-sm ${alerta.status === 'pendente' ? 'bg-yellow-100 border-l-4 border-yellow-500' : 'bg-green-100'}` }, 
                                        React.createElement('p', {className: 'font-semibold'}, alerta.tipo_alerta),
                                        React.createElement('p', {className: 'text-xs'}, `Período: ${alerta.periodo} - Status: ${alerta.status}`)
                                    ))
                                )
                            )
                        )
                    )
                );
            }
            function CadastroAlertas({ user, showToast }) {
                const [tiposAlerta, setTiposAlerta] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(true);
                const [showForm, setShowForm] = React.useState(false);
                const [isEditing, setIsEditing] = React.useState(false);
                const [currentAlerta, setCurrentAlerta] = React.useState(null);
                const initialFormState = { tipo_alerta: '', prioridade: 'Média', cor_badge: 'bg-yellow-500 text-white' };
                const [formData, setFormData] = React.useState(initialFormState);
                const [showConfirmModal, setShowConfirmModal] = React.useState(false);
                const [alertaToDelete, setAlertaToDelete] = React.useState(null);

                const prioridadeOptions = {
                    'Alta': 'bg-red-500 text-white',
                    'Média': 'bg-yellow-500 text-black',
                    'Baixa': 'bg-blue-500 text-white',
                };

                const fetchTiposAlerta = React.useCallback(async () => {
                    setIsLoading(true);
                    try {
                        const { data, error } = await supabase.from('alerta_prioridades').select('*').order('prioridade');
                        if (error) throw error;
                        setTiposAlerta(data || []);
                    } catch (err) {
                        showToast("Erro ao carregar os tipos de alerta.", "error");
                    }
                    setIsLoading(false);
                }, [showToast]);

                React.useEffect(() => {
                    fetchTiposAlerta();
                }, [fetchTiposAlerta]);

                const handleInputChange = (e) => {
                    const { name, value } = e.target;
                    const newFormData = { ...formData, [name]: value };
                    // Atualiza a cor automaticamente quando a prioridade muda
                    if (name === 'prioridade') {
                        newFormData.cor_badge = prioridadeOptions[value] || '';
                    }
                    setFormData(newFormData);
                };

                const handleFormSubmit = async (e) => {
                    e.preventDefault();
                    if (!formData.tipo_alerta.trim() || !formData.prioridade) {
                        showToast("Preencha todos os campos obrigatórios.", "error");
                        return;
                    }
                    setIsLoading(true);
                    
                    const record = { ...formData };
                    let error;

                    if (isEditing) {
                        ({ error } = await supabase.from('alerta_prioridades').update(record).eq('id', currentAlerta.id));
                    } else {
                        ({ error } = await supabase.from('alerta_prioridades').insert([record]));
                    }

                    if (error) {
                        showToast(`Erro ao salvar: ${error.message}`, "error");
                    } else {
                        showToast(`Tipo de alerta salvo com sucesso!`, "success");
                        setShowForm(false);
                        setIsEditing(false);
                        fetchTiposAlerta();
                    }
                    setIsLoading(false);
                };

                const handleEditClick = (alerta) => {
                    setIsEditing(true);
                    setCurrentAlerta(alerta);
                    setFormData(alerta);
                    setShowForm(true);
                };
                
                const confirmDelete = (alerta) => {
                    setAlertaToDelete(alerta);
                    setShowConfirmModal(true);
                };

                const handleDelete = async () => {
                    if (!alertaToDelete) return;
                    setIsLoading(true);
                    const { error } = await supabase.from('alerta_prioridades').delete().eq('id', alertaToDelete.id);
                    if (error) {
                        showToast(`Erro ao excluir: ${error.message}`, "error");
                    } else {
                        showToast("Tipo de alerta excluído com sucesso!", "success");
                        fetchTiposAlerta();
                    }
                    setIsLoading(false);
                    setShowConfirmModal(false);
                    setAlertaToDelete(null);
                };
                
                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    showConfirmModal && React.createElement(ConfirmationModal, { 
                        message: `Deseja realmente excluir o tipo de alerta "${alertaToDelete?.tipo_alerta}"?`, 
                        onConfirm: handleDelete, 
                        onCancel: () => setShowConfirmModal(false) 
                    }),
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Cadastro de Tipos de Alerta"),
                    
                    !showForm && React.createElement('div', { className: 'flex justify-center mb-6' },
                        React.createElement('button', {
                            onClick: () => { setShowForm(true); setIsEditing(false); setFormData(initialFormState); },
                            className: "p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center"
                        }, React.createElement(LucideIcon, { name: 'PlusCircle', className: 'mr-2 h-5 w-5' }), "Novo Tipo de Alerta")
                    ),

                    showForm && React.createElement('form', { onSubmit: handleFormSubmit, className: "grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-4 border rounded-lg bg-gray-50" },
                        React.createElement('input', { name: "tipo_alerta", value: formData.tipo_alerta, onChange: handleInputChange, placeholder: "Nome do Tipo de Alerta*", className: "p-2 border rounded md:col-span-2" }),
                        React.createElement('select', { name: "prioridade", value: formData.prioridade, onChange: handleInputChange, className: "p-2 border rounded bg-white" },
                            Object.keys(prioridadeOptions).map(p => React.createElement('option', { key: p, value: p }, p))
                        ),
                        React.createElement('div', { className: "md:col-span-3 flex justify-end gap-4" },
                            React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "py-2 px-4 bg-gray-300 rounded-lg" }, "Cancelar"),
                            React.createElement('button', { type: "submit", className: "py-2 px-4 bg-blue-600 text-white rounded-lg", disabled: isLoading }, isLoading ? 'Salvando...' : 'Salvar')
                        )
                    ),

                    React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
                        React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                            React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                                React.createElement('tr', null,
                                    ["Tipo de Alerta", "Prioridade", "Ações"].map(h => React.createElement('th', { key: h, className: "px-6 py-4 font-semibold" }, h))
                                )
                            ),
                            React.createElement('tbody', null,
                                isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 3, className: "p-4 text-center" }, "Carregando...")) :
                                tiposAlerta.map(item => React.createElement('tr', { key: item.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                                    React.createElement('td', { className: "px-6 py-4" }, item.tipo_alerta),
                                    React.createElement('td', { className: "px-6 py-4" }, 
                                        React.createElement('span', { className: `text-xs font-semibold px-2 py-1 rounded-full ${item.cor_badge}` }, item.prioridade)
                                    ),
                                    React.createElement('td', { className: "px-6 py-4 flex items-center gap-4" }, 
                                        React.createElement('button', { onClick: () => handleEditClick(item), className: "text-gray-400 hover:text-blue-600" }, React.createElement(LucideIcon, { name: 'Edit', className: 'h-5 w-5' })),
                                        React.createElement('button', { onClick: () => confirmDelete(item), className: "text-gray-400 hover:text-red-600" }, React.createElement(LucideIcon, { name: 'Trash2', className: 'h-5 w-5' }))
                                    )
                                ))
                            )
                        )
                    )
                );
            }
            function AnaliseCustos({ user, showToast }) {
                const [dados, setDados] = React.useState(null);
                const [isLoading, setIsLoading] = React.useState(false);
                const [periodoA, setPeriodoA] = React.useState(null);
                const [periodoB, setPeriodoB] = React.useState(null);

                const ChartComponent = ({ chartId, type, data, options }) => {
                    const canvasRef = React.useRef(null);
                    React.useEffect(() => {
                        if (!canvasRef.current || !data) return;
                        const chart = new Chart(canvasRef.current, { type, data, options });
                        return () => chart.destroy();
                    }, [data, type, options]);
                    return React.createElement('canvas', { ref: canvasRef, id: chartId });
                };

                const fetchData = async () => {
                    if (!periodoA || !periodoB) {
                        showToast("Por favor, selecione ambos os períodos para comparar.", "info");
                        return;
                    }
                    setIsLoading(true);
                    try {
                        const [inicioA, fimA] = periodoA;
                        const [inicioB, fimB] = periodoB;

                        const [ticketRes, shellRes, ctaRes] = await Promise.all([
                            supabase.from('ticket_abastecimentos').select('valor_emissao, litros, data_transacao').limit(10000), // LIMITE AUMENTADO
                            supabase.from('shell_abastecimentos').select('total_abastecimento, litros, data_hora_transacao').limit(10000), // LIMITE AUMENTADO
                            supabase.from('cta_abastecimentos').select('custo_total, volume, data_hora_inicio').limit(10000) // LIMITE AUMENTADO
                        ]);

                        if (ticketRes.error || shellRes.error || ctaRes.error) throw new Error("Falha ao buscar dados de abastecimento.");

                        const processaPeriodo = (dados, campoValor, campoLitros, campoData, inicio, fim) => {
                            const fimAjustado = new Date(fim);
                            fimAjustado.setHours(23, 59, 59);

                            return dados.filter(item => {
                                const dataItem = new Date(item[campoData]);
                                return dataItem >= inicio && dataItem <= fimAjustado;
                            }).reduce((acc, item) => {
                                acc.custoTotal += item[campoValor] || 0;
                                acc.volumeTotal += (item[campoLitros] || item.volume) || 0;
                                return acc;
                            }, { custoTotal: 0, volumeTotal: 0 });
                        };

                        const plataformas = ['Ticket', 'Shell', 'CTA'];
                        const dadosComparativos = plataformas.map(p => {
                            let res, campos;
                            if (p === 'Ticket') { res = ticketRes.data; campos = { valor: 'valor_emissao', litros: 'litros', data: 'data_transacao' }; }
                            else if (p === 'Shell') { res = shellRes.data; campos = { valor: 'total_abastecimento', litros: 'litros', data: 'data_hora_transacao' }; }
                            else { res = ctaRes.data; campos = { valor: 'custo_total', litros: 'volume', data: 'data_hora_inicio' }; }
                            
                            const dadosA = processaPeriodo(res, campos.valor, campos.litros, campos.data, inicioA, fimA);
                            const dadosB = processaPeriodo(res, campos.valor, campos.litros, campos.data, inicioB, fimB);
                            
                            return {
                                plataforma: p,
                                periodoA: { ...dadosA, precoMedio: dadosA.custoTotal / dadosA.volumeTotal || 0 },
                                periodoB: { ...dadosB, precoMedio: dadosB.custoTotal / dadosB.volumeTotal || 0 }
                            };
                        });
                        
                        setDados(dadosComparativos);
                    } catch (err) {
                        showToast("Erro ao carregar dados para análise.", "error");
                    }
                    setIsLoading(false);
                };

                const ComparisonCard = ({ title, data }) => {
                    const variacaoCusto = data.periodoB.custoTotal - data.periodoA.custoTotal;
                    const variacaoPercentualCusto = data.periodoA.custoTotal > 0 ? (variacaoCusto / data.periodoA.custoTotal) * 100 : 0;
                    const corCusto = variacaoCusto > 0 ? 'text-red-500' : 'text-green-500';
                    
                    const variacaoPreco = data.periodoB.precoMedio - data.periodoA.precoMedio;
                    const variacaoPercentualPreco = data.periodoA.precoMedio > 0 ? (variacaoPreco / data.periodoA.precoMedio) * 100 : 0;
                    const corPreco = variacaoPreco > 0 ? 'text-red-500' : 'text-green-500';

                    return React.createElement('div', { className: 'bg-white p-4 rounded-lg shadow-md border' },
                        React.createElement('h3', { className: 'text-lg font-bold text-gray-800 text-center mb-4' }, title),
                        React.createElement('div', { className: 'space-y-4' },
                            React.createElement('div', null,
                                React.createElement('p', { className: 'text-sm text-gray-500' }, 'Custo Total'),
                                React.createElement('div', { className: 'flex items-baseline gap-2' },
                                    React.createElement('p', { className: 'text-xl font-semibold' }, `R$ ${formatarNumeroBR(data.periodoB.custoTotal)}`),
                                    React.createElement('span', { className: `text-sm font-bold ${corCusto}` }, `${formatarNumeroBR(variacaoPercentualCusto, 1)}%`)
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('p', { className: 'text-sm text-gray-500' }, 'Preço Médio / Litro'),
                                React.createElement('div', { className: 'flex items-baseline gap-2' },
                                     React.createElement('p', { className: 'text-xl font-semibold' }, `R$ ${formatarNumeroBR(data.periodoB.precoMedio, 3)}`),
                                     React.createElement('span', { className: `text-sm font-bold ${corPreco}` }, `${formatarNumeroBR(variacaoPercentualPreco, 1)}%`)
                                )
                            )
                        )
                    );
                };

                return React.createElement('div', { className: 'bg-white p-6 rounded-xl shadow-lg' },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Análise Comparativa de Custos"),
                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 border rounded-lg bg-gray-50 items-end' },
                        React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Período A (Base)'), React.createElement(DateRangePicker, { onDatesChange: setPeriodoA, placeholder: 'Selecione o período base...' })),
                        React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Período B (Comparação)'), React.createElement(DateRangePicker, { onDatesChange: setPeriodoB, placeholder: 'Selecione o período a comparar...' })),
                        React.createElement('button', { onClick: fetchData, disabled: isLoading, className: 'w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400' }, isLoading ? 'Analisando...' : 'Analisar')
                    ),

                    !isLoading && dados && React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-6' },
                        dados.map(d => React.createElement(ComparisonCard, { key: d.plataforma, title: d.plataforma, data: d }))
                    ),
                    
                    !isLoading && dados && React.createElement('div', { className: 'mt-8 bg-white p-6 rounded-xl shadow-lg' },
                        React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 'Comparativo de Preço Médio (R$/L)'),
                        React.createElement('div', { className: 'h-80' },
                            React.createElement(ChartComponent, { 
                                chartId: 'comparativoChart', 
                                type: 'bar', 
                                data: {
                                    labels: dados.map(d => d.plataforma),
                                    datasets: [
                                        { label: 'Período A', data: dados.map(d => d.periodoA.precoMedio), backgroundColor: 'rgba(156, 163, 175, 0.7)' },
                                        { label: 'Período B', data: dados.map(d => d.periodoB.precoMedio), backgroundColor: 'rgba(59, 130, 246, 0.7)' }
                                    ]
                                }, 
                                options: { 
                                    maintainAspectRatio: false, 
                                    responsive: true,
                                    plugins: {
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    let label = context.dataset.label || '';
                                                    if (label) { label += ': '; }
                                                    if (context.parsed.y !== null) {
                                                        label += `R$ ${formatarNumeroBR(context.parsed.y, 3)}`;
                                                    }
                                                    return label;
                                                }
                                            }
                                        }
                                    }
                                } 
                            })
                        )
                    )
                );
            }
            function AnaliseEquipamentos({ user, showToast, onViewPlaca }) {
                const [dados, setDados] = React.useState(null);
                const [isLoading, setIsLoading] = React.useState(false);
                const [dateRange, setDateRange] = React.useState([]);

                const ChartComponent = ({ chartId, type, data, options }) => {
                    const canvasRef = React.useRef(null);
                    React.useEffect(() => {
                        if (!canvasRef.current || !data) return;
                        const chart = new Chart(canvasRef.current, { type, data, options });
                        return () => chart.destroy();
                    }, [data, type, options]);
                    return React.createElement('canvas', { ref: canvasRef, id: chartId });
                };

                const fetchData = async () => {
                    if (dateRange.length !== 2) {
                        showToast("Por favor, selecione um período para a análise.", "info");
                        return;
                    }
                    setIsLoading(true);
                    try {
                        const [inicio, fim] = dateRange;
                        const fimAjustado = new Date(fim);
                        fimAjustado.setHours(23, 59, 59);

                        const [ticketRes, shellRes, ctaRes] = await Promise.all([
                            supabase.from('ticket_abastecimentos').select('placa, litros').gte('data_transacao', inicio.toISOString()).lte('data_transacao', fimAjustado.toISOString()).limit(10000), // LIMITE AUMENTADO
                            supabase.from('shell_abastecimentos').select('placa, litros').gte('data_hora_transacao', inicio.toISOString()).lte('data_hora_transacao', fimAjustado.toISOString()).limit(10000), // LIMITE AUMENTADO
                            supabase.from('cta_abastecimentos').select('placa, volume').gte('data_hora_inicio', inicio.toISOString()).lte('data_hora_inicio', fimAjustado.toISOString()).limit(10000) // LIMITE AUMENTADO
                        ]);

                        if (ticketRes.error || shellRes.error || ctaRes.error) throw new Error("Falha ao buscar dados de abastecimento.");
                        
                        const todosAbastecimentos = [
                            ...(ticketRes.data || []),
                            ...(shellRes.data || []),
                            ...(ctaRes.data.map(a => ({...a, litros: a.volume})))
                        ];

                        if (todosAbastecimentos.length === 0) {
                            setDados(null);
                            throw new Error("Nenhum abastecimento encontrado no período selecionado.");
                        }

                        const placasUnicas = [...new Set(todosAbastecimentos.map(a => a.placa).filter(Boolean))];
                        const { data: equipamentos, error: eqError } = await supabaseProjeto2.from('equipamentos').select('plate, type').in('plate', placasUnicas);
                        if (eqError) throw eqError;

                        const tipoPorPlaca = new Map(equipamentos.map(eq => [eq.plate, eq.type || 'Não Categorizado']));

                        const consumoPorTipo = todosAbastecimentos.reduce((acc, abs) => {
                            if (!abs.placa) return acc;
                            const tipo = tipoPorPlaca.get(abs.placa) || 'Não Categorizado';
                            if (!acc[tipo]) {
                                acc[tipo] = { volume: 0, placas: new Set() };
                            }
                            acc[tipo].volume += (abs.litros || 0);
                            acc[tipo].placas.add(abs.placa);
                            return acc;
                        }, {});
                        
                        const sortedData = Object.entries(consumoPorTipo)
                            .map(([tipo, data]) => ({ tipo, volume: data.volume, placas: Array.from(data.placas) }))
                            .sort((a, b) => b.volume - a.volume);

                        let topData = sortedData;
                        if (sortedData.length > 10) {
                            const top10 = sortedData.slice(0, 10);
                            const outros = sortedData.slice(10).reduce((acc, current) => {
                                acc.volume += current.volume;
                                current.placas.forEach(p => acc.placas.add(p));
                                return acc;
                            }, { volume: 0, placas: new Set() });
                            
                            topData = [...top10, { tipo: 'Outros', volume: outros.volume, placas: Array.from(outros.placas) }];
                        }

                        const chartData = {
                            labels: topData.map(d => d.tipo),
                            datasets: [{
                                label: 'Volume Consumido (L)',
                                data: topData.map(d => d.volume), // Envia o número bruto para o gráfico
                                backgroundColor: ['#3B82F6', '#F59E0B', '#EF4444', '#10B981', '#6366F1', '#8B5CF6', '#EC4899', '#6B7280', '#F97316', '#84CC16', '#06B6D4'],
                                borderWidth: 1
                            }]
                        };

                        setDados({ chartData, tableData: topData });

                    } catch (err) {
                        showToast(err.message, "error");
                    }
                    setIsLoading(false);
                };

                return React.createElement('div', { className: 'bg-white p-6 rounded-xl shadow-lg' },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Análise de Consumo por Tipo de Equipamento"),
                    
                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-4 border rounded-lg bg-gray-50 items-end' },
                        React.createElement('div', { className: 'md:col-span-2' },
                            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Período de Análise'),
                            React.createElement(DateRangePicker, { onDatesChange: setDateRange, placeholder: "Selecione o período para analisar..." })
                        ),
                        React.createElement('button', { onClick: fetchData, disabled: isLoading, className: 'w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400' },
                            isLoading ? 'Analisando...' : 'Analisar Período'
                        )
                    ),
                    
                    isLoading ? React.createElement('p', { className: 'text-center p-10' }, 'Analisando dados...') :
                    !dados ? React.createElement('p', { className: 'text-center text-gray-500 py-8' }, 'Selecione um período e clique em "Analisar" para ver os dados.') :
                    React.createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-8 items-start' },
                        React.createElement('div', { className: 'h-96' },
                           React.createElement(ChartComponent, { 
                                chartId: 'consumoTipoChart', 
                                type: 'bar', 
                                data: dados.chartData, 
                                options: { 
                                    maintainAspectRatio: false, 
                                    responsive: true, 
                                    indexAxis: 'y', 
                                    plugins: { 
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    return `Volume: ${formatarNumeroBR(context.parsed.x)} L`;
                                                }
                                            }
                                        }
                                    } 
                                } 
                            })
                        ),
                        React.createElement('div', { className: 'max-h-96 overflow-y-auto' },
                            React.createElement('table', { className: 'w-full text-sm text-left' },
                                React.createElement('thead', { className: 'text-xs text-gray-700 uppercase bg-gray-100 sticky top-0' },
                                    React.createElement('tr', null, 
                                        React.createElement('th', { className: 'px-6 py-3' }, 'Tipo de Equipamento'),
                                        React.createElement('th', { className: 'px-6 py-3' }, 'Volume Total (L)'),
                                        React.createElement('th', { className: 'px-6 py-3' }, 'Placas (Amostra)')
                                    )
                                ),
                                React.createElement('tbody', null,
                                    dados.tableData.map(({ tipo, volume, placas }) => 
                                        React.createElement('tr', { key: tipo, className: 'bg-white border-b' },
                                            React.createElement('td', { className: 'px-6 py-4 font-medium text-gray-900' }, tipo),
                                            React.createElement('td', { className: 'px-6 py-4' }, formatarNumeroBR(volume)),
                                            React.createElement('td', { className: 'px-6 py-4' },
                                                placas.slice(0, 3).map(placa => React.createElement('span', {
                                                    key: placa,
                                                    onClick: () => onViewPlaca(placa),
                                                    className: 'inline-block bg-gray-200 rounded-full px-3 py-1 text-xs font-semibold text-gray-700 mr-2 mb-2 cursor-pointer hover:bg-blue-200'
                                                }, placa)),
                                                placas.length > 3 && React.createElement('span', {className: 'text-xs text-gray-500'}, ` +${placas.length - 3} outras`)
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                );
            }
            function Afericoes({ user, showToast }) {
                const [afericoes, setAfericoes] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(false);
                const [showForm, setShowForm] = React.useState(false);
                const [opcoesTanque, setOpcoesTanque] = React.useState([]);
                const initialFormState = { tanque: '', data_afericao: '', volume_balde: 20, volume_cta: '', volume_bomba: '', observacao: '' };
                const [formData, setFormData] = React.useState(initialFormState);
                const [filters, setFilters] = React.useState({ tanque: '', data_inicio: null, data_fim: null });
                const [hasSearched, setHasSearched] = React.useState(false);

                 const ChartComponent = ({ chartId, type, data, options }) => {
                    const canvasRef = React.useRef(null);
                    React.useEffect(() => {
                        if (!canvasRef.current || !data) return;
                        const chart = new Chart(canvasRef.current, { type, data, options });
                        return () => chart.destroy();
                    }, [data, type, options]);
                    return React.createElement('canvas', { ref: canvasRef, id: chartId });
                };

                React.useEffect(() => {
                    const fetchTanqueOptions = async () => {
                        const { data, error } = await supabase
                            .from('filiais')
                            .select('centro_de_custo_final')
                            .not('cta_cod_posto', 'is', null);

                        if (error) {
                            showToast("Erro ao carregar opções de tanque.", "error");
                        } else {
                            const uniqueOptions = [...new Set(data.map(item => item.centro_de_custo_final).filter(Boolean))];
                            setOpcoesTanque(uniqueOptions.sort());
                        }
                    };
                    fetchTanqueOptions();
                }, [showToast]);

                const formatDate = (dateString) => {
                    if (!dateString) return '—';
                    const date = new Date(dateString.includes('T') ? dateString : dateString + 'T00:00:00');
                    return date.toLocaleDateString('pt-BR');
                };

                const handleFilterChange = (e) => { setFilters(prev => ({ ...prev, [e.target.name]: e.target.value })); };
                const handleInputChange = (e) => { setFormData(prev => ({ ...prev, [e.target.name]: e.target.value })); };
                
                const handleSearch = async () => {
                    setHasSearched(true);
                    setIsLoading(true);
                    try {
                        let query = supabase.from('afericoes').select('*');
                        if (filters.tanque) query = query.ilike('tanque', `%${filters.tanque.trim()}%`);
                        if (filters.data_inicio) {
                            query = query.gte('data_afericao', filters.data_inicio.toISOString());
                        }
                        if (filters.data_fim) {
                            const endDate = new Date(filters.data_fim);
                            endDate.setHours(23, 59, 59, 999);
                            query = query.lte('data_afericao', endDate.toISOString());
                        }
                        query = query.order('data_afericao', { ascending: false });
                        const { data, error } = await query;
                        if (error) throw error;
                        setAfericoes(data || []);
                    } catch (err) {
                        showToast("Erro ao buscar aferições.", "error");
                    }
                    setIsLoading(false);
                };

                const handleFormSubmit = async (e) => {
                    e.preventDefault();
                    setIsLoading(true);
                    try {
                        const recordToInsert = { ...formData, volume_balde: parseFloat(formData.volume_balde) || 0, volume_cta: parseFloat(formData.volume_cta) || 0, volume_bomba: parseFloat(formData.volume_bomba) || 0, usuario_criacao: user.nome, };
                        const { error: insertError } = await supabase.from('afericoes').insert([recordToInsert]);
                        if (insertError) throw insertError;

                        showToast("Aferição registrada com sucesso!", "success");

                        if (formData.tanque && formData.data_afericao) {
                            const dataObj = new Date(formData.data_afericao + 'T12:00:00');
                            const periodo = dataObj.toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric' });

                            await supabase
                                .from('alertas')
                                .update({
                                    status: 'concluido',
                                    observacao: `Aferição registrada em ${dataObj.toLocaleDateString('pt-BR')}. Concluído automaticamente.`,
                                    usuario_conclusao: 'Sistema',
                                    data_conclusao: new Date().toISOString()
                                })
                                .eq('placa', formData.tanque)
                                .eq('periodo', periodo)
                                .eq('tipo_alerta', 'Aferição não realizada')
                                .eq('status', 'pendente');
                        }

                        setFormData(initialFormState);
                        setShowForm(false);
                        setHasSearched(false);
                        setAfericoes([]);
                    } catch (err) {
                        showToast(`Erro ao registrar: ${err.message}`, "error");
                    }
                    setIsLoading(false);
                };

                const stats = React.useMemo(() => {
                    if (!afericoes || afericoes.length === 0) return { variacaoMedia: 0, perdaTotal: 0, chartData: null };

                    let perdaTotal = 0;
                    const variacoes = [];
                    
                    const chartDataProcessed = afericoes
                        .sort((a,b) => new Date(a.data_afericao) - new Date(b.data_afericao))
                        .map(item => {
                            const diffBomba = item.volume_bomba - item.volume_balde;
                            perdaTotal += diffBomba;
                            variacoes.push(diffBomba);
                            return {
                                data: new Date(item.data_afericao + 'T12:00:00').toLocaleDateString('pt-BR'),
                                variacao: diffBomba
                            };
                        });

                    const variacaoMedia = variacoes.length > 0 ? variacoes.reduce((a,b) => a+b, 0) / variacoes.length : 0;

                    const chartData = {
                        labels: chartDataProcessed.map(d => d.data),
                        datasets: [{
                            label: 'Variação Bomba vs. Balde (L)',
                            data: chartDataProcessed.map(d => d.variacao),
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.5)',
                            tension: 0.1
                        }]
                    };
                    
                    return { variacaoMedia, perdaTotal, chartData };
                }, [afericoes]);

                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Aferições de Tanques e Análise de Variação"),
                    
                    !showForm && React.createElement('div', { className: 'flex justify-center mb-6' },
                        React.createElement('button', { onClick: () => setShowForm(true), className: "p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center" }, React.createElement(LucideIcon, { name: 'PlusCircle', className: 'mr-2 h-5 w-5' }), "Nova Aferição")
                    ),
                    showForm && React.createElement('form', { onSubmit: handleFormSubmit, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8 p-4 border rounded-lg bg-gray-50" },
                        React.createElement('select', { name: "tanque", value: formData.tanque, onChange: handleInputChange, className: "p-2 border rounded", required: true }, React.createElement('option', { value: '' }, 'Selecione o Tanque*'), opcoesTanque.map(t => React.createElement('option', { key: t, value: t }, t))),
                        React.createElement('input', { name: "data_afericao", type: "date", value: formData.data_afericao, onChange: handleInputChange, className: "p-2 border rounded", required: true }),
                        React.createElement('input', { name: "volume_balde", type: "number", step: "0.01", value: formData.volume_balde, onChange: handleInputChange, placeholder: "Volume Balde (L)*", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "volume_cta", type: "number", step: "0.01", value: formData.volume_cta, onChange: handleInputChange, placeholder: "Volume CTA (L)", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "volume_bomba", type: "number", step: "0.01", value: formData.volume_bomba, onChange: handleInputChange, placeholder: "Volume Bomba (L)", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "observacao", value: formData.observacao, onChange: handleInputChange, placeholder: "Observação", className: "p-2 border rounded" }),
                        React.createElement('div', { className: "md:col-span-full flex justify-end gap-4" }, React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "py-2 px-4 bg-gray-300 rounded-lg" }, "Cancelar"), React.createElement('button', { type: "submit", className: "py-2 px-4 bg-blue-600 text-white rounded-lg", disabled: isLoading }, isLoading ? 'Salvando...' : 'Salvar'))
                    ),

                    React.createElement('div', { className: "mb-6 p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-3 gap-4 items-end" },
                        React.createElement('div', { className: "md:col-span-2" },
                            React.createElement(DateRangePicker, { onDatesChange: (dates) => { setFilters(prev => ({ ...prev, data_inicio: dates[0] || null, data_fim: dates[1] || null })); } })
                        ),
                        React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "Tanque"), React.createElement('input', { type: "text", name: "tanque", value: filters.tanque, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
                        React.createElement('button', { onClick: handleSearch, disabled: isLoading, className: "w-full p-2 bg-blue-600 text-white rounded-lg md:col-start-3" }, 'Buscar')
                    ),
                    
                    hasSearched && afericoes.length > 0 && React.createElement('div', { className: 'mb-8' },
                        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6 mb-6' },
                            React.createElement('div', { className: 'bg-gray-50 p-4 rounded-lg text-center' },
                                React.createElement('p', { className: 'text-sm font-medium text-gray-500' }, 'Variação Média por Aferição'),
                                React.createElement('p', { className: `text-2xl font-bold mt-1 ${stats.variacaoMedia > 0 ? 'text-red-600' : 'text-green-600'}` }, `${stats.variacaoMedia.toFixed(3)} L`)
                            ),
                             React.createElement('div', { className: 'bg-gray-50 p-4 rounded-lg text-center' },
                                React.createElement('p', { className: 'text-sm font-medium text-gray-500' }, 'Sobra / Perda Total no Período'),
                                React.createElement('p', { className: `text-2xl font-bold mt-1 ${stats.perdaTotal > 0 ? 'text-red-600' : 'text-green-600'}` }, `${stats.perdaTotal.toFixed(2)} L`)
                            )
                        ),
                        React.createElement('div', { className: 'h-80 bg-gray-50 p-4 rounded-lg' },
                            React.createElement(ChartComponent, { chartId: 'afericoesChart', type: 'line', data: stats.chartData, options: { maintainAspectRatio: false, responsive: true } })
                        )
                    ),

                    React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
                        React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                            React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                                React.createElement('tr', null,
                                    ["Data Aferição", "Tanque", "Vol. Balde", "Vol. CTA", "Vol. Bomba", "Diferenças", "Observação"].map(h => React.createElement('th', { key: h, className: "px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0" }, h))
                                )
                            ),
                            React.createElement('tbody', null,
                                isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-4 text-center" }, "Carregando...")) :
                                !hasSearched ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-6 text-center text-slate-500" }, "Utilize os filtros para buscar as aferições.")) :
                                afericoes.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-6 text-center text-slate-500" }, "Nenhuma aferição encontrada.")) :
                                afericoes.map(item => {
                                    const diffCta = item.volume_cta - item.volume_balde;
                                    const diffBomba = item.volume_bomba - item.volume_balde;
                                    return React.createElement('tr', { key: item.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, formatDate(item.data_afericao)),
                                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, React.createElement('span', { className: 'font-medium text-slate-800' }, item.tanque)),
                                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.volume_balde.toFixed(2)),
                                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.volume_cta.toFixed(2)),
                                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.volume_bomba.toFixed(2)),
                                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" },
                                            React.createElement('div', null,
                                                React.createElement('p', { className: diffCta !== 0 ? 'text-red-600 font-semibold' : '' }, `CTA: ${diffCta.toFixed(2)} L`),
                                                React.createElement('p', { className: diffBomba !== 0 ? 'text-red-600 font-semibold' : '' }, `Bomba: ${diffBomba.toFixed(2)} L`)
                                            )
                                        ),
                                        React.createElement('td', { className: "px-6 py-4" }, item.observacao)
                                    );
                                })
                            )
                        )
                    )
                );
            }
            
            function MapeamentoCombustivel({ user, showToast }) {
                const [regras, setRegras] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(true);
                const [showForm, setShowForm] = React.useState(false);
                const initialFormState = { nome_original: '', nome_padronizado: '', plataforma: '' };
                const [formData, setFormData] = React.useState(initialFormState);
                
                const fetchRegras = React.useCallback(async () => {
                    setIsLoading(true);
                    try {
                        const { data, error } = await supabase.from('combustivel_mapeamento').select('*').order('nome_padronizado');
                        if (error) throw error;
                        setRegras(data || []);
                    } catch (err) {
                        showToast("Erro ao carregar regras de mapeamento.", "error");
                    }
                    setIsLoading(false);
                }, [showToast]);

                React.useEffect(() => {
                    fetchRegras();
                }, [fetchRegras]);

                const handleInputChange = (e) => {
                    setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
                };

                const handleFormSubmit = async (e) => {
                    e.preventDefault();
                    if (!formData.nome_original.trim() || !formData.nome_padronizado.trim()) {
                        showToast("Os campos 'Nome Original' e 'Nome Padronizado' são obrigatórios.", "error");
                        return;
                    }
                    setIsLoading(true);
                    try {
                        const record = {
                            nome_original: formData.nome_original.trim(),
                            nome_padronizado: formData.nome_padronizado.trim(),
                            plataforma: formData.plataforma.trim() || null,
                            usuario_criacao: user.nome,
                        };
                        const { error } = await supabase.from('combustivel_mapeamento').insert([record]);
                        if (error) throw error;
                        showToast("Regra de mapeamento criada com sucesso!", "success");
                        setShowForm(false);
                        setFormData(initialFormState);
                        fetchRegras();
                    } catch (err) {
                        showToast(`Erro ao salvar: ${err.message}`, "error");
                    }
                    setIsLoading(false);
                };

                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Mapeamento de Combustível (DE/PARA)"),
                    !showForm && React.createElement('div', { className: 'flex justify-center mb-6' },
                        React.createElement('button', {
                            onClick: () => { setShowForm(true); setFormData(initialFormState); },
                            className: "p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center"
                        }, React.createElement(LucideIcon, { name: 'PlusCircle', className: 'mr-2 h-5 w-5' }), "Nova Regra")
                    ),
                    showForm && React.createElement('form', { onSubmit: handleFormSubmit, className: "grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-4 border rounded-lg bg-gray-50" },
                        React.createElement('input', { name: "nome_original", value: formData.nome_original, onChange: handleInputChange, placeholder: "Nome na Planilha (DE)*", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "nome_padronizado", value: formData.nome_padronizado, onChange: handleInputChange, placeholder: "Nome Padrão (PARA)*", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "plataforma", value: formData.plataforma, onChange: handleInputChange, placeholder: "Plataforma (Ex: Ticket)", className: "p-2 border rounded" }),
                        React.createElement('div', { className: "md:col-span-3 flex justify-end gap-4" },
                            React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "py-2 px-4 bg-gray-300 rounded-lg" }, "Cancelar"),
                            React.createElement('button', { type: "submit", className: "py-2 px-4 bg-blue-600 text-white rounded-lg", disabled: isLoading }, isLoading ? 'Salvando...' : 'Salvar')
                        )
                    ),
                    React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
                        React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                            React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                                React.createElement('tr', null,
                                    ["Nome na Planilha (DE)", "Nome Padrão (PARA)", "Plataforma"].map(h => 
                                        React.createElement('th', { key: h, className: "px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0" }, h)
                                    )
                                )
                            ),
                            React.createElement('tbody', null,
                                isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 3, className: "p-4 text-center" }, "Carregando...")) :
                                regras.map(item => React.createElement('tr', { key: item.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.nome_original),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, React.createElement('span', { className: 'font-medium text-slate-800' }, item.nome_padronizado)),
                                    React.createElement('td', { className: "px-6 py-4" }, item.plataforma)
                                ))
                            )
                        )
                    )
                );
            }
            function AnaliseGeografica({ user, showToast, onViewPlaca }) {
    const [dadosPorCidade, setDadosPorCidade] = React.useState([]);
    const [isLoading, setIsLoading] = React.useState(false);
    const [loadingMessage, setLoadingMessage] = React.useState('Selecione os filtros e clique em "Analisar" para carregar o mapa.');
    const mapRef = React.useRef(null);
    const mapInstance = React.useRef(null);
    const [dateRange, setDateRange] = React.useState([]);
    const [selectedPlataformas, setSelectedPlataformas] = React.useState(['Ticket', 'Shell', 'CTA']);
    
    window.viewPlacaProfile = (placa) => {
        onViewPlaca(placa);
    };

    const PlataformaPicker = ({ onChange, selected }) => {
        const plataformas = ['Ticket', 'Shell', 'CTA'];
        const handleToggle = (p) => {
            const newSelection = new Set(selected);
            if (newSelection.has(p)) newSelection.delete(p);
            else newSelection.add(p);
            onChange(Array.from(newSelection));
        };
        return React.createElement('div', { className: 'flex flex-wrap gap-2' },
            plataformas.map(p => React.createElement('button', {
                key: p,
                onClick: () => handleToggle(p),
                className: `px-3 py-1 text-sm rounded-full border ${selected.includes(p) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 hover:bg-gray-100'}`
            }, p))
        );
    };
    
    const fetchData = async () => {
        if (dateRange.length !== 2) {
            showToast("Por favor, selecione um período para a análise.", "info");
            return;
        }
        setIsLoading(true);
        setDadosPorCidade([]);
        try {
            const [inicio, fim] = dateRange;
            const fimAjustado = new Date(fim);
            fimAjustado.setHours(23, 59, 59);
            setLoadingMessage('Buscando dados de abastecimento...');

            const ticketPromise = selectedPlataformas.includes('Ticket')
                ? supabase.from('ticket_abastecimentos').select('cidade, uf, placa, valor_emissao, litros').gte('data_transacao', inicio.toISOString()).lte('data_transacao', fimAjustado.toISOString()).limit(10000)
                : Promise.resolve({ data: [] });
            const shellPromise = selectedPlataformas.includes('Shell')
                ? supabase.from('shell_abastecimentos').select('cidade, estado, placa, total_abastecimento, litros').gte('data_hora_transacao', inicio.toISOString()).lte('data_hora_transacao', fimAjustado.toISOString()).limit(10000)
                : Promise.resolve({ data: [] });
            const ctaPromise = selectedPlataformas.includes('CTA')
                ? supabase.from('cta_abastecimentos').select('cod_posto, placa, custo_total, volume').gte('data_hora_inicio', inicio.toISOString()).lte('data_hora_inicio', fimAjustado.toISOString()).limit(10000)
                : Promise.resolve({ data: [] });
            const filiaisPromise = supabase.from('filiais').select('cta_cod_posto, nome_filial');

            const [ticketRes, shellRes, ctaRes, filiaisRes] = await Promise.all([ticketPromise, shellPromise, ctaPromise, filiaisPromise]);

            if (ticketRes.error || shellRes.error || ctaRes.error || filiaisRes.error) throw new Error("Falha ao buscar dados de abastecimento.");
            
            const postoCidadeMap = new Map(filiaisRes.data.map(f => [f.cta_cod_posto, f.nome_filial]));
            const todosAbastecimentos = [
                ...(ticketRes.data || []).map(a => ({ cidade: a.cidade && a.uf ? `${a.cidade.trim()} - ${a.uf.trim()}` : a.cidade, placa: a.placa, custo: a.valor_emissao, volume: a.litros })),
                ...(shellRes.data || []).map(a => ({ cidade: a.cidade && a.estado ? `${a.cidade.trim()} - ${a.estado.trim()}` : a.cidade, placa: a.placa, custo: a.total_abastecimento, volume: a.litros })),
                ...(ctaRes.data || []).map(a => ({ cidade: postoCidadeMap.get(a.cod_posto), placa: a.placa, custo: a.custo_total, volume: a.volume }))
            ];

            if (todosAbastecimentos.length === 0) {
                showToast("Nenhum abastecimento encontrado para os filtros selecionados.", "info");
                setIsLoading(false);
                setDadosPorCidade([]);
                return;
            }

            // AGREGAÇÃO MODIFICADA
            const agregados = todosAbastecimentos.reduce((acc, abs) => {
                if (!abs.cidade || !abs.custo || !abs.volume) return acc;
                const cidade = abs.cidade.trim().toUpperCase();
                acc[cidade] = acc[cidade] || { custoTotal: 0, volumeTotal: 0, count: 0, placas: new Map() };
                acc[cidade].custoTotal += abs.custo;
                acc[cidade].volumeTotal += abs.volume;
                acc[cidade].count++;
                if (abs.placa) {
                    const currentCount = acc[cidade].placas.get(abs.placa) || 0;
                    acc[cidade].placas.set(abs.placa, currentCount + 1);
                }
                return acc;
            }, {});

            const resultado = Object.entries(agregados).map(([cidade, dados]) => ({
                cidade, ...dados, precoMedio: dados.custoTotal / dados.volumeTotal || 0
            }));

            setLoadingMessage('Verificando cache de coordenadas...');
            const cidadesParaBuscar = resultado.map(r => r.cidade);
            const { data: cidadesEmCache } = await supabase.from('cidades_coordenadas').select('*').in('cidade', cidadesParaBuscar);
            const cacheMap = new Map(cidadesEmCache.map(c => [c.cidade, { lat: c.lat, lon: c.lon }]));
            
            const cidadesSemCoordenadas = resultado.filter(r => !cacheMap.has(r.cidade));
            const novasCoordenadasParaSalvar = [];
            let comCoordenadas = resultado.map(item => cacheMap.has(item.cidade) ? { ...item, ...cacheMap.get(item.cidade) } : item);

            if (cidadesSemCoordenadas.length > 0) {
                let count = 0;
                for (const item of cidadesSemCoordenadas) {
                    count++;
                    setLoadingMessage(`Buscando coordenadas: ${count} de ${cidadesSemCoordenadas.length} cidades novas...`);
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(item.cidade)}&country=Brazil&format=json&limit=1`);
                        if (!response.ok) continue;
                        const geodata = await response.json();
                        if (geodata && geodata.length > 0) {
                            const coords = { lat: geodata[0].lat, lon: geodata[0].lon };
                            const index = comCoordenadas.findIndex(c => c.cidade === item.cidade);
                            if (index !== -1) {
                                comCoordenadas[index].lat = coords.lat;
                                comCoordenadas[index].lon = coords.lon;
                            }
                            novasCoordenadasParaSalvar.push({ cidade: item.cidade, ...coords });
                        }
                    } catch (e) { console.error("Erro de geocodificação para", item.cidade, e); }
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            if (novasCoordenadasParaSalvar.length > 0) {
                setLoadingMessage('Salvando novas coordenadas no cache...');
                await supabase.from('cidades_coordenadas').insert(novasCoordenadasParaSalvar).select();
            }
            
            setDadosPorCidade(comCoordenadas.filter(c => c.lat && c.lon));
        } catch (err) {
            showToast(err.message, "error");
        }
        setIsLoading(false);
    };

    React.useEffect(() => {
        if (mapRef.current && !mapInstance.current) {
            mapInstance.current = L.map(mapRef.current).setView([-14.235, -51.925], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance.current);
        }
    }, []);

    // USE EFFECT MODIFICADO
    React.useEffect(() => {
        if (mapInstance.current) {
            const map = mapInstance.current;
            map.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) map.removeLayer(layer);
            });

            if (dadosPorCidade && dadosPorCidade.length > 0) {
                dadosPorCidade.forEach(cidade => {
                    const getColor = (preco) => {
                        if (preco > 6.0) return '#EF4444';
                        if (preco > 5.5) return '#F59E0B';
                        return '#22C55E';
                    };
                    const circle = L.circleMarker([cidade.lat, cidade.lon], {
                        radius: 5 + Math.log(cidade.volumeTotal + 1),
                        fillColor: getColor(cidade.precoMedio),
                        color: '#000', weight: 1, opacity: 1, fillOpacity: 0.8
                    }).addTo(map);
                    
                    // LÓGICA DE AMOSTRAGEM CORRIGIDA
                    const placasOrdenadas = Array.from(cidade.placas.entries())
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .map(([placa, _]) =>
                            `<span onclick="window.viewPlacaProfile('${placa}')" class="text-blue-600 cursor-pointer hover:underline">${placa}</span>`
                        ).join(', ');
                    const totalPlacasUnicas = cidade.placas.size;

                    circle.bindPopup(`<b>${cidade.cidade}</b><br>Preço Médio: R$ ${cidade.precoMedio.toFixed(3)}<br>Volume Total: ${cidade.volumeTotal.toFixed(2)} L<br>Abastecimentos: ${cidade.count}<br>Placas: ${placasOrdenadas}${totalPlacasUnicas > 5 ? '...' : ''}`);
                });
            }
            
            setTimeout(() => map.invalidateSize(), 100);
        }
    }, [dadosPorCidade]);

    return React.createElement('div', { className: 'bg-white p-6 rounded-xl shadow-lg' },
        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-2 text-center" }, "Mapa de Custos por Cidade"),
        React.createElement('p', { className: 'text-center text-gray-500 mb-6' }, 'Visualize o preço médio (cor) e o volume total (tamanho) por cidade.'),
        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 border rounded-lg bg-gray-50 items-end' },
            React.createElement('div', { className: 'md:col-span-2' },
                React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Período de Análise'),
                React.createElement(DateRangePicker, { onDatesChange: setDateRange, placeholder: 'Selecione o período...' })
            ),
            React.createElement('div', null, 
                React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Plataformas'),
                React.createElement(PlataformaPicker, { selected: selectedPlataformas, onChange: setSelectedPlataformas })
            ),
            React.createElement('div', { className: 'md:col-span-3' },
                React.createElement('button', { onClick: fetchData, disabled: isLoading, className: 'w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400' },
                    isLoading ? 'Analisando...' : 'Analisar'
                )
            )
        ),
        React.createElement('div', { ref: mapRef, style: { height: '600px', width: '100%', borderRadius: '8px', zIndex: 0, position: 'relative' } },
            isLoading && React.createElement('div', { className: 'absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10' }, 
                React.createElement('div', { className: 'text-center' },
                    React.createElement('p', {className: 'font-semibold text-blue-600'}, loadingMessage),
                    React.createElement('div', { className: 'w-64 bg-gray-200 rounded-full h-2.5 mt-2'}, 
                        React.createElement('div', { className: 'bg-blue-600 h-2.5 rounded-full animate-pulse' })
                    )
                )
            ),
            !isLoading && (!dadosPorCidade || dadosPorCidade.length === 0) && React.createElement('div', { className: 'absolute inset-0 flex items-center justify-center z-10' },
                React.createElement('p', { className: 'text-gray-500' }, 'Selecione os filtros e clique em "Analisar" para carregar o mapa.')
            )
        )
    );
}
            function Dashboard({ user, showToast, setCurrentPage }) {
    const [stats, setStats] = React.useState({ Alta: 0, Média: 0, Baixa: 0, total: 0 });
    const [chartData, setChartData] = React.useState({ overTime: null, byType: null });
    const [isLoading, setIsLoading] = React.useState(true);
    const [dateRange, setDateRange] = React.useState([]); // ESTADO ADICIONADO

    const priorityColors = {
        'Alta': { border: 'border-red-500', rgb: '239, 68, 68' },
        'Média': { border: 'border-yellow-500', rgb: '234, 179, 8' },
        'Baixa': { border: 'border-blue-500', rgb: '59, 130, 246' },
        'Concluído': { border: 'border-green-500', rgb: '34, 197, 94' }
    };

    const ChartComponent = ({ chartId, type, data, options, onClick }) => {
        const canvasRef = React.useRef(null);
        React.useEffect(() => {
            if (!canvasRef.current || !data) return;
            const chart = new Chart(canvasRef.current, {
                type,
                data,
                options: {
                    ...options,
                    onClick: (event, elements) => {
                        if (onClick && elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const clickedLabel = chart.data.labels[elementIndex];
                            onClick(clickedLabel);
                        }
                    }
                }
            });
            return () => chart.destroy();
        }, [data, type, options]);
        return React.createElement('canvas', { ref: canvasRef, id: chartId });
    };

    // FUNÇÃO MODIFICADA
    const fetchData = async () => {
        setIsLoading(true);
        try {
            const queries = [
                supabase.from('alertas').select('alerta_prioridades(prioridade)').eq('status', 'pendente'),
                supabase.from('alertas').select('periodo, status').order('periodo', { ascending: true }),
                supabase.from('alertas').select('tipo_alerta').eq('status', 'pendente')
            ];

            if (dateRange && dateRange.length === 2) {
                const [inicio, fim] = dateRange;
                const fimAjustado = new Date(fim);
                fimAjustado.setHours(23, 59, 59);

                queries.forEach(query => {
                    query.gte('data_criacao', inicio.toISOString()).lte('data_criacao', fimAjustado.toISOString());
                });
            }
            
            queries.forEach(query => query.limit(10000));

            const [countsRes, overTimeRes, byTypeRes] = await Promise.all(queries);

            if (countsRes.error || overTimeRes.error || byTypeRes.error) throw new Error("Falha ao buscar dados para o dashboard.");

            const counts = countsRes.data.reduce((acc, alerta) => {
                const prioridade = alerta.alerta_prioridades?.prioridade || 'N/D';
                acc[prioridade] = (acc[prioridade] || 0) + 1;
                acc.total++;
                return acc;
            }, { Alta: 0, Média: 0, Baixa: 0, total: 0 });
            setStats(counts);

            const overTimeProcessed = overTimeRes.data.reduce((acc, { periodo, status }) => {
                if (!periodo) return acc;
                acc[periodo] = acc[periodo] || { pendente: 0, concluido: 0 };
                if (status === 'pendente') acc[periodo].pendente++;
                if (status === 'concluido') acc[periodo].concluido++;
                return acc;
            }, {});
            const overTimeLabels = Object.keys(overTimeProcessed);
            setChartData(prev => ({ ...prev, overTime: {
                labels: overTimeLabels,
                datasets: [
                    { label: 'Pendentes', data: overTimeLabels.map(p => overTimeProcessed[p].pendente), borderColor: `rgb(${priorityColors.Média.rgb})`, backgroundColor: `rgba(${priorityColors.Média.rgb}, 0.5)`, tension: 0.1, pointRadius: 5, pointHoverRadius: 7 },
                    { label: 'Concluídos', data: overTimeLabels.map(p => overTimeProcessed[p].concluido), borderColor: `rgb(${priorityColors.Concluído.rgb})`, backgroundColor: `rgba(${priorityColors.Concluído.rgb}, 0.5)`, tension: 0.1, pointRadius: 5, pointHoverRadius: 7 }
                ]
            }}));

            const byTypeProcessed = byTypeRes.data.reduce((acc, { tipo_alerta }) => {
                const tipoBase = tipo_alerta.startsWith('Combustível não mapeado') ? 'Combustível não mapeado' : tipo_alerta;
                acc[tipoBase] = (acc[tipoBase] || 0) + 1;
                return acc;
            }, {});
            const byTypeLabels = Object.keys(byTypeProcessed);
            setChartData(prev => ({ ...prev, byType: {
                labels: byTypeLabels,
                datasets: [{
                    label: 'Tipos de Alerta',
                    data: Object.values(byTypeProcessed),
                    backgroundColor: [ `rgb(${priorityColors.Média.rgb})`, `rgb(${priorityColors.Alta.rgb})`, `rgb(${priorityColors.Baixa.rgb})`, 'rgb(107, 114, 128)' ],
                    hoverOffset: 4
                }]
            }}));
        } catch (err) {
            console.error("Erro ao montar o dashboard:", err);
            showToast("Não foi possível carregar os dados do dashboard.", "error");
        }
        setIsLoading(false);
    };

    // USE EFFECT MODIFICADO
    React.useEffect(() => {
        fetchData();
    }, []);

    const handleChartClick = (clickedLabel) => {
        showToast(`Funcionalidade de filtro por clique em '${clickedLabel}' em desenvolvimento.`, "info");
    };

    const Card = ({ prioridade, cor, quantidade }) => (
        React.createElement('div', {
            className: `bg-white p-6 rounded-xl shadow-lg border-l-4 ${cor} cursor-pointer hover:shadow-xl transition-shadow`,
            onClick: () => setCurrentPage('alertas')
        },
            React.createElement('p', { className: 'text-sm font-medium text-gray-500' }, `Alertas de Prioridade ${prioridade}`),
            React.createElement('p', { className: 'text-4xl font-bold text-gray-800 mt-2' }, isLoading ? '...' : quantidade)
        )
    );

    const ChartContainer = ({ title, children }) => (
        React.createElement('div', { className: 'bg-white p-6 rounded-xl shadow-lg' },
            React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, title),
            React.createElement('div', { className: 'h-64' }, children)
        )
    );

    return React.createElement('div', null,
        React.createElement('h2', { className: "text-3xl font-bold text-gray-800 mb-2" }, `Olá, ${user.nome}!`),
        React.createElement('p', { className: "text-gray-600 mb-8" }, "Este é o resumo atual do seu sistema."),
        
        // FILTROS ADICIONADOS
        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 border rounded-lg bg-gray-50 items-end' },
            React.createElement('div', { className: 'md:col-span-2' },
                React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Filtrar por Período'),
                React.createElement(DateRangePicker, { onDatesChange: setDateRange, placeholder: 'Selecione um período para filtrar...' })
            ),
            React.createElement('button', {
                onClick: fetchData,
                disabled: isLoading,
                className: 'w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400'
            }, isLoading ? 'Filtrando...' : 'Filtrar')
        ),

        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8' },
            React.createElement(Card, { prioridade: 'Alta', cor: priorityColors.Alta.border, quantidade: stats.Alta }),
            React.createElement(Card, { prioridade: 'Média', cor: priorityColors.Média.border, quantidade: stats.Média }),
            React.createElement(Card, { prioridade: 'Baixa', cor: priorityColors.Baixa.border, quantidade: stats.Baixa }),
            React.createElement('div', {
                className: `bg-gray-800 text-white p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-shadow`,
                onClick: () => setCurrentPage('alertas')
            },
                React.createElement('p', { className: 'text-sm font-medium text-gray-300' }, `Total de Alertas Pendentes`),
                React.createElement('p', { className: 'text-4xl font-bold mt-2' }, isLoading ? '...' : stats.total)
            )
        ),
        React.createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-3 gap-6' },
            React.createElement('div', { className: 'lg:col-span-2' },
                React.createElement(ChartContainer, { title: 'Alertas Gerados vs. Concluídos por Período' },
                    isLoading || !chartData.overTime ? React.createElement('p', { className: 'text-center pt-10' }, 'Carregando...') :
                    React.createElement(ChartComponent, {
                        chartId: 'overTimeChart', type: 'line', data: chartData.overTime,
                        options: { maintainAspectRatio: false, responsive: true }
                    })
                )
            ),
            React.createElement(ChartContainer, { title: 'Tipos de Alertas Pendentes' },
                isLoading || !chartData.byType ? React.createElement('p', { className: 'text-center pt-10' }, 'Carregando...') :
                React.createElement(ChartComponent, {
                    chartId: 'byTypeChart', type: 'doughnut', data: chartData.byType,
                    options: {
                        maintainAspectRatio: false, responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        const value = context.parsed;
                                        const sum = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = sum > 0 ? ((value / sum) * 100).toFixed(1) + '%' : '0%';
                                        return `${label}${value} (${percentage})`;
                                    }
                                }
                            }
                        }
                    },
                    onClick: handleChartClick
                })
            )
        )
    );
}
function ShellAbastecimentos({ user, showToast }) {
                const [abastecimentos, setAbastecimentos] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(false);
                const [file, setFile] = React.useState(null);
                const [isImporting, setIsImporting] = React.useState(false);
                const [filters, setFilters] = React.useState({ placa: '', data_inicio: null, data_fim: null, cnpj: '' });
                const [hasSearched, setHasSearched] = React.useState(false);
                const [combustivelMap, setCombustivelMap] = React.useState(new Map());

                // NOVO ESTADO PARA CONTROLE DE PROGRESSO
                const [progress, setProgress] = React.useState(null);

                React.useEffect(() => {
                    const fetchMapping = async () => {
                        const { data, error } = await supabase.from('combustivel_mapeamento').select('nome_original, nome_padronizado');
                        if (error) {
                            showToast("Aviso: Não foi possível carregar as regras de mapeamento de combustível.", "error");
                        } else {
                            const map = new Map(data.map(rule => [rule.nome_original, rule.nome_padronizado]));
                            setCombustivelMap(map);
                        }
                    };
                    fetchMapping();
                }, [showToast]);

                const formatDate = (dateString) => {
                    if (!dateString) return '—';
                    return new Date(dateString).toLocaleString('pt-BR');
                };
                const handleFilterChange = (e) => {
                    setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
                };
                const handleSearch = async () => {
                    setHasSearched(true);
                    setIsLoading(true);
                    try {
                        let query = supabase.from('shell_abastecimentos').select('*');
                        if (filters.placa) query = query.ilike('placa', `%${filters.placa.trim()}%`);
                        if (filters.cnpj) query = query.ilike('cnpj', `%${filters.cnpj.trim()}%`);
                        if (filters.data_inicio) {
                            query = query.gte('data_hora_transacao', filters.data_inicio.toISOString());
                        }
                        if (filters.data_fim) {
                            const endDate = new Date(filters.data_fim);
                            endDate.setHours(23, 59, 59, 999);
                            query = query.lte('data_hora_transacao', endDate.toISOString());
                        }
                        query = query.order('data_hora_transacao', { ascending: false });
                        const { data, error } = await query;
                        if (error) throw error;
                        setAbastecimentos(data || []);
                    } catch (err) {
                        showToast("Erro ao buscar abastecimentos.", "error");
                    }
                    setIsLoading(false);
                };
                const handleFileChange = (e) => {
                    if (e.target.files && e.target.files[0]) {
                        setFile(e.target.files[0]);
                    }
                };
                const handleImport = () => {
                    if (!file) { return showToast("Por favor, selecione um arquivo.", "error"); }
                    setIsImporting(true);
                    setProgress({ percentage: 0, message: 'Iniciando importação...' });
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            setProgress({ percentage: 25, message: 'Lendo e processando a planilha...' });
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet);
                            const dataToInsert = json
                                .filter(row => row['Status'] && row['Status'].toLowerCase() === 'sucesso')
                                .filter(row => row['CNPJ'] !== "07015016000117")
                                .map(row => {
                                    const transacaoDate = row['Data/Hora transação'];
                                    let finalDate = null;
                                    if (transacaoDate) {
                                        const d = new Date(transacaoDate);
                                        if (!isNaN(d.getTime())) { finalDate = d.toISOString(); }
                                    }
                                    return {
                                        cnpj: row['CNPJ'],
                                        status: row['Status'],
                                        data_hora_transacao: finalDate,
                                        cidade: row['Cidade do posto'],
                                        estado: row['Estado do posto'],
                                        placa: row['Placa'],
                                        combustivel: row['Combustível'],
                                        litros: parseFloat(row['Litros']) || 0,
                                        total_abastecimento: parseFloat(row['Total do Abastecimento']) || 0,
                                        rs_litro: parseFloat(row['R$/Litro']) || 0,
                                        nome_condutor: row['Nome do condutor'],
                                        nome_posto: row['Nome do posto'],
                                        usuario_criacao: user.nome,
                                        data_criacao: new Date().toISOString(),
                                    };
                                });
                            
                            if (dataToInsert.length === 0) {
                                throw new Error("Nenhum registro válido encontrado na planilha.");
                            }
                            
                            setProgress({ percentage: 50, message: 'Salvando dados no banco de dados...' });
                            const { error } = await supabase.from('shell_abastecimentos').insert(dataToInsert, { returning: 'minimal' });
                            if (error) throw error;
                            
                            setProgress({ percentage: 75, message: 'Verificando e gerando alertas...' });
                            const dadosParaAlerta = dataToInsert.map(item => ({ placa: item.placa, data: item.data_hora_transacao, combustivelOriginal: item.combustivel }));
                            await gerarAlertasEmLote(dadosParaAlerta, 'shell', combustivelMap);
                            
                            setProgress({ percentage: 100, message: 'Importação concluída com sucesso!' });
                            showToast(`${dataToInsert.length} registros importados!`);

                            setTimeout(() => {
                                setFile(null); 
                                document.getElementById('file-input-shell').value = '';
                                setHasSearched(false);
                                setAbastecimentos([]);
                                setProgress(null);
                                setIsImporting(false);
                            }, 2000);

                        } catch (err) {
                            showToast(`Erro: ${err.message}`, "error");
                            setProgress(null);
                            setIsImporting(false);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };

                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Importação Shell"),
                    React.createElement('div', { className: "mb-8 p-4 border rounded-lg bg-gray-100 grid grid-cols-1 md:grid-cols-2 gap-4 items-center" },
                        React.createElement('div', null,
                            React.createElement('label', { htmlFor: 'file-input-shell', className: "block text-sm font-medium text-gray-700 mb-1" }, "Importar Planilha Shell"),
                            React.createElement('input', { id: 'file-input-shell', type: "file", onChange: handleFileChange, className: "w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100", accept: ".xlsx, .xls, .csv" })
                        ),
                        // LÓGICA DE EXIBIÇÃO DO PROGRESSO
                        isImporting && progress ?
                            React.createElement('div', { className: 'w-full' },
                                React.createElement('p', { className: 'text-sm text-center text-gray-600 mb-1' }, `${progress.message}`),
                                React.createElement('div', { className: 'w-full bg-gray-200 rounded-full h-4' },
                                    React.createElement('div', {
                                        className: 'bg-blue-600 h-4 rounded-full text-center text-white text-xs leading-4',
                                        style: { width: `${progress.percentage}%` }
                                    }, `${progress.percentage}%`)
                                )
                            ) :
                            React.createElement('button', { onClick: handleImport, disabled: isImporting || !file, className: "w-full p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition" }, 'Importar Dados')
                    ),
                    // O resto do JSX continua o mesmo...
                    React.createElement('div', { className: "mb-6 p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end" },
                        React.createElement('div', { className: "lg:col-span-2" },
                            React.createElement(DateRangePicker, { onDatesChange: (dates) => { setFilters(prev => ({...prev, data_inicio: dates[0] || null, data_fim: dates[1] || null })); } })
                        ),
                        React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "Placa"), React.createElement('input', { type: "text", name: "placa", value: filters.placa, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
                        React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "CNPJ"), React.createElement('input', { type: "text", name: "cnpj", value: filters.cnpj, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
                        React.createElement('button', { onClick: handleSearch, disabled: isLoading, className: "w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition lg:col-start-4" }, 'Buscar')
                    ),
                    React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
                        React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                            React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                                React.createElement('tr', null,
                                    ["Data", "Placa", "Posto", "Litros", "Valor Total"].map(h => React.createElement('th', { key: h, className: "px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0" }, h))
                                )
                            ),
                            React.createElement('tbody', null,
                                isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-4 text-center" }, "Carregando...")) :
                                !hasSearched ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-6 text-center text-slate-500" }, "Utilize os filtros para buscar os abastecimentos.")) :
                                abastecimentos.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-6 text-center text-slate-500" }, "Nenhum resultado encontrado.")) :
                                abastecimentos.map(item => React.createElement('tr', { key: item.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, formatDate(item.data_hora_transacao)),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, React.createElement('span', { className: 'font-medium text-slate-800' }, item.placa)),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.nome_posto),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.litros.toFixed(2)),
                                    React.createElement('td', { className: "px-6 py-4" }, `R$ ${(item.total_abastecimento || 0).toFixed(2).replace('.', ',')}`)
                                ))
                            )
                        )
                    )
                );
            }
            function CtaCarregamentos({ user, showToast }) {
                const [carregamentos, setCarregamentos] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(false);
                const [showForm, setShowForm] = React.useState(false);
                const initialFormState = { cod_posto: '', volume: '', custo: '', preco_por_litro: '', nota_fiscal: '', fornecedor: '', entrega: '' };
                const [formData, setFormData] = React.useState(initialFormState);
                const [file, setFile] = React.useState(null);
                const [isImporting, setIsImporting] = React.useState(false);
                const [filters, setFilters] = React.useState({ searchTerm: '', data_inicio: null, data_fim: null });
                
                const [progress, setProgress] = React.useState(null);

                const formatDate = (dateString) => {
                    if (!dateString) return '—';
                    if (typeof dateString === 'number' && dateString > 1) {
                        const date = new Date(Math.round((dateString - 25569) * 86400 * 1000));
                        return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                    }
                    const date = new Date(dateString.includes('T') ? dateString : dateString + 'T00:00:00');
                    return date.toLocaleDateString('pt-BR');
                };
                const handleInputChange = (e) => { setFormData(prev => ({ ...prev, [e.target.name]: e.target.value })); };
                const handleFilterChange = (e) => { setFilters(prev => ({ ...prev, [e.target.name]: e.target.value })); };
                const handleFileChange = (e) => { if (e.target.files && e.target.files[0]) { setFile(e.target.files[0]); } };
                const handleFormSubmit = async (e) => {
                    e.preventDefault();
                    setIsLoading(true);
                    try {
                        const recordToInsert = {
                            ...formData,
                            custo: parseFloat(formData.custo),
                            volume: parseFloat(formData.volume),
                            preco_por_litro: parseFloat(formData.preco_por_litro),
                            usuario_criacao: user.nome,
                            data_criacao: new Date().toISOString(),
                        };
                        const { error } = await supabase.from('cta_carregamentos').insert([recordToInsert]);
                        if (error) throw error;
                        showToast("Carregamento registrado com sucesso!", "success");
                        setFormData(initialFormState);
                        setShowForm(false);
                    } catch (err) {
                        showToast(`Erro ao registrar carregamento: ${err.message}`, "error");
                    }
                    setIsLoading(false);
                };
                const handleImport = () => {
                    if (!file) { return showToast("Por favor, selecione um arquivo.", "error"); }
                    setIsImporting(true);
                    setProgress({ percentage: 0, message: 'Iniciando importação...' });
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            setProgress({ percentage: 33, message: 'Lendo e processando a planilha...' });
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet);
                            const dataToInsert = json.map(row => {
                                let deliveryDate = null;
                                const excelDate = row['Entrega'];
                                if (excelDate) {
                                    if (excelDate instanceof Date) { deliveryDate = excelDate.toISOString().split('T')[0]; }
                                    else if (typeof excelDate === 'string' && excelDate.includes('/')) {
                                        const parts = excelDate.split('/');
                                        if (parts.length === 3) { deliveryDate = `${parts[2]}-${parts[1]}-${parts[0]}`; }
                                    }
                                }
                                return {
                                    cod_posto: row['Cod. do Posto'],
                                    volume: parseFloat(row['Volume (l)']) || 0,
                                    custo: parseFloat(row['Custo (R$)']) || 0,
                                    preco_por_litro: parseFloat(row['Preço por Litro/M³']) || 0,
                                    nota_fiscal: row['Nº Nota Fiscal'],
                                    fornecedor: row['Fornecedor'],
                                    entrega: deliveryDate,
                                    usuario_criacao: user.nome,
                                    data_criacao: new Date().toISOString(),
                                };
                            });
                            if (dataToInsert.length === 0) { throw new Error("Nenhum dado válido encontrado."); }
                            
                            setProgress({ percentage: 66, message: 'Salvando dados no banco de dados...' });
                            const { error } = await supabase.from('cta_carregamentos').insert(dataToInsert);
                            if (error) throw error;

                            setProgress({ percentage: 100, message: 'Concluído!' });
                            showToast(`${dataToInsert.length} registros importados com sucesso!`, "success");

                            setTimeout(() => {
                                setFile(null);
                                document.getElementById('file-input-cta-carreg').value = '';
                                setCarregamentos([]);
                                setProgress(null);
                                setIsImporting(false);
                            }, 2000);
                        } catch (err) {
                            showToast(`Erro ao processar o arquivo: ${err.message}`, "error");
                            setProgress(null);
                            setIsImporting(false);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };
                const handleSearch = async () => {
                    setIsLoading(true);
                    try {
                        let query = supabase.from('cta_carregamentos').select('*');
                        if (filters.searchTerm) { query = query.or(`nota_fiscal.ilike.%${filters.searchTerm.trim()}%,fornecedor.ilike.%${filters.searchTerm.trim()}%`); }
                        if (filters.data_inicio) {
                            query = query.gte('entrega', filters.data_inicio.toISOString());
                        }
                        if (filters.data_fim) {
                            const endDate = new Date(filters.data_fim);
                            endDate.setHours(23, 59, 59, 999);
                            query = query.lte('entrega', endDate.toISOString());
                        }
                        query = query.order('entrega', { ascending: false });
                        const { data, error } = await query;
                        if (error) throw error;
                        setCarregamentos(data || []);
                    } catch (err) {
                        showToast("Erro ao buscar carregamentos.", "error");
                    }
                    setIsLoading(false);
                };
                React.useEffect(() => {
                    const fetchInitialData = async () => {
                        setIsLoading(true);
                        try {
                            const { data, error } = await supabase.from('cta_carregamentos').select('*').order('entrega', { ascending: false }).limit(100);
                            if (error) throw error;
                            setCarregamentos(data || []);
                        } catch (err) {
                            showToast("Erro ao carregar dados iniciais.", "error");
                        }
                        setIsLoading(false);
                    };
                    fetchInitialData();
                }, [showToast]);
                
                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Carregamentos"),
                    React.createElement('div', { className: "flex justify-end mb-4" },
                        React.createElement('button', { onClick: () => setShowForm(!showForm), className: "p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center" }, React.createElement(LucideIcon, { name: 'PlusCircle', className: 'mr-2 h-5 w-5' }), showForm ? "Fechar Formulário" : "Novo Carregamento")
                    ),
                    showForm && React.createElement('form', { onSubmit: handleFormSubmit, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 p-4 border rounded-lg bg-gray-50" },
                        React.createElement('input', { name: "cod_posto", value: formData.cod_posto, onChange: handleInputChange, placeholder: "Cód. Posto", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "volume", type: "number", step: "0.01", value: formData.volume, onChange: handleInputChange, placeholder: "Volume", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "custo", type: "number", step: "0.01", value: formData.custo, onChange: handleInputChange, placeholder: "Custo Total", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "preco_por_litro", type: "number", step: "0.001", value: formData.preco_por_litro, onChange: handleInputChange, placeholder: "Preço p/ Litro", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "nota_fiscal", value: formData.nota_fiscal, onChange: handleInputChange, placeholder: "Nota Fiscal", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "fornecedor", value: formData.fornecedor, onChange: handleInputChange, placeholder: "Fornecedor", className: "p-2 border rounded" }),
                        React.createElement('div', null, React.createElement('label', { htmlFor: 'entrega', className: 'text-xs text-gray-500' }, 'Data da Entrega'), React.createElement('input', { name: "entrega", id: 'entrega', type: "date", value: formData.entrega, onChange: handleInputChange, className: "w-full p-2 border rounded" })),
                        React.createElement('div', { className: "lg:col-span-4 flex justify-end gap-4" },
                            React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "py-2 px-4 bg-gray-300 rounded-lg" }, "Cancelar"),
                            React.createElement('button', { type: "submit", className: "py-2 px-4 bg-blue-600 text-white rounded-lg", disabled: isLoading }, isLoading ? 'Salvando...' : 'Salvar')
                        )
                    ),
                    React.createElement('div', { className: "mb-8 p-4 border rounded-lg bg-gray-100 grid grid-cols-1 md:grid-cols-2 gap-4 items-center" },
                        React.createElement('div', null,
                            React.createElement('label', { htmlFor: 'file-input-cta-carreg', className: "block text-sm font-medium text-gray-700 mb-1" }, "Importar Planilha (.xlsx, .xls, .csv)"),
                            React.createElement('input', { id: 'file-input-cta-carreg', type: "file", onChange: handleFileChange, className: "w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100", accept: ".xlsx, .xls, .csv" })
                        ),
                        isImporting && progress ?
                            React.createElement('div', { className: 'w-full' },
                                React.createElement('p', { className: 'text-sm text-center text-gray-600 mb-1' }, `${progress.message}`),
                                React.createElement('div', { className: 'w-full bg-gray-200 rounded-full h-4' },
                                    React.createElement('div', {
                                        className: 'bg-blue-600 h-4 rounded-full text-center text-white text-xs leading-4',
                                        style: { width: `${progress.percentage}%` }
                                    }, `${progress.percentage}%`)
                                )
                            ) :
                            React.createElement('button', { onClick: handleImport, disabled: isImporting || !file, className: "w-full p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition" }, 'Importar Dados')
                    ),
                    React.createElement('div', { className: "mb-6 p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-3 gap-4 items-end" },
                        React.createElement('div', { className: 'md:col-span-2' },
                            React.createElement(DateRangePicker, {
                                onDatesChange: (dates) => {
                                    setFilters(prev => ({ ...prev, data_inicio: dates[0] || null, data_fim: dates[1] || null }));
                                }
                            })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium" }, "Nota Fiscal ou Fornecedor"),
                            React.createElement('input', { type: "text", name: "searchTerm", value: filters.searchTerm, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })
                        ),
                        React.createElement('button', { onClick: handleSearch, disabled: isLoading, className: "w-full p-2 bg-blue-600 text-white rounded-lg md:col-start-3" }, 'Buscar')
                    ),
                    React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
                        React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                            React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                                React.createElement('tr', null,
                                    ["Cód. Posto", "Volume (L)", "Custo Total", "Preço p/ Litro", "Nota Fiscal", "Fornecedor", "Data Entrega"].map(h => React.createElement('th', { key: h, className: "px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0" }, h))
                                )
                            ),
                            React.createElement('tbody', null,
                                isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-4 text-center" }, "Carregando...")) :
                                carregamentos.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-6 text-center text-slate-500" }, "Nenhum carregamento encontrado.")) :
                                carregamentos.map(c => React.createElement('tr', { key: c.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, c.cod_posto),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, c.volume),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, `R$ ${(c.custo || 0).toFixed(2).replace('.', ',')}`),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, `R$ ${(c.preco_por_litro || 0).toFixed(3).replace('.', ',')}`),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, React.createElement('span', { className: 'font-medium text-slate-800' }, c.nota_fiscal)),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, c.fornecedor),
                                    React.createElement('td', { className: "px-6 py-4" }, formatDate(c.entrega))
                                ))
                            )
                        )
                    )
                );
            }
            function CtaAbastecimentos({ user, showToast }) {
                const [abastecimentos, setAbastecimentos] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(false);
                const [showForm, setShowForm] = React.useState(false);
                const initialFormState = { data_hora_inicio: '', placa: '', volume: '', custo_total: '', cod_posto: '', cod_frentista: '' };
                const [formData, setFormData] = React.useState(initialFormState);
                const [file, setFile] = React.useState(null);
                const [isImporting, setIsImporting] = React.useState(false);
                const [filters, setFilters] = React.useState({ placa: '', data_inicio: null, data_fim: null, cod_posto: '' });
                const [hasSearched, setHasSearched] = React.useState(false);

                const [progress, setProgress] = React.useState(null);

                const formatDate = (dateString) => {
                    if (!dateString) return '—';
                    return new Date(dateString).toLocaleString('pt-BR');
                };
                const handleFilterChange = (e) => {
                    setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
                };
                const handleSearch = async () => {
                    setHasSearched(true);
                    setIsLoading(true);
                    try {
                        let query = supabase.from('cta_abastecimentos').select('*');
                        if (filters.placa) query = query.ilike('placa', `%${filters.placa.trim()}%`);
                        if (filters.cod_posto) query = query.eq('cod_posto', filters.cod_posto.trim());
                        if (filters.data_inicio) {
                            query = query.gte('data_hora_inicio', filters.data_inicio.toISOString());
                        }
                        if (filters.data_fim) {
                            const endDate = new Date(filters.data_fim);
                            endDate.setHours(23, 59, 59, 999);
                            query = query.lte('data_hora_inicio', endDate.toISOString());
                        }
                        query = query.order('data_hora_inicio', { ascending: false });
                        const { data, error } = await query;
                        if (error) throw error;
                        setAbastecimentos(data || []);
                    } catch (err) {
                        showToast("Erro ao buscar abastecimentos.", "error");
                    }
                    setIsLoading(false);
                };
                const handleInputChange = (e) => { setFormData(prev => ({ ...prev, [e.target.name]: e.target.value })); };
                const handleFileChange = (e) => { if (e.target.files && e.target.files[0]) { setFile(e.target.files[0]); }};
                const handleFormSubmit = async (e) => {
                    e.preventDefault();
                    setIsLoading(true);
                    try {
                        const recordToInsert = {
                            ...formData,
                            custo_total: parseFloat(formData.custo_total),
                            volume: parseFloat(formData.volume),
                            usuario_criacao: user.nome,
                            data_criacao: new Date().toISOString(),
                        };
                        const { error } = await supabase.from('cta_abastecimentos').insert([recordToInsert]);
                        if (error) throw error;
                        showToast("Abastecimento registrado com sucesso!", "success");
                        setFormData(initialFormState);
                        setShowForm(false);
                        setHasSearched(false);
                        setAbastecimentos([]);
                    } catch (err) {
                        showToast(`Erro ao registrar: ${err.message}`, "error");
                    }
                    setIsLoading(false);
                };
                const handleImport = () => {
                    if (!file) { return showToast("Por favor, selecione um arquivo.", "error"); }
                    setIsImporting(true);
                    setProgress({ percentage: 0, message: 'Iniciando importação...' });
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            setProgress({ percentage: 33, message: 'Lendo e processando a planilha...' });
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet);
                            const dataToInsert = json.slice(0, -1).map(row => {
                                const excelDate = row['Data/Hora início'];
                                let finalDate = null;
                                if (excelDate) {
                                    let d;
                                    if (excelDate instanceof Date) { d = excelDate; }
                                    else if (typeof excelDate === 'number' && excelDate > 1) { d = new Date(Math.round((excelDate - 25569) * 86400 * 1000)); }
                                    else if (typeof excelDate === 'string') {
                                        const parts = excelDate.match(/(\d+)/g);
                                        if (parts && parts.length >= 5) { d = new Date(parts[2], parts[1] - 1, parts[0], parts[3], parts[4], parts[5] || 0); }
                                    }
                                    if (d && !isNaN(d.getTime())) { finalDate = d.toISOString(); }
                                }
                                return {
                                    data_hora_inicio: finalDate,
                                    placa: row['Placa'],
                                    volume: parseFloat(row['Volume (l)']) || 0,
                                    custo_total: parseFloat(row['Custo Total (R$)']) || 0,
                                    cod_posto: row['Cod. do Posto'],
                                    cod_frentista: row['Cod. do Frentista'],
                                    usuario_criacao: user.nome,
                                    data_criacao: new Date().toISOString(),
                                };
                            });
                            if (dataToInsert.length === 0) {
                                throw new Error("Nenhum dado válido encontrado.");
                            }
                            
                            setProgress({ percentage: 66, message: 'Salvando dados no banco de dados...' });
                            const { error } = await supabase.from('cta_abastecimentos').insert(dataToInsert, { returning: 'minimal' });
                            if (error) throw error;

                            setProgress({ percentage: 100, message: 'Concluído!' });
                            showToast(`${dataToInsert.length} registros importados com sucesso!`, "success");

                            setTimeout(() => {
                                setFile(null); 
                                document.getElementById('file-input-cta-abs').value = '';
                                setHasSearched(false);
                                setAbastecimentos([]);
                                setProgress(null);
                                setIsImporting(false);
                            }, 2000);
                        } catch (err) {
                            showToast(`Erro ao processar o arquivo: ${err.message}`, "error");
                            setProgress(null);
                            setIsImporting(false);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };
                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-800" }, "Abastecimentos"),
                        React.createElement('button', { onClick: () => setShowForm(!showForm), className: "p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center" }, 
                            React.createElement(LucideIcon, { name: 'PlusCircle', className: 'mr-2 h-5 w-5' }),
                            showForm ? "Fechar Formulário" : "Novo Abastecimento"
                        )
                    ),
                    showForm && React.createElement('form', { onSubmit: handleFormSubmit, className: "grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-4 border rounded-lg bg-gray-50" },
                        React.createElement('input', { name: "placa", value: formData.placa, onChange: handleInputChange, placeholder: "Placa", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "cod_posto", value: formData.cod_posto, onChange: handleInputChange, placeholder: "Cód. Posto", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "cod_frentista", value: formData.cod_frentista, onChange: handleInputChange, placeholder: "Cód. Frentista", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "volume", type: "number", step: "0.01", value: formData.volume, onChange: handleInputChange, placeholder: "Volume (l)", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "custo_total", type: "number", step: "0.01", value: formData.custo_total, onChange: handleInputChange, placeholder: "Custo Total (R$)", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "data_hora_inicio", type: "datetime-local", value: formData.data_hora_inicio, onChange: handleInputChange, className: "p-2 border rounded" }),
                        React.createElement('div', { className: "md:col-span-3 flex justify-end gap-4" },
                            React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "py-2 px-4 bg-gray-300 rounded-lg" }, "Cancelar"),
                            React.createElement('button', { type: "submit", className: "py-2 px-4 bg-blue-600 text-white rounded-lg", disabled: isLoading }, isLoading ? 'Salvando...' : 'Salvar')
                        )
                    ),
                    React.createElement('div', { className: "mb-8 p-4 border rounded-lg bg-gray-100 grid grid-cols-1 md:grid-cols-2 gap-4 items-center" },
                        React.createElement('div', null,
                            React.createElement('label', { htmlFor: 'file-input-cta-abs', className: "block text-sm font-medium text-gray-700 mb-1" }, "Importar Planilha"),
                            React.createElement('input', { id: 'file-input-cta-abs', type: "file", onChange: handleFileChange, className: "w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100", accept: ".xlsx, .xls, .csv" })
                        ),
                        isImporting && progress ?
                            React.createElement('div', { className: 'w-full' },
                                React.createElement('p', { className: 'text-sm text-center text-gray-600 mb-1' }, `${progress.message}`),
                                React.createElement('div', { className: 'w-full bg-gray-200 rounded-full h-4' },
                                    React.createElement('div', {
                                        className: 'bg-blue-600 h-4 rounded-full text-center text-white text-xs leading-4',
                                        style: { width: `${progress.percentage}%` }
                                    }, `${progress.percentage}%`)
                                )
                            ) :
                            React.createElement('button', { onClick: handleImport, disabled: isImporting || !file, className: "w-full p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition" }, 'Importar Dados')
                    ),
                    React.createElement('div', { className: "mb-6 p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end" },
                        React.createElement('div', { className: "lg:col-span-2" },
                            React.createElement(DateRangePicker, {
                                onDatesChange: (dates) => {
                                    setFilters(prev => ({ ...prev, data_inicio: dates[0] || null, data_fim: dates[1] || null }));
                                }
                            })
                        ),
                        React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "Placa"), React.createElement('input', { type: "text", name: "placa", value: filters.placa, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
                        React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "Cód. do Posto"), React.createElement('input', { type: "text", name: "cod_posto", value: filters.cod_posto, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
                        React.createElement('button', { onClick: handleSearch, disabled: isLoading, className: "w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition lg:col-start-4" }, 'Buscar')
                    ),
                    React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
                        React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                            React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                                React.createElement('tr', null,
                                    ["Data/Hora", "Placa", "Volume (l)", "Custo Total", "Cód. Posto"].map(h => React.createElement('th', { key: h, className: "px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0" }, h))
                                )
                            ),
                            React.createElement('tbody', null,
                                isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-4 text-center" }, "Carregando...")) :
                                !hasSearched ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-6 text-center text-slate-500" }, "Utilize os filtros para buscar os abastecimentos.")) :
                                abastecimentos.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-6 text-center text-slate-500" }, "Nenhum resultado encontrado.")) :
                                abastecimentos.map(item => React.createElement('tr', { key: item.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, formatDate(item.data_hora_inicio)),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, React.createElement('span', { className: 'font-medium text-slate-800' }, item.placa)),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.volume),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, `R$ ${(item.custo_total || 0).toFixed(2).replace('.', ',')}`),
                                    React.createElement('td', { className: "px-6 py-4" }, item.cod_posto)
                                ))
                            )
                        )
                    )
                );
            }

            function TicketAbastecimentos({ user, showToast }) {
                const [abastecimentos, setAbastecimentos] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(false);
                const [file, setFile] = React.useState(null);
                const [isImporting, setIsImporting] = React.useState(false);
                const [filters, setFilters] = React.useState({ placa: '', data_inicio: null, data_fim: null, cidade: '', nome_estabelecimento: '' });
                const [hasSearched, setHasSearched] = React.useState(false);
                const [combustivelMap, setCombustivelMap] = React.useState(new Map());
                
                // NOVO ESTADO PARA CONTROLE DE PROGRESSO
                const [progress, setProgress] = React.useState(null);

                React.useEffect(() => {
                    const fetchMapping = async () => {
                        const { data, error } = await supabase.from('combustivel_mapeamento').select('nome_original, nome_padronizado');
                        if (error) {
                            showToast("Aviso: Não foi possível carregar as regras de mapeamento de combustível.", "error");
                        } else {
                            const map = new Map(data.map(rule => [rule.nome_original, rule.nome_padronizado]));
                            setCombustivelMap(map);
                        }
                    };
                    fetchMapping();
                }, [showToast]);

                const formatDate = (dateString) => {
                    if (!dateString) return '—';
                    return new Date(dateString).toLocaleString('pt-BR');
                };
                const handleFilterChange = (e) => {
                    setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
                };
                const handleSearch = async () => {
                    setHasSearched(true);
                    setIsLoading(true);
                    try {
                        let query = supabase.from('ticket_abastecimentos').select('*');
                        if (filters.placa) query = query.ilike('placa', `%${filters.placa.trim()}%`);
                        if (filters.cidade) query = query.ilike('cidade', `%${filters.cidade.trim()}%`);
                        if (filters.nome_estabelecimento) query = query.ilike('nome_estabelecimento', `%${filters.nome_estabelecimento.trim()}%`);
                        if (filters.data_inicio) {
                            query = query.gte('data_transacao', filters.data_inicio.toISOString());
                        }
                        if (filters.data_fim) {
                            const endDate = new Date(filters.data_fim);
                            endDate.setHours(23, 59, 59, 999);
                            query = query.lte('data_transacao', endDate.toISOString());
                        }
                        query = query.order('data_transacao', { ascending: false });
                        const { data, error } = await query;
                        if (error) throw error;
                        setAbastecimentos(data || []);
                    } catch (err) {
                        showToast("Erro ao buscar abastecimentos.", "error");
                    }
                    setIsLoading(false);
                };
                const handleFileChange = (e) => {
                    if (e.target.files && e.target.files[0]) {
                        setFile(e.target.files[0]);
                    }
                };

                const handleImport = () => {
                    if (!file) { return showToast("Por favor, selecione um arquivo.", "error"); }
                    setIsImporting(true);
                    setProgress({ percentage: 0, message: 'Iniciando importação...' });
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            setProgress({ percentage: 25, message: 'Lendo e processando a planilha...' });
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet);
                            
                            const dataToProcess = json.slice(0, -1).map(row => ({
                                raw: row,
                                combustivelOriginal: row['TIPO COMBUSTIVEL']
                            }));

                            const dataToInsert = dataToProcess.map(({ raw: row, combustivelOriginal }) => {
                                const transacaoDate = row['DATA TRANSACAO'];
                                let finalDate = null;
                                if (transacaoDate) {
                                    const d = new Date(transacaoDate);
                                    if (!isNaN(d.getTime())) {
                                        const year = d.getFullYear();
                                        const month = String(d.getMonth() + 1).padStart(2, '0');
                                        const day = String(d.getDate()).padStart(2, '0');
                                        const hours = String(d.getHours()).padStart(2, '0');
                                        const minutes = String(d.getMinutes()).padStart(2, '0');
                                        const seconds = String(d.getSeconds()).padStart(2, '0');
                                        finalDate = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
                                    }
                                }
                                const padronizadoCombustivel = combustivelMap.get(combustivelOriginal) || combustivelOriginal;
                                return {
                                    codigo_transacao: row['CODIGO TRANSACAO'],
                                    servico: row['SERVICO'],
                                    data_transacao: finalDate,
                                    placa: row['PLACA'],
                                    tipo_combustivel: padronizadoCombustivel,
                                    litros: parseFloat(row['LITROS']) || 0,
                                    vl_litro: parseFloat(row['VL/LITRO']) || 0,
                                    valor_emissao: parseFloat(row['VALOR EMISSAO']) || 0,
                                    nome_estabelecimento: row['NOME ESTABELECIMENTO'],
                                    cidade: row['CIDADE'],
                                    uf: row['UF'],
                                    info_adicional1: row['INFORMACAO ADICIONAL 1'],
                                    numero_cartao: row['NUMERO CARTAO'],
                                    usuario_criacao: user.nome,
                                    data_criacao: new Date().toISOString(),
                                };
                            });

                            if (dataToInsert.length === 0) {
                                throw new Error("Nenhum dado válido encontrado na planilha.");
                            }
                            
                            setProgress({ percentage: 50, message: 'Salvando dados no banco de dados...' });
                            const { error } = await supabase.from('ticket_abastecimentos').insert(dataToInsert, { returning: 'minimal' });
                            if (error) throw error;

                            setProgress({ percentage: 75, message: 'Verificando e gerando alertas...' });
                            const dadosParaAlerta = dataToInsert.map((item, index) => ({ 
                                placa: item.placa, 
                                data: item.data_transacao, 
                                combustivelOriginal: dataToProcess[index].combustivelOriginal 
                            }));
                            await gerarAlertasEmLote(dadosParaAlerta, 'ticket', combustivelMap);

                            setProgress({ percentage: 100, message: 'Importação concluída com sucesso!' });
                            showToast(`${dataToInsert.length} registros importados!`);
                            
                            setTimeout(() => {
                                setFile(null); 
                                document.getElementById('file-input-ticket').value = '';
                                setHasSearched(false);
                                setAbastecimentos([]);
                                setProgress(null);
                                setIsImporting(false);
                            }, 2000);

                        } catch (err) {
                            showToast(`Erro: ${err.message}`, "error");
                            setProgress(null);
                            setIsImporting(false);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };

                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Ticket Abastecimentos"),
                    React.createElement('div', { className: "mb-8 p-4 border rounded-lg bg-gray-100 grid grid-cols-1 md:grid-cols-2 gap-4 items-center" },
                        React.createElement('div', null,
                            React.createElement('label', { htmlFor: 'file-input-ticket', className: "block text-sm font-medium text-gray-700 mb-1" }, "Importar Planilha de Transações"),
                            React.createElement('input', { id: 'file-input-ticket', type: "file", onChange: handleFileChange, className: "w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100", accept: ".xlsx, .xls, .csv" })
                        ),
                        // LÓGICA DE EXIBIÇÃO DO PROGRESSO
                        isImporting && progress ?
                            React.createElement('div', { className: 'w-full' },
                                React.createElement('p', { className: 'text-sm text-center text-gray-600 mb-1' }, `${progress.message}`),
                                React.createElement('div', { className: 'w-full bg-gray-200 rounded-full h-4' },
                                    React.createElement('div', {
                                        className: 'bg-blue-600 h-4 rounded-full text-center text-white text-xs leading-4',
                                        style: { width: `${progress.percentage}%` }
                                    }, `${progress.percentage}%`)
                                )
                            ) :
                            React.createElement('button', { onClick: handleImport, disabled: isImporting || !file, className: "w-full p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition" }, 'Importar Dados')
                    ),
                    // O resto do JSX continua o mesmo...
                    React.createElement('div', { className: "mb-6 p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end" },
                        React.createElement('div', { className: "lg:col-span-2" },
                            React.createElement(DateRangePicker, { onDatesChange: (dates) => { setFilters(prev => ({ ...prev, data_inicio: dates[0] || null, data_fim: dates[1] || null })); } })
                        ),
                        React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "Placa"), React.createElement('input', { type: "text", name: "placa", value: filters.placa, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
                        React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "Estabelecimento"), React.createElement('input', { type: "text", name: "nome_estabelecimento", value: filters.nome_estabelecimento, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
                        React.createElement('button', { onClick: handleSearch, disabled: isLoading, className: "w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition lg:col-start-4" }, 'Buscar')
                    ),
                    React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
                        React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                            React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                                React.createElement('tr', null,
                                    ["Data", "Placa", "Estabelecimento", "Combustível", "Litros", "Vl/Litro", "Valor Total"].map(h => React.createElement('th', { key: h, className: "px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0" }, h))
                                )
                            ),
                            React.createElement('tbody', null,
                                isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-4 text-center" }, "Carregando...")) :
                                !hasSearched ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-6 text-center text-slate-500" }, "Utilize os filtros acima para buscar os abastecimentos.")) :
                                abastecimentos.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-6 text-center text-slate-500" }, "Nenhum resultado encontrado para sua busca.")) :
                                abastecimentos.map(item => React.createElement('tr', { key: item.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, formatDate(item.data_transacao)),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, React.createElement('span', { className: 'font-medium text-slate-800' }, item.placa)),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.nome_estabelecimento),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.tipo_combustivel),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.litros),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, `R$ ${(item.vl_litro || 0).toFixed(2).replace('.', ',')}`),
                                    React.createElement('td', { className: "px-6 py-4" }, `R$ ${(item.valor_emissao || 0).toFixed(2).replace('.', ',')}`)
                                ))
                            )
                        )
                    )
                );
            }
           
                
            function CadastroFiliais({ user, showToast }) {
                const [filiais, setFiliais] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(true);
                const [showForm, setShowForm] = React.useState(false);
                const [isEditing, setIsEditing] = React.useState(false);
                const [currentFilial, setCurrentFilial] = React.useState(null);
                const initialFormState = { nome_filial: '', centro_de_custo_final: '', cta_cod_posto: '', ticket_info_adicional1: '', shell_cnpj: '' };
                const [formData, setFormData] = React.useState(initialFormState);
                const fetchFiliais = React.useCallback(async () => {
                    setIsLoading(true);
                    try {
                        const { data, error } = await supabase.from('filiais').select('*').order('nome_filial');
                        if (error) throw error;
                        setFiliais(data || []);
                    } catch (err) {
                        showToast("Erro ao carregar filiais.", "error");
                    }
                    setIsLoading(false);
                }, [showToast]);
                React.useEffect(() => {
                    fetchFiliais();
                }, [fetchFiliais]);
                const handleInputChange = (e) => {
                    setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
                };
                const handleFormSubmit = async (e) => {
                    e.preventDefault();
                    if (!formData.nome_filial.trim() || !formData.centro_de_custo_final.trim()) {
                        showToast("Preencha os campos obrigatórios (Nome da Filial e Centro de Custo).", "error");
                        return;
                    }
                    setIsLoading(true);
                    try {
                        const record = {
                            nome_filial: formData.nome_filial.trim(),
                            centro_de_custo_final: formData.centro_de_custo_final.trim(),
                            cta_cod_posto: formData.cta_cod_posto.trim() || null,
                            ticket_info_adicional1: formData.ticket_info_adicional1.trim() || null,
                            shell_cnpj: formData.shell_cnpj.trim() || null,
                        };
                        if (isEditing) {
                            const { error } = await supabase.from('filiais').update(record).eq('id', currentFilial.id);
                            if (error) throw error;
                            showToast("Mapeamento atualizado com sucesso!", "success");
                        } else {
                            const { error } = await supabase.from('filiais').insert([{ ...record, usuario_criacao: user.nome }]);
                            if (error) throw error;
                            showToast("Novo mapeamento criado com sucesso!", "success");
                        }
                        setShowForm(false);
                        setIsEditing(false);
                        setFormData(initialFormState);
                        fetchFiliais();
                    } catch (err) {
                        showToast(`Erro ao salvar: ${err.message}`, "error");
                    }
                    setIsLoading(false);
                };
                const handleEditClick = (filial) => {
                    setIsEditing(true);
                    setCurrentFilial(filial);
                    setFormData({
                        nome_filial: filial.nome_filial || '',
                        centro_de_custo_final: filial.centro_de_custo_final || '',
                        cta_cod_posto: filial.cta_cod_posto || '',
                        ticket_info_adicional1: filial.ticket_info_adicional1 || '',
                        shell_cnpj: filial.shell_cnpj || ''
                    });
                    setShowForm(true);
                };
                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Cadastro de Filiais (DE/PARA)"),
                    !showForm && React.createElement('div', { className: 'flex justify-center mb-6' },
                        React.createElement('button', {
                            onClick: () => { setShowForm(true); setIsEditing(false); setFormData(initialFormState); },
                            className: "p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center"
                        }, React.createElement(LucideIcon, { name: 'PlusCircle', className: 'mr-2 h-5 w-5' }), "Novo Mapeamento")
                    ),
                    showForm && React.createElement('form', { onSubmit: handleFormSubmit, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8 p-4 border rounded-lg bg-gray-50" },
                        React.createElement('input', { name: "nome_filial", value: formData.nome_filial, onChange: handleInputChange, placeholder: "Nome da Filial*", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "centro_de_custo_final", value: formData.centro_de_custo_final, onChange: handleInputChange, placeholder: "Centro de Custo Final*", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "cta_cod_posto", value: formData.cta_cod_posto, onChange: handleInputChange, placeholder: "Cód. Posto (CTA)", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "ticket_info_adicional1", value: formData.ticket_info_adicional1, onChange: handleInputChange, placeholder: "Info Adicional 1 (Ticket)", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "shell_cnpj", value: formData.shell_cnpj, onChange: handleInputChange, placeholder: "CNPJ (Shell)", className: "p-2 border rounded" }),
                        React.createElement('div', { className: "md:col-span-full flex justify-end gap-4" },
                            React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "py-2 px-4 bg-gray-300 rounded-lg" }, "Cancelar"),
                            React.createElement('button', { type: "submit", className: "py-2 px-4 bg-blue-600 text-white rounded-lg", disabled: isLoading }, isLoading ? 'Salvando...' : 'Salvar')
                        )
                    ),
                    React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
                        React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                            React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                                React.createElement('tr', null,
                                    ["Filial", "Centro de Custo", "Cód. Posto (CTA)", "Info (Ticket)", "CNPJ (Shell)", "Ações"].map(h => 
                                        React.createElement('th', { key: h, className: "px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0" }, h)
                                    )
                                )
                            ),
                            React.createElement('tbody', null,
                                isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 6, className: "p-4 text-center" }, "Carregando...")) :
                                filiais.map(item => React.createElement('tr', { key: item.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, React.createElement('span', { className: 'font-medium text-slate-800' }, item.nome_filial)),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.centro_de_custo_final),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.cta_cod_posto),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.ticket_info_adicional1),
                                    React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.shell_cnpj),
                                    React.createElement('td', { className: "px-6 py-4 text-center" }, 
                                        React.createElement('button', {onClick:()=>handleEditClick(item), className:"text-gray-400 hover:text-blue-600 transition-colors"}, 
                                            React.createElement(LucideIcon, {name:'Edit', className: 'h-5 w-5'})
                                        )
                                    )
                                ))
                            )
                        )
                    )
                );
            }

            function UserManagement({ user, showToast }) {
                const [usersList, setUsersList] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(false);
                const [showForm, setShowForm] = React.useState(false);
                const initialFormState = { nome: '', usuario: '', senha: '', nivel_permissao: 'user' };
                const [formData, setFormData] = React.useState(initialFormState);
                const [showConfirmModal, setShowConfirmModal] = React.useState(false);
                const [userToDelete, setUserToDelete] = React.useState(null);
                const permissionLevels = ['administrador', 'user'];
                const getRoleBadge = (role) => {
                    const baseClasses = "inline-flex items-center py-1 px-3 rounded-full text-xs font-medium capitalize";
                    switch (role) {
                        case 'administrador': return React.createElement('span', { className: `bg-red-100 text-red-800 ${baseClasses}` }, role);
                        case 'user': default: return React.createElement('span', { className: `bg-gray-100 text-gray-800 ${baseClasses}` }, role);
                    }
                };
                const fetchUsers = React.useCallback(async () => {
                    setIsLoading(true);
                    try {
                        const { data, error } = await supabase.from('usuarios').select('*').order('data_criacao', { ascending: false });
                        if (error) throw error;
                        setUsersList(data || []);
                    } catch (e) {
                        showToast("Erro ao carregar usuários.", "error");
                    }
                    setIsLoading(false);
                }, [showToast]);
                React.useEffect(() => {
                    fetchUsers();
                }, [fetchUsers]);
                const handleInputChange = (e) => {
                    setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
                };
                const handleAddUser = async (e) => {
                    e.preventDefault();
                    if (!formData.nome.trim() || !formData.usuario.trim() || !formData.senha.trim()) { 
                        showToast("Preencha todos os campos obrigatórios.", "error");
                        return; 
                    }
                    setIsLoading(true);
                    try {
                        const { data: existing } = await supabase.from('usuarios').select('usuario').eq('usuario', formData.usuario.trim().toLowerCase());
                        if (existing && existing.length > 0) { 
                            showToast("Nome de usuário já existe.", "error");
                            setIsLoading(false); 
                            return; 
                        }
                        const { error } = await supabase.from('usuarios').insert([{ 
                            nome: formData.nome.trim(), 
                            usuario: formData.usuario.trim().toLowerCase(), 
                            senha: formData.senha,
                            nivel_permissao: formData.nivel_permissao,
                            usuario_criacao: user.nome
                        }]);
                        if (error) throw error;
                        showToast("Usuário adicionado com sucesso!", "success");
                        setFormData(initialFormState);
                        setShowForm(false);
                        fetchUsers();
                    } catch(e) {
                        showToast("Erro ao adicionar usuário.", "error");
                    }
                    setIsLoading(false);
                };
                const confirmDeleteUser = (user) => { 
                    setUserToDelete(user); 
                    setShowConfirmModal(true); 
                };
                const handleDeleteUser = async () => {
                    if (!userToDelete) return;
                    setIsLoading(true);
                    try {
                        const { error } = await supabase.from('usuarios').delete().eq('id', userToDelete.id);
                        if (error) throw error;
                        showToast("Usuário excluído com sucesso!", "success");
                        fetchUsers();
                    } catch(e) {
                        showToast("Erro ao excluir usuário.", "error");
                    }
                    setIsLoading(false);
                    setShowConfirmModal(false);
                    setUserToDelete(null);
                };
                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Gerenciamento de Usuários"),
                    !showForm && React.createElement('div', { className: 'flex justify-center mb-6' },
                        React.createElement('button', {
                            onClick: () => setShowForm(true),
                            className: "p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center"
                        }, React.createElement(LucideIcon, { name: 'PlusCircle', className: 'mr-2 h-5 w-5' }), "Novo Usuário")
                    ),
                    showForm && React.createElement('form', { onSubmit: handleAddUser, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 p-4 border rounded-lg bg-gray-50" },
                        React.createElement('input', { name: "nome", value: formData.nome, onChange: handleInputChange, placeholder: "Nome Completo*", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "usuario", value: formData.usuario, onChange: handleInputChange, placeholder: "Usuário (para login)*", className: "p-2 border rounded" }),
                        React.createElement('input', { name: "senha", type: "password", value: formData.senha, onChange: handleInputChange, placeholder: "Senha*", className: "p-2 border rounded" }),
                        React.createElement('select', { name: "nivel_permissao", value: formData.nivel_permissao, onChange: handleInputChange, className: "p-2 border rounded" }, 
                            permissionLevels.map(r => React.createElement('option', { key: r, value: r }, r.charAt(0).toUpperCase() + r.slice(1)))
                        ),
                        React.createElement('div', { className: "lg:col-span-4 flex justify-end gap-4" },
                            React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "py-2 px-4 bg-gray-300 rounded-lg" }, "Cancelar"),
                            React.createElement('button', { type: "submit", className: "py-2 px-4 bg-blue-600 text-white rounded-lg", disabled: isLoading }, isLoading ? 'Salvando...' : 'Salvar')
                        )
                    ),
                    React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
                        React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                            React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" }, 
                                React.createElement('tr', null, 
                                    ["Usuário", "Nome Completo", "Nível de Permissão", "Data Criação", "Ações"].map(h => React.createElement('th',{key:h, className:"px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0"},h))
                                )
                            ),
                            React.createElement('tbody', null, 
                                isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-4 text-center" }, "Carregando...")) :
                                usersList.map(u => React.createElement('tr', { key: u.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                                    React.createElement('td', {className:"px-6 py-4 border-r border-slate-200"}, React.createElement('span', { className: 'font-medium text-slate-800' }, u.usuario)),
                                    React.createElement('td', {className:"px-6 py-4 border-r border-slate-200"}, u.nome),
                                    React.createElement('td', {className:"px-6 py-4 border-r border-slate-200"}, getRoleBadge(u.nivel_permissao)),
                                    React.createElement('td', {className:"px-6 py-4 border-r border-slate-200"}, new Date(u.data_criacao).toLocaleDateString('pt-BR')),
                                    React.createElement('td', {className:"px-6 py-4 text-center"}, 
                                        React.createElement('button', { onClick: () => confirmDeleteUser(u), className: "text-gray-400 hover:text-red-600 transition-colors" }, 
                                            React.createElement(LucideIcon, {name: 'Trash2', className: 'h-5 w-5'})
                                        )
                                    )
                                ))
                            )
                        )
                    ),
                    showConfirmModal && React.createElement(ConfirmationModal, { message: `Deseja realmente excluir o usuário "${userToDelete?.usuario}"?`, onConfirm: handleDeleteUser, onCancel: () => setShowConfirmModal(false) })
                );
            }

            // ================================================================
            // 4. COMPONENTE PRINCIPAL (App)
            // ================================================================
           function App() {
                const [user, setUser] = React.useState(() => {
                    const savedUser = localStorage.getItem('userSession');
                    return savedUser ? JSON.parse(savedUser) : null;
                });
                const [currentPage, setCurrentPage] = React.useState('dashboard');
                const [toast, setToast] = React.useState({ show: false, message: '', type: '' });
                const [isSidebarOpen, setIsSidebarOpen] = React.useState(false);
                const [openMenu, setOpenMenu] = React.useState('dashboard');
                const [isSidebarCollapsed, setIsSidebarCollapsed] = React.useState(false);
                
                // NOVO ESTADO PARA CONTROLAR A VISUALIZAÇÃO DE UMA PLACA ESPECÍFICA
                const [viewingPlaca, setViewingPlaca] = React.useState(null);

                const ctaIconUrl = 'https://ikypygpbdmoxozfmwewr.supabase.co/storage/v1/object/sign/ICONS/CTAICON.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9lMGJiMDk5Zi1jZmE5LTQ5Y2UtYjUwNy0wZmE2ZWZkYWYxOTIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJJQ09OUy9DVEFJQ09OLnBuZyIsImlhdCI6MTc1OTk2Njc0NywiZXhwIjoyMDc1MzI2NzQ3fQ.sfY6KIR1cAyug6oAOfAYvBQbByPHDS10HioBFBVr5lw';
                const ticketIconUrl = 'https://ikypygpbdmoxozfmwewr.supabase.co/storage/v1/object/sign/ICONS/TICKET.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9lMGJiMDk5Zi1jZmE5LTQ5Y2UtYjUwNy0wZmE2ZWZkYWYxOTIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJJQ09OUy9USUNLRVQucG5nIiwiaWF0IjoxNzU5OTY2ODQxLCJleHAiOjIwNzUzMjY4NDF9.7evbgFp_Qn62j4sGLMdSNdgy3QzoGyw1GPahdROsnj0';
                const shellIconUrl = 'https://ikypygpbdmoxozfmwewr.supabase.co/storage/v1/object/sign/ICONS/Shell-958x575-1-Photoroom-Photoroom.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9lMGJiMDk5Zi1jZmE5LTQ5Y2UtYjUwNy0wZmE2ZWZkYWYxOTIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJJQ09OUy9TaGVsbC05NTh4NTc1LTEtUGhvdG9yb29tLVBob3Rvcm9vbS5wbmciLCJpYXQiOjE3NTk5NjY2OTQsImV4cCI6MjA3NTMyNjY5NH0.IAKKyeSGzMJ9QK9yuO_xVkRCwBaGipCLgN3CyFM8_Oo';

                const handleLogin = (userData) => {
                    localStorage.setItem('userSession', JSON.stringify(userData));
                    setUser(userData);
                    setCurrentPage('dashboard');
                };
                const handleLogout = () => {
                    localStorage.removeItem('userSession');
                    setUser(null);
                };
                const showToast = React.useCallback((message, type = 'success') => {
    setToast({ show: true, message, type });
}, []);
                const closeToast = () => setToast({ show: false, message: '', type: '' });
                
                const navigateTo = (page) => {
                    setViewingPlaca(null);
                    setCurrentPage(page);
                };

                const viewPlacaProfile = (placa) => {
                    setViewingPlaca(placa);
                };

                const toggleMenu = (menu) => {
                    if (isSidebarCollapsed) {
                        setIsSidebarCollapsed(false);
                    } else {
                        setOpenMenu(openMenu === menu ? '' : menu);
                    }
                };
                const toggleSidebarCollapse = () => {
                    setIsSidebarCollapsed(!isSidebarCollapsed);
                    if (!isSidebarCollapsed) {
                        setOpenMenu('');
                    }
                };
                window.viewPlacaProfile = (placa) => {
                    setViewingPlaca(placa);
                };
                const renderPage = () => {
                    if (viewingPlaca) {
                        return React.createElement(PerfilVeiculo, { 
                            user, 
                            showToast, 
                            placa: viewingPlaca, 
                            onBack: () => setViewingPlaca(null) 
                        });
                    }

                    switch (currentPage) {
                        case 'dashboard': return React.createElement(Dashboard, { user, showToast, setCurrentPage: navigateTo });
                        case 'ticketAbastecimentos': return React.createElement(TicketAbastecimentos, { user, showToast });
                        case 'ctaAbastecimentos': return React.createElement(CtaAbastecimentos, { user, showToast });
                        case 'ctaCarregamentos': return React.createElement(CtaCarregamentos, { user, showToast });
                        case 'shellAbastecimentos': return React.createElement(ShellAbastecimentos, { user, showToast });
                        case 'afericoes': return React.createElement(Afericoes, { user, showToast });
                        case 'alertas': return React.createElement(Alertas, { user, showToast, onViewPlaca: viewPlacaProfile });
                        case 'analiseCustos': return React.createElement(AnaliseCustos, { user, showToast });
                        case 'analiseEquipamentos': return React.createElement(AnaliseEquipamentos, { user, showToast, onViewPlaca: viewPlacaProfile });
                        case 'analiseGeografica': return React.createElement(AnaliseGeografica, { user, showToast, onViewPlaca: viewPlacaProfile });
                        case 'cadastroFiliais': return user.nivel_permissao === 'administrador' ? React.createElement(CadastroFiliais, { user, showToast }) : null;
                        case 'mapeamentoCombustivel': return user.nivel_permissao === 'administrador' ? React.createElement(MapeamentoCombustivel, { user, showToast }) : null;
                        case 'cadastroAlertas': return user.nivel_permissao === 'administrador' ? React.createElement(CadastroAlertas, { user, showToast }) : null;
                        case 'userManagement': return React.createElement(UserManagement, { user, showToast });
                        default: return React.createElement(Dashboard, { user, showToast, setCurrentPage: navigateTo });
                    }
                };

                if (!user) {
                    return React.createElement(LoginPage, { onLogin: handleLogin });
                }

                const MenuItem = ({ page, icon, text }) => {
                   const isActive = currentPage === page && !viewingPlaca;
                   let iconElement;
                   
                   if (typeof icon === 'string' && icon.startsWith('http')) {
                       iconElement = React.createElement('img', {
                           src: icon,
                           alt: text,
                           className: `h-5 w-5 flex-shrink-0 object-contain ${!isSidebarCollapsed && 'mr-3'}`
                       });
                   } else {
                       iconElement = React.createElement(LucideIcon, {
                           name: icon,
                           className: `h-5 w-5 flex-shrink-0 ${!isSidebarCollapsed && 'mr-3'}`
                       });
                   }

                   return React.createElement('li', null,
                       React.createElement('button', {
                           onClick: () => { navigateTo(page); setIsSidebarOpen(false); },
                           className: `flex items-center w-full px-4 py-2 rounded-lg transition-colors ${isSidebarCollapsed ? 'justify-center' : ''} ${isActive ? 'bg-blue-600 text-white' : 'hover:bg-gray-700 text-gray-300'}`
                       },
                           iconElement,
                           !isSidebarCollapsed && React.createElement('span', {className: 'truncate'}, text)
                       )
                    );
                };
                
                const MenuCategory = ({ title, icon, children, menuKey }) => {
                    const isOpen = openMenu === menuKey;
                    let iconElement;

                    if (typeof icon === 'string' && icon.startsWith('http')) {
                         iconElement = React.createElement('img', {
                             src: icon,
                             alt: title,
                             className: `h-5 w-5 flex-shrink-0 object-contain ${!isSidebarCollapsed && 'mr-3'}`
                         });
                    } else {
                         iconElement = React.createElement(LucideIcon, {
                             name: icon,
                             className: `h-5 w-5 flex-shrink-0 ${!isSidebarCollapsed && 'mr-3'}`
                         });
                    }

                    return (
                        React.createElement('li', { className: "mb-2" },
                            React.createElement('button', {
                                onClick: () => toggleMenu(menuKey),
                                className: `flex items-center w-full px-4 py-2 rounded-lg transition-colors ${isSidebarCollapsed ? 'justify-center' : ''} ${!isSidebarCollapsed ? 'justify-between' : ''} ${isOpen && !isSidebarCollapsed ? 'bg-gray-700' : 'hover:bg-gray-700'} text-gray-200`
                            },
                                React.createElement('span', {className: 'flex items-center truncate'},
                                    iconElement,
                                    !isSidebarCollapsed && React.createElement('span', {className: 'truncate'}, title)
                                ),
                                !isSidebarCollapsed && React.createElement(LucideIcon, { name: isOpen ? "ChevronUp" : "ChevronDown", className: "h-5 w-5 flex-shrink-0" })
                            ),
                            !isSidebarCollapsed && isOpen && React.createElement('ul', { className: "ml-4 mt-2 space-y-2 border-l border-gray-700 pl-4" }, children)
                        )
                    );
                };

                return (
                    React.createElement('div', { className: "flex min-h-screen bg-gray-100" },
                        React.createElement('aside', { className: `fixed inset-y-0 left-0 bg-gray-800 text-white p-4 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition-all duration-300 z-30 flex flex-col ${isSidebarCollapsed ? 'w-24' : 'w-72'}` },
                            React.createElement('div', { className: "flex items-center justify-center mb-8" },
                                React.createElement('img', { 
                                    src: "https://ikypygpbdmoxozfmwewr.supabase.co/storage/v1/object/sign/logo/LOGO_TERSYS-removebg-preview%20(1)%20(1).png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9lMGJiMDk5Zi1jZmE5LTQ5Y2UtYjUwNy0wZmE2ZWZkYWYxOTIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJsb2dvL0xPR09fVEVSU1lTLXJlbW92ZWJnLXByZXZpZXcgKDEpICgxKS5wbmciLCJpYXQiOjE3NTk5NjY4OTUsImV4cCI6MjA3NTMyNjg5NX0.s5l16HeRsUTzw0wECTs63OECJcOoaA03DYTopziVawk", 
                                    alt: "Logo", 
                                    className: `cursor-pointer transition-all duration-300 ${isSidebarCollapsed ? 'h-12 w-auto' : 'h-16 w-auto'}`,
                                    onClick: () => navigateTo('dashboard') 
                                })
                            ),
                            React.createElement('nav', { className: "flex-grow" },
                                React.createElement('ul', { className: "space-y-2" },
                                    React.createElement(MenuCategory, { title: "Dashboard", icon: "LayoutDashboard", menuKey: "dashboard" },
                                        React.createElement(MenuItem, { page: 'dashboard', icon: 'FileText', text: 'Controle de Alertas' }),
                                        React.createElement(MenuItem, { page: 'analiseCustos', icon: 'Beaker', text: 'Análise Comparativa' }),
                                        React.createElement(MenuItem, { page: 'analiseEquipamentos', icon: 'Ship', text: 'Consumo por Equipamento' }),
                                        React.createElement(MenuItem, { page: 'analiseGeografica', icon: 'Tank', text: 'Mapa de Custos' })
                                    ),
                                    React.createElement(MenuCategory, { title: "Importação", icon: "PlusCircle", menuKey: "importacao" },
                                        React.createElement(MenuItem, { page: 'ticketAbastecimentos', icon: ticketIconUrl, text: 'Ticket' }),
                                        React.createElement(MenuItem, { page: 'ctaAbastecimentos', icon: ctaIconUrl, text: 'CTA - Abastecimentos' }),
                                        React.createElement(MenuItem, { page: 'ctaCarregamentos', icon: ctaIconUrl, text: 'CTA - Carregamentos' }),
                                        React.createElement(MenuItem, { page: 'shellAbastecimentos', icon: shellIconUrl, text: 'Shell' })
                                    ),
                                    React.createElement(MenuCategory, { title: "Operacional", icon: "Settings", menuKey: "operacional" },
                                        React.createElement(MenuItem, { page: 'alertas', icon: 'FileText', text: 'Painel de Alertas' }),
                                        React.createElement(MenuItem, { page: 'afericoes', icon: 'Tank', text: 'Aferições e Perdas' })
                                    ),
                                    user.nivel_permissao === 'administrador' && React.createElement(MenuCategory, { title: "Cadastros", icon: "FileText", menuKey: "cadastros" },
                                        React.createElement(MenuItem, { page: 'cadastroFiliais', icon: 'Building', text: 'Filiais (DE/PARA)' }),
                                        React.createElement(MenuItem, { page: 'mapeamentoCombustivel', icon: 'Fuel', text: 'DE/PARA Combustível' }),
                                        React.createElement(MenuItem, { page: 'cadastroAlertas', icon: 'Settings', text: 'Tipos de Alerta' }),
                                        React.createElement(MenuItem, { page: 'userManagement', icon: 'Users', text: 'Usuários' })
                                    )
                                )
                            ),
                            React.createElement('div', {className: 'mt-auto pt-4 border-t border-gray-700'},
                                React.createElement('button', { 
                                    onClick: toggleSidebarCollapse, 
                                    className: "w-full flex items-center p-3 rounded-lg text-gray-400 hover:bg-gray-700 justify-center mb-2" 
                                },
                                    React.createElement(LucideIcon, { name: isSidebarCollapsed ? "ChevronsRight" : "ChevronsLeft", className: "w-6 h-6" })
                                ),
                                React.createElement('button', { 
                                    onClick: handleLogout, 
                                    className: `w-full flex items-center p-3 rounded-lg text-red-400 hover:bg-gray-700 ${isSidebarCollapsed ? 'justify-center' : ''}` 
                                },
                                    React.createElement(LucideIcon, { name: "LogOut", className: `w-6 h-6 ${!isSidebarCollapsed && 'mr-3'}` }),
                                    !isSidebarCollapsed && 'Sair'
                                )
                            )
                        ),
                        React.createElement('main', { className: "flex-1 p-4 md:p-8 flex flex-col" },
                            React.createElement('header', { className: "w-full bg-white p-4 rounded-xl shadow-lg mb-8 flex justify-between items-center" },
                                React.createElement('button', { className: "md:hidden text-gray-700 p-2", onClick: () => setIsSidebarOpen(true) }, React.createElement(LucideIcon, { name: "Menu" })),
                                React.createElement('div', { className: "text-right text-sm text-gray-600" },
                                    React.createElement('p', null, "Usuário: ", React.createElement('strong', null, user.nome)),
                                    React.createElement('p', {className: "capitalize"}, "Permissão: ", React.createElement('strong', null, user.nivel_permissao))
                                )
                            ),
                            React.createElement('div', { className: "flex-grow" }, renderPage()),
                            toast.show && React.createElement(Toast, { message: toast.message, type: toast.type, onClose: closeToast })
                        )
                    )
                );
            }
            // ================================================================
            // 5. INICIALIZAÇÃO
            // ================================================================
            const initializeSupabaseAndRenderApp = () => {
                try {
                    // Inicializa o cliente do projeto principal
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    
                    // CORREÇÃO: Adiciona a inicialização do cliente do segundo projeto
                    supabaseProjeto2 = window.supabase.createClient(SUPABASE_URL_PROJETO_2, SUPABASE_ANON_KEY_PROJETO_2);
                    
                    ReactDOM.render(React.createElement(App), document.getElementById('root'));
                } catch (e) {
                    console.error("Erro ao inicializar os clientes Supabase:", e);
                }
            };

            const supabaseScript = document.createElement('script');
            supabaseScript.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/dist/umd/supabase.min.js";
            supabaseScript.onload = initializeSupabaseAndRenderApp;
            document.head.appendChild(supabaseScript);
        }
    </script>
</body>
</html>
