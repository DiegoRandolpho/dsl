<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERSYS - Gestão de Diesel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        .login-bg-image-new {
            background-image: url('https://ikypygpbdmoxozfmwewr.supabase.co/storage/v1/object/sign/Loginpage/unnamed%20(1).png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9lMGJiMDk5Zi1jZmE5LTQ5Y2UtYjUwNy0wZmE2ZWZkYWYxOTIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJMb2dpbnBhZ2UvdW5uYW1lZCAoMSkucG5nIiwiaWF0IjoxNzU5MjYxNjYwLCJleHAiOjIwNzQ2MjE2NjB9.rulaTJo6deZqm5CNYCEfbKBf1K3HzljRLHRPoqAl_V8');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e0e0e0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #bdbdbd; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script type="text/javascript">
        // Definição dos ícones Lucide que usaremos
        const icons = {
            LayoutDashboard: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>',
            Ticket: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9a3 3 0 0 1 0 6v1a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-1a3 3 0 0 1 0-6V8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>',
            Fuel: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" x2="15" y1="22" y2="22"/><line x1="4" x2="14" y1="9" y2="9"/><path d="M14 22V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v18"/><path d="M14 13h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2v-4Z"/></svg>',
            Ship: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 21c.6.5 1.2 1 2.5 1 1.6 0 2.5-.5 5-1 2.5-.5 3.4 0 5 1 1.6.5 2.5 0 5-1 2.5-1 3-1.5 3-2 0 0 0-6.5-2-8l-2-2-2.5 1-1.5-2-3-2-3 2-1.5 2-2.5-1-2 2c-2 1.5-2 8-2 8Z"/><path d="M2 15h20"/><path d="M8 21V9l2-3 2 3v12"/><path d="m18 21-1-3-1 3h2Z"/></svg>',
            Beaker: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-16V3"/><path d="M6 14h12"/></svg>',
            Users: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            LogOut: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 16 22 12 17 8"/><line x1="22" x2="11" y1="12" y2="12"/></svg>',
            Menu: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>',
            ChevronUp: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up"><path d="m18 15-6-6-6 6"/></svg>',
            ChevronDown: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>',
            Trash2: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>',
            PlusCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>',
            Building: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M12 18h.01"/></svg>',
            FileText: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L15 2z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>',
            ChevronsLeft: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m11 17-5-5 5-5"/><path d="m18 17-5-5 5-5"/></svg>',
            ChevronsRight: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 17 5-5-5-5"/><path d="m13 17 5-5-5-5"/></svg>',
        };

        window.onload = function() {
            // ================================================================
            // 1. CONFIGURAÇÃO
            // ================================================================
            const SUPABASE_URL = 'https://ikypygpbdmoxozfmwewr.supabase.co'; // <-- SUBSTITUA AQUI
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlreXB5Z3BiZG1veG96Zm13ZXdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTE0MTYsImV4cCI6MjA3NDcyNzQxNn0.IWoX896KWVC9p1M9EcFTOk6YhSljDOtxIl3yPxZS0Xg'; // <-- SUBSTITUA AQUI
            let supabase;

            // ================================================================
            // 2. COMPONENTES AUXILIARES (Helpers)
            // ================================================================
            function LucideIcon({ name, className }) {
                return React.createElement('span', {
                    className: className,
                    dangerouslySetInnerHTML: { __html: icons[name] || '' }
                });
            }

            function Toast({ message, type, onClose }) {
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                React.useEffect(() => {
                    const timer = setTimeout(() => onClose(), 3000);
                    return () => clearTimeout(timer);
                }, [onClose]);
                return React.createElement('div', { className: `fixed bottom-4 right-4 ${bgColor} text-white p-4 rounded-lg shadow-lg flex items-center z-50` }, message);
            }
            
            function ConfirmationModal({ message, onConfirm, onCancel }) {
                return React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" },
                    React.createElement('div', { className: "bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center" },
                        React.createElement('p', { className: "text-lg font-semibold text-gray-800 mb-6" }, message),
                        React.createElement('div', { className: "flex justify-center space-x-4" },
                            React.createElement('button', { onClick: onConfirm, className: "px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition" }, "Confirmar"),
                            React.createElement('button', { onClick: onCancel, className: "px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition" }, "Cancelar")
                        )
                    )
                );
            }

            // ================================================================
            // 3. COMPONENTES DE PÁGINA (Módulos)
            // ================================================================

            // --- TELA DE LOGIN (Adaptada do TERSYS) ---
            function LoginPage({ onLogin }) {
    const [usuario, setUsuario] = React.useState('');
    const [senha, setSenha] = React.useState('');
    const [error, setError] = React.useState('');
    const [isLoggingIn, setIsLoggingIn] = React.useState(false);

    const handleLogin = async (e) => {
        e.preventDefault();
        setIsLoggingIn(true);
        setError('');
        try {
            const { data, error: fetchError } = await supabase
                .from('usuarios')
                .select('*')
                .eq('usuario', usuario.toLowerCase())
                .eq('senha', senha)
                .single();
            
            if (fetchError || !data) {
                setError('Usuário ou senha inválidos.');
            } else {
                onLogin(data); 
            }
        } catch (e) {
            setError("Erro ao autenticar. Tente novamente.");
        }
        setIsLoggingIn(false);
    };

    // ATUALIZADO: Estrutura completa com duas colunas
    return (
        React.createElement('div', { className: "min-h-screen flex" },
            // Coluna do Formulário (Esquerda)
            React.createElement('div', { className: "w-full lg:w-1/2 flex items-center justify-center p-8 bg-white" },
                React.createElement('div', { className: "max-w-md w-full" },
                    React.createElement('div', { className: "flex justify-center mb-6" },
                        React.createElement('img', {
                            src: "https://ikypygpbdmoxozfmwewr.supabase.co/storage/v1/object/sign/logo/LOGO_TERSYS-removebg-preview%20(1)%20(1).png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9lMGJiMDk5Zi1jZmE5LTQ5Y2UtYjUwNy0wZmE2ZWZkYWYxOTIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJsb2dvL0xPR09fVEVSU1lTLXJlbW92ZWJnLXByZXZpZXcgKDEpICgxKS5wbmciLCJpYXQiOjE3NTkyMzU4NTYsImV4cCI6MjA3NDU5NTg1Nn0.R8XPKzBUjrjR3kcJijIvDaCGpGMlvyMKA6lsqiSOcEQ",
                            alt: "TERSYS Logo",
                            className: "h-auto w-auto"
                        })
                    ),
                    error && React.createElement('div', { className: "bg-red-100 text-red-700 p-3 rounded text-center mb-4" }, error),
                    React.createElement('form', { onSubmit: handleLogin, className: "space-y-6" },
                        React.createElement('div', null,
                            React.createElement('label', { htmlFor: "username", className: "block text-sm font-medium text-gray-700" }, "Usuário"),
                            React.createElement('input', { type: "text", id: "username", value: usuario, onChange: (e) => setUsuario(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500", placeholder: "Seu usuário", required: true, disabled: isLoggingIn })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { htmlFor: "password", className: "block text-sm font-medium text-gray-700" }, "Senha"),
                            React.createElement('input', { type: "password", id: "password", value: senha, onChange: (e) => setSenha(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500", placeholder: "Sua senha", required: true, disabled: isLoggingIn })
                        ),
                        React.createElement('button', { type: "submit", className: "w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50", disabled: isLoggingIn }, isLoggingIn ? 'Entrando...' : 'Entrar')
                    )
                )
            ),
            // Coluna da Imagem (Direita)
            React.createElement('div', { className: "hidden lg:block lg:w-1/2 login-bg-image-new" })
        )
    );
}
            // --- ESQUELETO: Dashboard ---
            function Dashboard({ user, showToast }) {
                // TODO: Adicionar lógica para buscar últimos abastecimentos
                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4" }, `Olá, ${user.nome}!`),
                    React.createElement('p', null, "Dashboard com os últimos abastecimentos de cada origem (em desenvolvimento).")
                );
            }
/* INÍCIO DO CÓDIGO ATUALIZADO PARA CtaCarregamentos */

function CtaCarregamentos({ user, showToast }) {
    const [carregamentos, setCarregamentos] = React.useState([]);
    const [isLoading, setIsLoading] = React.useState(false);
    const [showForm, setShowForm] = React.useState(false);
    
    const initialFormState = { cod_posto: '', volume: '', custo: '', preco_por_litro: '', nota_fiscal: '', fornecedor: '', entrega: '' };
    const [formData, setFormData] = React.useState(initialFormState);

    const [file, setFile] = React.useState(null);
    const [isImporting, setIsImporting] = React.useState(false);

    const [searchTerm, setSearchTerm] = React.useState('');
    const [hasSearched, setHasSearched] = React.useState(false);

    const formatDate = (dateString) => {
        if (!dateString) return '—';
        if (typeof dateString === 'number' && dateString > 1) {
            const date = new Date(Math.round((dateString - 25569) * 86400 * 1000));
            return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
        }
        const date = new Date(dateString.includes('T') ? dateString : dateString + 'T00:00:00');
        return date.toLocaleDateString('pt-BR');
    };

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleFormSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            const recordToInsert = {
                ...formData,
                custo: parseFloat(formData.custo),
                volume: parseFloat(formData.volume),
                preco_por_litro: parseFloat(formData.preco_por_litro),
                usuario_criacao: user.nome,
                data_criacao: new Date().toISOString(),
            };
            
            const { error } = await supabase.from('cta_carregamentos').insert([recordToInsert]);
            if (error) throw error;

            showToast("Carregamento registrado com sucesso!", "success");
            setFormData(initialFormState);
            setShowForm(false);
            handleSearch(); // Atualiza a busca se um termo já estiver ativo
        } catch (err) {
            showToast(`Erro ao registrar carregamento: ${err.message}`, "error");
        }
        setIsLoading(false);
    };

    const handleFileChange = (e) => {
        if (e.target.files && e.target.files[0]) {
            setFile(e.target.files[0]);
        }
    };

    const handleImport = () => {
        if (!file) {
            showToast("Por favor, selecione um arquivo para importar.", "error");
            return;
        }
        setIsImporting(true);
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                const dataToInsert = json.map(row => {
                    let deliveryDate = null;
                    const excelDate = row['Entrega'];
                    if (excelDate) {
                        if (excelDate instanceof Date) {
                            deliveryDate = excelDate.toISOString().split('T')[0];
                        } else if (typeof excelDate === 'string' && excelDate.includes('/')) {
                            const parts = excelDate.split('/');
                            if(parts.length === 3) {
                               deliveryDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                            }
                        }
                    }

                    return {
                        cod_posto: row['Cod Posto'],
                        volume: parseFloat(row['Volume']) || 0,
                        custo: parseFloat(row['Custo']) || 0,
                        preco_por_litro: parseFloat(row['Preço p/ Litro']) || 0,
                        nota_fiscal: row['Nota Fiscal'],
                        fornecedor: row['Fornecedor'],
                        entrega: deliveryDate,
                        usuario_criacao: user.nome,
                        data_criacao: new Date().toISOString(),
                    };
                });

                if (dataToInsert.length === 0) {
                    showToast("Nenhum dado válido encontrado na planilha.", "info");
                    setIsImporting(false);
                    return;
                }
                
                const { error } = await supabase.from('cta_carregamentos').insert(dataToInsert);
                if (error) {
                    console.error("Erro do Supabase:", error);
                    throw error;
                }

                showToast(`${dataToInsert.length} registros importados com sucesso!`, "success");
                setFile(null); 
                document.getElementById('file-input').value = '';
                setHasSearched(false);
                setCarregamentos([]);
            } catch (err) {
                showToast(`Erro ao processar o arquivo: ${err.message}`, "error");
            }
            setIsImporting(false);
        };
        reader.readAsArrayBuffer(file);
    };

    const handleSearch = async () => {
        if (!searchTerm.trim()) {
            showToast("Por favor, digite algo para buscar.", "error");
            return;
        }
        setIsLoading(true);
        setHasSearched(true);
        try {
            const { data, error } = await supabase
                .from('cta_carregamentos')
                .select('*')
                .or(`nota_fiscal.ilike.%${searchTerm.trim()}%,fornecedor.ilike.%${searchTerm.trim()}%`)
                .order('entrega', { ascending: false });
            
            if (error) throw error;
            setCarregamentos(data || []);
        } catch (err) {
            showToast("Erro ao buscar carregamentos.", "error");
        }
        setIsLoading(false);
    };

    return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
        React.createElement('div', { className: "flex justify-between items-center mb-6" },
            React.createElement('h2', { className: "text-2xl font-bold text-gray-800" }, "CTA Carregamentos"),
            React.createElement('button', {
                onClick: () => setShowForm(!showForm),
                className: "p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center"
            }, 
                React.createElement(LucideIcon, { name: 'PlusCircle', className: 'mr-2 h-5 w-5' }),
                showForm ? "Fechar Formulário" : "Novo Carregamento"
            )
        ),

        showForm && React.createElement('form', { 
            onSubmit: handleFormSubmit, 
            className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 p-4 border rounded-lg bg-gray-50" 
        },
            React.createElement('input', { name: "cod_posto", value: formData.cod_posto, onChange: handleInputChange, placeholder: "Cód. Posto", className: "p-2 border rounded" }),
            React.createElement('input', { name: "volume", type: "number", step: "0.01", value: formData.volume, onChange: handleInputChange, placeholder: "Volume", className: "p-2 border rounded" }),
            React.createElement('input', { name: "custo", type: "number", step: "0.01", value: formData.custo, onChange: handleInputChange, placeholder: "Custo Total", className: "p-2 border rounded" }),
            React.createElement('input', { name: "preco_por_litro", type: "number", step: "0.001", value: formData.preco_por_litro, onChange: handleInputChange, placeholder: "Preço p/ Litro", className: "p-2 border rounded" }),
            React.createElement('input', { name: "nota_fiscal", value: formData.nota_fiscal, onChange: handleInputChange, placeholder: "Nota Fiscal", className: "p-2 border rounded" }),
            React.createElement('input', { name: "fornecedor", value: formData.fornecedor, onChange: handleInputChange, placeholder: "Fornecedor", className: "p-2 border rounded" }),
            React.createElement('div', null, 
                React.createElement('label', { htmlFor: 'entrega', className: 'text-xs text-gray-500' }, 'Data da Entrega'),
                React.createElement('input', { name: "entrega", id: 'entrega', type: "date", value: formData.entrega, onChange: handleInputChange, className: "w-full p-2 border rounded" })
            ),
            React.createElement('div', { className: "lg:col-span-4 flex justify-end gap-4" },
                React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "py-2 px-4 bg-gray-300 rounded-lg" }, "Cancelar"),
                React.createElement('button', { type: "submit", className: "py-2 px-4 bg-blue-600 text-white rounded-lg", disabled: isLoading }, isLoading ? 'Salvando...' : 'Salvar')
            )
        ),
        
        React.createElement('div', { className: "mb-8 p-4 border rounded-lg bg-gray-100 grid grid-cols-1 md:grid-cols-2 gap-4 items-end" },
            React.createElement('div', null,
                React.createElement('label', { htmlFor: 'file-input', className: "block text-sm font-medium text-gray-700 mb-1" }, "Importar Planilha (.xlsx, .xls, .csv)"),
                React.createElement('input', { id: 'file-input', type: "file", onChange: handleFileChange, className: "w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100", accept: ".xlsx, .xls, .csv" })
            ),
            React.createElement('button', { onClick: handleImport, disabled: isImporting, className: "w-full p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition" }, isImporting ? 'Importando...' : 'Importar Dados')
        ),

        React.createElement('div', { className: "mb-6 p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-3 gap-4 items-end" },
            React.createElement('div', { className: 'md:col-span-2' },
                React.createElement('label', { className: "block text-sm font-medium text-gray-700" }, "Buscar por Nota Fiscal ou Fornecedor"),
                React.createElement('input', { type: "text", placeholder: "Digite aqui...", value: searchTerm, onChange: e => setSearchTerm(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" })
            ),
            React.createElement('button', { onClick: handleSearch, disabled: isLoading, className: "w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition" }, isLoading ? 'Buscando...' : 'Buscar')
        ),
        
        React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
            React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                    React.createElement('tr', null,
                        ["Cód. Posto", "Volume (L)", "Custo Total", "Preço p/ Litro", "Nota Fiscal", "Fornecedor", "Data Entrega"].map(h => 
                            React.createElement('th', { key: h, className: "px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0" }, h)
                        )
                    )
                ),
                React.createElement('tbody', null,
                    isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-4 text-center" }, "Carregando...")) :
                    !hasSearched ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-6 text-center text-slate-500" }, "Utilize a busca acima para encontrar os carregamentos.")) :
                    carregamentos.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-6 text-center text-slate-500" }, "Nenhum carregamento encontrado para sua busca.")) :
                    carregamentos.map(c => React.createElement('tr', { key: c.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, c.cod_posto),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, c.volume),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, `R$ ${(c.custo || 0).toFixed(2).replace('.', ',')}`),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, `R$ ${(c.preco_por_litro || 0).toFixed(3).replace('.', ',')}`),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, React.createElement('span', { className: 'font-medium text-slate-800' }, c.nota_fiscal)),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, c.fornecedor),
                        React.createElement('td', { className: "px-6 py-4" }, formatDate(c.entrega))
                    ))
                )
            )
        )
    );
}

/* FIM DO CÓDIGO ATUALIZADO */
/* INÍCIO DO CÓDIGO ATUALIZADO PARA CtaAbastecimentos */

function CtaAbastecimentos({ user, showToast }) {
    const [abastecimentos, setAbastecimentos] = React.useState([]);
    const [isLoading, setIsLoading] = React.useState(false);

    const [showForm, setShowForm] = React.useState(false);
    const initialFormState = { data_hora_inicio: '', placa: '', volume: '', custo_total: '', cod_posto: '', cod_frentista: '' };
    const [formData, setFormData] = React.useState(initialFormState);

    const [file, setFile] = React.useState(null);
    const [isImporting, setIsImporting] = React.useState(false);

    const [filters, setFilters] = React.useState({ placa: '', data: '', cod_posto: '' });
    const [hasSearched, setHasSearched] = React.useState(false);

    const formatDate = (dateString) => {
        if (!dateString) return '—';
        const date = new Date(dateString);
        return date.toLocaleString('pt-BR');
    };

    const handleFilterChange = (e) => {
        setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
    };

    const handleSearch = async () => {
        setHasSearched(true);
        setIsLoading(true);
        try {
            let query = supabase.from('cta_abastecimentos').select('*');
            if (filters.placa) query = query.ilike('placa', `%${filters.placa.trim()}%`);
            if (filters.cod_posto) query = query.eq('cod_posto', filters.cod_posto.trim());
            if (filters.data) {
                const startDate = `${filters.data}T00:00:00`;
                const endDate = `${filters.data}T23:59:59`;
                query = query.gte('data_hora_inicio', startDate).lte('data_hora_inicio', endDate);
            }
            query = query.order('data_hora_inicio', { ascending: false });
            const { data, error } = await query;
            if (error) throw error;
            setAbastecimentos(data || []);
        } catch (err) {
            showToast("Erro ao buscar abastecimentos.", "error");
        }
        setIsLoading(false);
    };

    const handleInputChange = (e) => {
        setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
    };

    const handleFormSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            const recordToInsert = {
                ...formData,
                custo_total: parseFloat(formData.custo_total),
                volume: parseFloat(formData.volume),
                usuario_criacao: user.nome,
                data_criacao: new Date().toISOString(),
            };
            const { error } = await supabase.from('cta_abastecimentos').insert([recordToInsert]);
            if (error) throw error;
            showToast("Abastecimento registrado com sucesso!", "success");
            setFormData(initialFormState);
            setShowForm(false);
            handleSearch();
        } catch (err) {
            showToast(`Erro ao registrar: ${err.message}`, "error");
        }
        setIsLoading(false);
    };

    const handleFileChange = (e) => {
        if (e.target.files && e.target.files[0]) {
            setFile(e.target.files[0]);
        }
    };

    const handleImport = () => {
        if (!file) { return showToast("Por favor, selecione um arquivo.", "error"); }
        setIsImporting(true);
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                const dataToInsert = json.slice(0, -1).map(row => {
                    const excelDate = row['Data/Hora início'];
                    let finalDate = null;
                    
                    // CORREÇÃO DEFINITIVA: Lógica de data mais robusta para vários formatos
                    if (excelDate) {
                        let d;
                        if (excelDate instanceof Date) {
                            d = excelDate; // Se já for um objeto Date, ótimo.
                        } else if (typeof excelDate === 'number' && excelDate > 1) {
                            // Converte do formato numérico do Excel
                            d = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
                        } else if (typeof excelDate === 'string') {
                            // Tenta converter de formatos de texto comuns, como DD/MM/YYYY HH:mm:ss
                            const parts = excelDate.match(/(\d+)/g);
                            if (parts && parts.length >= 5) { // Dia, Mês, Ano, Hora, Minuto
                                // Formato: Ano, Mês-1, Dia, Hora, Minuto, Segundo
                                d = new Date(parts[2], parts[1] - 1, parts[0], parts[3], parts[4], parts[5] || 0);
                            }
                        }

                        // Se a conversão resultou em uma data válida, formata para o Supabase
                        if (d && !isNaN(d.getTime())) {
                            finalDate = d.toISOString();
                        }
                    }

                    return {
                        data_hora_inicio: finalDate,
                        placa: row['Placa'],
                        volume: parseFloat(row['Volume (l)']) || 0,
                        custo_total: parseFloat(row['Custo Total (R$)']) || 0,
                        cod_posto: row['Cod. do Posto'],
                        cod_frentista: row['Cod. do Frentista'],
                        usuario_criacao: user.nome,
                        data_criacao: new Date().toISOString(),
                    };
                });

                if (dataToInsert.length === 0) {
                    showToast("Nenhum dado válido encontrado na planilha.", "info");
                    setIsImporting(false);
                    return;
                }
                
                const { error } = await supabase.from('cta_abastecimentos').insert(dataToInsert, { returning: 'minimal' });
                if (error) { console.error("Erro do Supabase:", error); throw error; }

                showToast(`${dataToInsert.length} registros importados com sucesso!`, "success");
                setFile(null); 
                document.getElementById('file-input-cta-abs').value = '';
                setHasSearched(false);
                setAbastecimentos([]);
            } catch (err) {
                showToast(`Erro ao processar o arquivo: ${err.message}`, "error");
            }
            setIsImporting(false);
        };
        reader.readAsArrayBuffer(file);
    };


    return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "CTA Abastecimentos"),
        
        React.createElement('div', { className: "flex justify-end mb-4" },
            React.createElement('button', { onClick: () => setShowForm(!showForm), className: "p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center" }, 
                React.createElement(LucideIcon, { name: 'PlusCircle', className: 'mr-2 h-5 w-5' }),
                showForm ? "Fechar Formulário" : "Novo Abastecimento"
            )
        ),

        showForm && React.createElement('form', { onSubmit: handleFormSubmit, className: "grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-4 border rounded-lg bg-gray-50" },
            React.createElement('input', { name: "placa", value: formData.placa, onChange: handleInputChange, placeholder: "Placa", className: "p-2 border rounded" }),
            React.createElement('input', { name: "cod_posto", value: formData.cod_posto, onChange: handleInputChange, placeholder: "Cód. Posto", className: "p-2 border rounded" }),
            React.createElement('input', { name: "cod_frentista", value: formData.cod_frentista, onChange: handleInputChange, placeholder: "Cód. Frentista", className: "p-2 border rounded" }),
            React.createElement('input', { name: "volume", type: "number", step: "0.01", value: formData.volume, onChange: handleInputChange, placeholder: "Volume (l)", className: "p-2 border rounded" }),
            React.createElement('input', { name: "custo_total", type: "number", step: "0.01", value: formData.custo_total, onChange: handleInputChange, placeholder: "Custo Total (R$)", className: "p-2 border rounded" }),
            React.createElement('input', { name: "data_hora_inicio", type: "datetime-local", value: formData.data_hora_inicio, onChange: handleInputChange, className: "p-2 border rounded" }),
            React.createElement('div', { className: "md:col-span-3 flex justify-end gap-4" },
                React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "py-2 px-4 bg-gray-300 rounded-lg" }, "Cancelar"),
                React.createElement('button', { type: "submit", className: "py-2 px-4 bg-blue-600 text-white rounded-lg", disabled: isLoading }, isLoading ? 'Salvando...' : 'Salvar')
            )
        ),

        React.createElement('div', { className: "mb-8 p-4 border rounded-lg bg-gray-100 grid grid-cols-1 md:grid-cols-2 gap-4 items-end" },
            React.createElement('div', null,
                React.createElement('label', { htmlFor: 'file-input-cta-abs', className: "block text-sm font-medium text-gray-700 mb-1" }, "Importar Planilha"),
                React.createElement('input', { id: 'file-input-cta-abs', type: "file", onChange: handleFileChange, className: "w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100", accept: ".xlsx, .xls, .csv" })
            ),
            React.createElement('button', { onClick: handleImport, disabled: isImporting, className: "w-full p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition" }, isImporting ? 'Importando...' : 'Importar Dados')
        ),

        React.createElement('div', { className: "mb-6 p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end" },
            React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "Placa"), React.createElement('input', { type: "text", name: "placa", value: filters.placa, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
            React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "Data"), React.createElement('input', { type: "date", name: "data", value: filters.data, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
            React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "Cód. do Posto"), React.createElement('input', { type: "text", name: "cod_posto", value: filters.cod_posto, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
            React.createElement('button', { onClick: handleSearch, disabled: isLoading, className: "w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition" }, isLoading ? 'Buscando...' : 'Buscar')
        ),

        React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
            React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                    React.createElement('tr', null,
                        ["Data/Hora", "Placa", "Volume (l)", "Custo Total", "Cód. Posto"].map(h => React.createElement('th', { key: h, className: "px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0" }, h))
                    )
                ),
                React.createElement('tbody', null,
                    isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-4 text-center" }, "Carregando...")) :
                    !hasSearched ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-6 text-center text-slate-500" }, "Utilize os filtros para buscar os abastecimentos.")) :
                    abastecimentos.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-6 text-center text-slate-500" }, "Nenhum resultado encontrado.")) :
                    abastecimentos.map(item => React.createElement('tr', { key: item.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, formatDate(item.data_hora_inicio)),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, React.createElement('span', { className: 'font-medium text-slate-800' }, item.placa)),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.volume),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, `R$ ${(item.custo_total || 0).toFixed(2).replace('.', ',')}`),
                        React.createElement('td', { className: "px-6 py-4" }, item.cod_posto)
                    ))
                )
            )
        )
    );
}
/* INÍCIO DO CÓDIGO ATUALIZADO PARA TicketAbastecimentos */

function TicketAbastecimentos({ user, showToast }) {
    const [abastecimentos, setAbastecimentos] = React.useState([]);
    const [isLoading, setIsLoading] = React.useState(false);
    
    const [file, setFile] = React.useState(null);
    const [isImporting, setIsImporting] = React.useState(false);

    const [filters, setFilters] = React.useState({ placa: '', data: '', cidade: '', nome_estabelecimento: '' });
    const [hasSearched, setHasSearched] = React.useState(false);

    const formatDate = (dateString) => {
        if (!dateString) return '—';
        const date = new Date(dateString);
        return date.toLocaleString('pt-BR');
    };

    const handleFilterChange = (e) => {
        const { name, value } = e.target;
        setFilters(prev => ({ ...prev, [name]: value }));
    };

    const handleSearch = async () => {
        setHasSearched(true);
        setIsLoading(true);
        try {
            let query = supabase.from('ticket_abastecimentos').select('*');

            if (filters.placa) query = query.ilike('placa', `%${filters.placa.trim()}%`);
            if (filters.cidade) query = query.ilike('cidade', `%${filters.cidade.trim()}%`);
            if (filters.nome_estabelecimento) query = query.ilike('nome_estabelecimento', `%${filters.nome_estabelecimento.trim()}%`);
            if (filters.data) {
                const startDate = `${filters.data}T00:00:00`;
                const endDate = `${filters.data}T23:59:59`;
                query = query.gte('data_transacao', startDate).lte('data_transacao', endDate);
            }
            
            query = query.order('data_transacao', { ascending: false });

            const { data, error } = await query;
            if (error) throw error;
            setAbastecimentos(data || []);

        } catch (err) {
            showToast("Erro ao buscar abastecimentos.", "error");
        }
        setIsLoading(false);
    };

    const handleFileChange = (e) => {
        if (e.target.files && e.target.files[0]) {
            setFile(e.target.files[0]);
        }
    };

    const handleImport = () => {
        if (!file) { return showToast("Por favor, selecione um arquivo.", "error"); }
        setIsImporting(true);
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                // CORREÇÃO: Adicionado .slice(0, -1) para ignorar a última linha (Total) da planilha
                const dataToInsert = json.slice(0, -1).map(row => {
                    const transacaoDate = row['DATA TRANSACAO'];
                    return {
                        codigo_transacao: row['CODIGO TRANSACAO'],
                        servico: row['SERVICO'],
                        data_transacao: transacaoDate instanceof Date ? transacaoDate.toISOString() : null,
                        placa: row['PLACA'],
                        tipo_combustivel: row['TIPO COMBUSTIVEL'],
                        litros: parseFloat(row['LITROS']) || 0,
                        vl_litro: parseFloat(row['VL/LITRO']) || 0,
                        valor_emissao: parseFloat(row['VALOR EMISSAO']) || 0,
                        nome_estabelecimento: row['NOME ESTABELECIMENTO'],
                        cidade: row['CIDADE'],
                        uf: row['UF'],
                        info_adicional1: row['INFORMACAO ADICIONAL 1'],
                        numero_cartao: row['NUMERO CARTAO'],
                        usuario_criacao: user.nome,
                        data_criacao: new Date().toISOString(),
                    };
                });


                if (dataToInsert.length === 0) {
                    showToast("Nenhum dado válido encontrado na planilha (ignorando a linha de total).", "info");
                    setIsImporting(false);
                    return;
                }
                
                const { error } = await supabase.from('ticket_abastecimentos').insert(dataToInsert, { returning: 'minimal' });

                if (error) {
                    console.error("Erro do Supabase:", error);
                    throw error;
                }

                showToast(`${dataToInsert.length} registros importados com sucesso!`, "success");
                setFile(null); 
                document.getElementById('file-input-ticket').value = '';
                setHasSearched(false);
                setAbastecimentos([]);

            } catch (err) {
                showToast(`Erro ao processar o arquivo: ${err.message}`, "error");
            }
            setIsImporting(false);
        };
        reader.readAsArrayBuffer(file);
    };

    return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Ticket Abastecimentos"),
        
        React.createElement('div', { className: "mb-8 p-4 border rounded-lg bg-gray-100 grid grid-cols-1 md:grid-cols-2 gap-4 items-end" },
            React.createElement('div', null,
                React.createElement('label', { htmlFor: 'file-input-ticket', className: "block text-sm font-medium text-gray-700 mb-1" }, "Importar Planilha de Transações"),
                React.createElement('input', { id: 'file-input-ticket', type: "file", onChange: handleFileChange, className: "w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100", accept: ".xlsx, .xls, .csv" })
            ),
            React.createElement('button', { onClick: handleImport, disabled: isImporting, className: "w-full p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition" }, isImporting ? 'Importando...' : 'Importar Dados')
        ),

        React.createElement('div', { className: "mb-6 p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end" },
            React.createElement('div', null,
                React.createElement('label', { className: "block text-sm font-medium" }, "Placa"),
                React.createElement('input', { type: "text", name: "placa", value: filters.placa, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })
            ),
            React.createElement('div', null,
                React.createElement('label', { className: "block text-sm font-medium" }, "Data"),
                React.createElement('input', { type: "date", name: "data", value: filters.data, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })
            ),
            React.createElement('div', null,
                React.createElement('label', { className: "block text-sm font-medium" }, "Cidade"),
                React.createElement('input', { type: "text", name: "cidade", value: filters.cidade, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })
            ),
            React.createElement('div', null,
                React.createElement('label', { className: "block text-sm font-medium" }, "Estabelecimento"),
                React.createElement('input', { type: "text", name: "nome_estabelecimento", value: filters.nome_estabelecimento, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })
            ),
            React.createElement('button', { onClick: handleSearch, disabled: isLoading, className: "w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition" }, isLoading ? 'Buscando...' : 'Buscar')
        ),

        React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
            React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                    React.createElement('tr', null,
                        ["Data", "Placa", "Estabelecimento", "Combustível", "Litros", "Vl/Litro", "Valor Total"].map(h => 
                            React.createElement('th', { key: h, className: "px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0" }, h)
                        )
                    )
                ),
                React.createElement('tbody', null,
                    isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-4 text-center" }, "Carregando...")) :
                    !hasSearched ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-6 text-center text-slate-500" }, "Utilize os filtros acima para buscar os abastecimentos.")) :
                    abastecimentos.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 7, className: "p-6 text-center text-slate-500" }, "Nenhum resultado encontrado para sua busca.")) :
                    abastecimentos.map(item => React.createElement('tr', { key: item.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, formatDate(item.data_transacao)),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, 
                            React.createElement('span', { className: 'font-medium text-slate-800' }, item.placa)
                        ),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.nome_estabelecimento),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.tipo_combustivel),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.litros),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, `R$ ${(item.vl_litro || 0).toFixed(2).replace('.', ',')}`),
                        React.createElement('td', { className: "px-6 py-4" }, `R$ ${(item.valor_emissao || 0).toFixed(2).replace('.', ',')}`)
                    ))
                )
            )
        )
    );
}

/* INÍCIO DA VERSÃO DE DEBUG COMPLETA PARA CtaAbastecimentos */

function CtaAbastecimentos({ user, showToast }) {
    const [abastecimentos, setAbastecimentos] = React.useState([]);
    const [isLoading, setIsLoading] = React.useState(false);

    const [showForm, setShowForm] = React.useState(false);
    const initialFormState = { data_hora_inicio: '', placa: '', volume: '', custo_total: '', cod_posto: '', cod_frentista: '' };
    const [formData, setFormData] = React.useState(initialFormState);

    const [file, setFile] = React.useState(null);
    const [isImporting, setIsImporting] = React.useState(false);

    const [filters, setFilters] = React.useState({ placa: '', data: '', cod_posto: '' });
    const [hasSearched, setHasSearched] = React.useState(false);

    const formatDate = (dateString) => {
        if (!dateString) return '—';
        const date = new Date(dateString);
        return date.toLocaleString('pt-BR');
    };

    const handleFilterChange = (e) => {
        setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
    };

    const handleSearch = async () => {
        setHasSearched(true);
        setIsLoading(true);
        try {
            let query = supabase.from('cta_abastecimentos').select('*');
            if (filters.placa) query = query.ilike('placa', `%${filters.placa.trim()}%`);
            if (filters.cod_posto) query = query.eq('cod_posto', filters.cod_posto.trim());
            if (filters.data) {
                const startDate = `${filters.data}T00:00:00`;
                const endDate = `${filters.data}T23:59:59`;
                query = query.gte('data_hora_inicio', startDate).lte('data_hora_inicio', endDate);
            }
            query = query.order('data_hora_inicio', { ascending: false });
            const { data, error } = await query;
            if (error) throw error;
            setAbastecimentos(data || []);
        } catch (err) {
            showToast("Erro ao buscar abastecimentos.", "error");
        }
        setIsLoading(false);
    };

    const handleInputChange = (e) => {
        setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
    };

    const handleFormSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            const recordToInsert = {
                ...formData,
                custo_total: parseFloat(formData.custo_total),
                volume: parseFloat(formData.volume),
                usuario_criacao: user.nome,
                data_criacao: new Date().toISOString(),
            };
            const { error } = await supabase.from('cta_abastecimentos').insert([recordToInsert]);
            if (error) throw error;
            showToast("Abastecimento registrado com sucesso!", "success");
            setFormData(initialFormState);
            setShowForm(false);
            handleSearch();
        } catch (err) {
            showToast(`Erro ao registrar: ${err.message}`, "error");
        }
        setIsLoading(false);
    };

    const handleFileChange = (e) => {
        if (e.target.files && e.target.files[0]) {
            setFile(e.target.files[0]);
        }
    };

    const handleImport = () => {
        if (!file) { return showToast("Por favor, selecione um arquivo.", "error"); }
        setIsImporting(true);
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                const dataToInsert = json.slice(0, -1).map(row => {
                    // ================================================================
                    // LINHA DE DEBUG PARA A DATA
                    console.log("VALOR BRUTO DA DATA NA PLANILHA:", row['Data/Hora início']);
                    // ================================================================
                    
                    const excelDate = row['Data/Hora início'];
                    let finalDate = null;
                    
                    if (excelDate) {
                        let d;
                        if (excelDate instanceof Date) {
                            d = excelDate;
                        } else if (typeof excelDate === 'number' && excelDate > 1) {
                            d = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
                        } else if (typeof excelDate === 'string') {
                            const parts = excelDate.match(/(\d+)/g);
                            if (parts && parts.length >= 5) {
                                d = new Date(parts[2], parts[1] - 1, parts[0], parts[3], parts[4], parts[5] || 0);
                            }
                        }
                        if (d && !isNaN(d.getTime())) {
                            finalDate = d.toISOString();
                        }
                    }

                    return {
                        data_hora_inicio: finalDate,
                        placa: row['Placa'],
                        volume: parseFloat(row['Volume (l)']) || 0,
                        custo_total: parseFloat(row['Custo Total (R$)']) || 0,
                        cod_posto: row['Cod. do Posto'],
                        cod_frentista: row['Cod. do Frentista'],
                        usuario_criacao: user.nome,
                        data_criacao: new Date().toISOString(),
                    };
                });

                if (dataToInsert.length === 0) {
                    showToast("Nenhum dado válido encontrado na planilha.", "info");
                    setIsImporting(false);
                    return;
                }
                
                const { error } = await supabase.from('cta_abastecimentos').insert(dataToInsert, { returning: 'minimal' });
                if (error) { console.error("Erro do Supabase:", error); throw error; }

                showToast(`${dataToInsert.length} registros importados com sucesso!`, "success");
                setFile(null); 
                document.getElementById('file-input-cta-abs').value = '';
                setHasSearched(false);
                setAbastecimentos([]);
            } catch (err) {
                showToast(`Erro ao processar o arquivo: ${err.message}`, "error");
            }
            setIsImporting(false);
        };
        reader.readAsArrayBuffer(file);
    };


    return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "CTA Abastecimentos"),
        
        React.createElement('div', { className: "flex justify-end mb-4" },
            React.createElement('button', { onClick: () => setShowForm(!showForm), className: "p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center" }, 
                React.createElement(LucideIcon, { name: 'PlusCircle', className: 'mr-2 h-5 w-5' }),
                showForm ? "Fechar Formulário" : "Novo Abastecimento"
            )
        ),

        showForm && React.createElement('form', { onSubmit: handleFormSubmit, className: "grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-4 border rounded-lg bg-gray-50" },
            React.createElement('input', { name: "placa", value: formData.placa, onChange: handleInputChange, placeholder: "Placa", className: "p-2 border rounded" }),
            React.createElement('input', { name: "cod_posto", value: formData.cod_posto, onChange: handleInputChange, placeholder: "Cód. Posto", className: "p-2 border rounded" }),
            React.createElement('input', { name: "cod_frentista", value: formData.cod_frentista, onChange: handleInputChange, placeholder: "Cód. Frentista", className: "p-2 border rounded" }),
            React.createElement('input', { name: "volume", type: "number", step: "0.01", value: formData.volume, onChange: handleInputChange, placeholder: "Volume (l)", className: "p-2 border rounded" }),
            React.createElement('input', { name: "custo_total", type: "number", step: "0.01", value: formData.custo_total, onChange: handleInputChange, placeholder: "Custo Total (R$)", className: "p-2 border rounded" }),
            React.createElement('input', { name: "data_hora_inicio", type: "datetime-local", value: formData.data_hora_inicio, onChange: handleInputChange, className: "p-2 border rounded" }),
            React.createElement('div', { className: "md:col-span-3 flex justify-end gap-4" },
                React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "py-2 px-4 bg-gray-300 rounded-lg" }, "Cancelar"),
                React.createElement('button', { type: "submit", className: "py-2 px-4 bg-blue-600 text-white rounded-lg", disabled: isLoading }, isLoading ? 'Salvando...' : 'Salvar')
            )
        ),

        React.createElement('div', { className: "mb-8 p-4 border rounded-lg bg-gray-100 grid grid-cols-1 md:grid-cols-2 gap-4 items-end" },
            React.createElement('div', null,
                React.createElement('label', { htmlFor: 'file-input-cta-abs', className: "block text-sm font-medium text-gray-700 mb-1" }, "Importar Planilha"),
                React.createElement('input', { id: 'file-input-cta-abs', type: "file", onChange: handleFileChange, className: "w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100", accept: ".xlsx, .xls, .csv" })
            ),
            React.createElement('button', { onClick: handleImport, disabled: isImporting, className: "w-full p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition" }, isImporting ? 'Importando...' : 'Importar Dados')
        ),

        React.createElement('div', { className: "mb-6 p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end" },
            React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "Placa"), React.createElement('input', { type: "text", name: "placa", value: filters.placa, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
            React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "Data"), React.createElement('input', { type: "date", name: "data", value: filters.data, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
            React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium" }, "Cód. do Posto"), React.createElement('input', { type: "text", name: "cod_posto", value: filters.cod_posto, onChange: handleFilterChange, className: "mt-1 w-full p-2 border rounded" })),
            React.createElement('button', { onClick: handleSearch, disabled: isLoading, className: "w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition" }, isLoading ? 'Buscando...' : 'Buscar')
        ),

        React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
            React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                    React.createElement('tr', null,
                        ["Data/Hora", "Placa", "Volume (l)", "Custo Total", "Cód. Posto"].map(h => React.createElement('th', { key: h, className: "px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0" }, h))
                    )
                ),
                React.createElement('tbody', null,
                    isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-4 text-center" }, "Carregando...")) :
                    !hasSearched ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-6 text-center text-slate-500" }, "Utilize os filtros para buscar os abastecimentos.")) :
                    abastecimentos.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-6 text-center text-slate-500" }, "Nenhum resultado encontrado.")) :
                    abastecimentos.map(item => React.createElement('tr', { key: item.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, formatDate(item.data_hora_inicio)),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, React.createElement('span', { className: 'font-medium text-slate-800' }, item.placa)),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.volume),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, `R$ ${(item.custo_total || 0).toFixed(2).replace('.', ',')}`),
                        React.createElement('td', { className: "px-6 py-4" }, item.cod_posto)
                    ))
                )
            )
        )
    );
}

/* FIM DA VERSÃO DE DEBUG */

            // --- ESQUELETO: Aferições ---
            function Afericoes({ user, showToast }) {
                // TODO: Adicionar estados e lógica para visualização
                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Aferições de Tanques"),
                    React.createElement('p', { className: "text-center" }, "Tabela de resultados e comparativo visual (em desenvolvimento).")
                );
            }

            /* INÍCIO DO NOVO COMPONENTE CadastroFiliais */

function CadastroFiliais({ user, showToast }) {
    const [filiais, setFiliais] = React.useState([]);
    const [isLoading, setIsLoading] = React.useState(true);
    const [showForm, setShowForm] = React.useState(false);
    const [isEditing, setIsEditing] = React.useState(false);
    const [currentFilial, setCurrentFilial] = React.useState(null);

    const initialFormState = { nome_filial: '', centro_de_custo_final: '', cta_cod_posto: '', ticket_info_adicional1: '', shell_cnpj: '' };
    const [formData, setFormData] = React.useState(initialFormState);

    const fetchFiliais = React.useCallback(async () => {
        setIsLoading(true);
        try {
            const { data, error } = await supabase.from('filiais').select('*').order('nome_filial');
            if (error) throw error;
            setFiliais(data || []);
        } catch (err) {
            showToast("Erro ao carregar filiais.", "error");
        }
        setIsLoading(false);
    }, [showToast]);

    React.useEffect(() => {
        fetchFiliais();
    }, [fetchFiliais]);

    const handleInputChange = (e) => {
        setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
    };

    const handleFormSubmit = async (e) => {
        e.preventDefault();
        if (!formData.nome_filial.trim() || !formData.centro_de_custo_final.trim()) {
            showToast("Preencha os campos obrigatórios (Nome da Filial e Centro de Custo).", "error");
            return;
        }
        setIsLoading(true);
        try {
            const record = {
                nome_filial: formData.nome_filial.trim(),
                centro_de_custo_final: formData.centro_de_custo_final.trim(),
                cta_cod_posto: formData.cta_cod_posto.trim() || null,
                ticket_info_adicional1: formData.ticket_info_adicional1.trim() || null,
                shell_cnpj: formData.shell_cnpj.trim() || null,
            };

            if (isEditing) {
                const { error } = await supabase.from('filiais').update(record).eq('id', currentFilial.id);
                if (error) throw error;
                showToast("Mapeamento atualizado com sucesso!", "success");
            } else {
                const { error } = await supabase.from('filiais').insert([{ ...record, usuario_criacao: user.nome }]);
                if (error) throw error;
                showToast("Novo mapeamento criado com sucesso!", "success");
            }
            setShowForm(false);
            setIsEditing(false);
            setFormData(initialFormState);
            fetchFiliais();
        } catch (err) {
            showToast(`Erro ao salvar: ${err.message}`, "error");
        }
        setIsLoading(false);
    };

    const handleEditClick = (filial) => {
        setIsEditing(true);
        setCurrentFilial(filial);
        setFormData({
            nome_filial: filial.nome_filial || '',
            centro_de_custo_final: filial.centro_de_custo_final || '',
            cta_cod_posto: filial.cta_cod_posto || '',
            ticket_info_adicional1: filial.ticket_info_adicional1 || '',
            shell_cnpj: filial.shell_cnpj || ''
        });
        setShowForm(true);
    };
    
    // (Opcional: Adicionar lógica de delete se necessário, similar a outros componentes)

    return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Cadastro de Filiais (DE/PARA)"),
        
        !showForm && React.createElement('div', { className: 'flex justify-center mb-6' },
            React.createElement('button', {
                onClick: () => { setShowForm(true); setIsEditing(false); setFormData(initialFormState); },
                className: "p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center"
            }, React.createElement(LucideIcon, { name: 'PlusCircle', className: 'mr-2 h-5 w-5' }), "Novo Mapeamento")
        ),

        showForm && React.createElement('form', { onSubmit: handleFormSubmit, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8 p-4 border rounded-lg bg-gray-50" },
            React.createElement('input', { name: "nome_filial", value: formData.nome_filial, onChange: handleInputChange, placeholder: "Nome da Filial*", className: "p-2 border rounded" }),
            React.createElement('input', { name: "centro_de_custo_final", value: formData.centro_de_custo_final, onChange: handleInputChange, placeholder: "Centro de Custo Final*", className: "p-2 border rounded" }),
            React.createElement('input', { name: "cta_cod_posto", value: formData.cta_cod_posto, onChange: handleInputChange, placeholder: "Cód. Posto (CTA)", className: "p-2 border rounded" }),
            React.createElement('input', { name: "ticket_info_adicional1", value: formData.ticket_info_adicional1, onChange: handleInputChange, placeholder: "Info Adicional 1 (Ticket)", className: "p-2 border rounded" }),
            React.createElement('input', { name: "shell_cnpj", value: formData.shell_cnpj, onChange: handleInputChange, placeholder: "CNPJ (Shell)", className: "p-2 border rounded" }),
            React.createElement('div', { className: "md:col-span-full flex justify-end gap-4" },
                React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "py-2 px-4 bg-gray-300 rounded-lg" }, "Cancelar"),
                React.createElement('button', { type: "submit", className: "py-2 px-4 bg-blue-600 text-white rounded-lg", disabled: isLoading }, isLoading ? 'Salvando...' : 'Salvar')
            )
        ),

        React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
            React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" },
                    React.createElement('tr', null,
                        ["Filial", "Centro de Custo", "Cód. Posto (CTA)", "Info (Ticket)", "CNPJ (Shell)", "Ações"].map(h => 
                            React.createElement('th', { key: h, className: "px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0" }, h)
                        )
                    )
                ),
                React.createElement('tbody', null,
                    isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 6, className: "p-4 text-center" }, "Carregando...")) :
                    filiais.map(item => React.createElement('tr', { key: item.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, React.createElement('span', { className: 'font-medium text-slate-800' }, item.nome_filial)),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.centro_de_custo_final),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.cta_cod_posto),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.ticket_info_adicional1),
                        React.createElement('td', { className: "px-6 py-4 border-r border-slate-200" }, item.shell_cnpj),
                        React.createElement('td', { className: "px-6 py-4 text-center" }, 
                            React.createElement('button', {onClick:()=>handleEditClick(item), className:"text-gray-400 hover:text-blue-600 transition-colors"}, 
                                React.createElement(LucideIcon, {name:'Edit', className: 'h-5 w-5'})
                            )
                        )
                    ))
                )
            )
        )
    );
}

/* FIM DO NOVO COMPONENTE */
            // --- ESQUELETO: User Management ---
            /* INÍCIO DO CÓDIGO ATUALIZADO PARA UserManagement */

function UserManagement({ user, showToast }) {
    const [usersList, setUsersList] = React.useState([]);
    const [isLoading, setIsLoading] = React.useState(false);
    const [showForm, setShowForm] = React.useState(false);

    const initialFormState = { nome: '', usuario: '', senha: '', nivel_permissao: 'user' };
    const [formData, setFormData] = React.useState(initialFormState);
    
    const [showConfirmModal, setShowConfirmModal] = React.useState(false);
    const [userToDelete, setUserToDelete] = React.useState(null);
    const permissionLevels = ['administrador', 'user'];

    const getRoleBadge = (role) => {
        const baseClasses = "inline-flex items-center py-1 px-3 rounded-full text-xs font-medium capitalize";
        switch (role) {
            case 'administrador': return React.createElement('span', { className: `bg-red-100 text-red-800 ${baseClasses}` }, role);
            case 'user': default: return React.createElement('span', { className: `bg-gray-100 text-gray-800 ${baseClasses}` }, role);
        }
    };

    const fetchUsers = React.useCallback(async () => {
        setIsLoading(true);
        try {
            const { data, error } = await supabase.from('usuarios').select('*').order('data_criacao', { ascending: false });
            if (error) throw error;
            setUsersList(data || []);
        } catch (e) {
            showToast("Erro ao carregar usuários.", "error");
        }
        setIsLoading(false);
    }, [showToast]);

    React.useEffect(() => {
        fetchUsers();
    }, [fetchUsers]);
    
    const handleInputChange = (e) => {
        setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
    };

    const handleAddUser = async (e) => {
        e.preventDefault();
        if (!formData.nome.trim() || !formData.usuario.trim() || !formData.senha.trim()) { 
            showToast("Preencha todos os campos obrigatórios.", "error");
            return; 
        }
        setIsLoading(true);
        try {
            const { data: existing } = await supabase.from('usuarios').select('usuario').eq('usuario', formData.usuario.trim().toLowerCase());
            if (existing && existing.length > 0) { 
                showToast("Nome de usuário já existe.", "error");
                setIsLoading(false); 
                return; 
            }
            const { error } = await supabase.from('usuarios').insert([{ 
                nome: formData.nome.trim(), 
                usuario: formData.usuario.trim().toLowerCase(), 
                senha: formData.senha, // Senha não é convertida para minúsculas
                nivel_permissao: formData.nivel_permissao,
                usuario_criacao: user.nome
            }]);
            if (error) throw error;

            showToast("Usuário adicionado com sucesso!", "success");
            setFormData(initialFormState);
            setShowForm(false);
            fetchUsers();
        } catch(e) {
            showToast("Erro ao adicionar usuário.", "error");
        }
        setIsLoading(false);
    };

    const confirmDeleteUser = (user) => { 
        setUserToDelete(user); 
        setShowConfirmModal(true); 
    };

    const handleDeleteUser = async () => {
        if (!userToDelete) return;
        setIsLoading(true);
        try {
            const { error } = await supabase.from('usuarios').delete().eq('id', userToDelete.id);
            if (error) throw error;
            showToast("Usuário excluído com sucesso!", "success");
            fetchUsers();
        } catch(e) {
            showToast("Erro ao excluir usuário.", "error");
        }
        setIsLoading(false);
        setShowConfirmModal(false);
        setUserToDelete(null);
    };

    return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Gerenciamento de Usuários"),
        
        !showForm && React.createElement('div', { className: 'flex justify-center mb-6' },
            React.createElement('button', {
                onClick: () => setShowForm(true),
                className: "p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center"
            }, React.createElement(LucideIcon, { name: 'PlusCircle', className: 'mr-2 h-5 w-5' }), "Novo Usuário")
        ),

        showForm && React.createElement('form', { onSubmit: handleAddUser, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 p-4 border rounded-lg bg-gray-50" },
            React.createElement('input', { name: "nome", value: formData.nome, onChange: handleInputChange, placeholder: "Nome Completo*", className: "p-2 border rounded" }),
            React.createElement('input', { name: "usuario", value: formData.usuario, onChange: handleInputChange, placeholder: "Usuário (para login)*", className: "p-2 border rounded" }),
            React.createElement('input', { name: "senha", type: "password", value: formData.senha, onChange: handleInputChange, placeholder: "Senha*", className: "p-2 border rounded" }),
            React.createElement('select', { name: "nivel_permissao", value: formData.nivel_permissao, onChange: handleInputChange, className: "p-2 border rounded" }, 
                permissionLevels.map(r => React.createElement('option', { key: r, value: r }, r.charAt(0).toUpperCase() + r.slice(1)))
            ),
            React.createElement('div', { className: "lg:col-span-4 flex justify-end gap-4" },
                React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "py-2 px-4 bg-gray-300 rounded-lg" }, "Cancelar"),
                React.createElement('button', { type: "submit", className: "py-2 px-4 bg-blue-600 text-white rounded-lg", disabled: isLoading }, isLoading ? 'Salvando...' : 'Salvar')
            )
        ),
        
        React.createElement('div', { className: "rounded-lg border border-slate-200 shadow-sm overflow-hidden" },
            React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-100" }, 
                    React.createElement('tr', null, 
                        ["Usuário", "Nome Completo", "Nível de Permissão", "Data Criação", "Ações"].map(h => React.createElement('th',{key:h, className:"px-6 py-4 font-semibold border-b border-r border-slate-200 last:border-r-0"},h))
                    )
                ),
                React.createElement('tbody', null, 
                    isLoading ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: "p-4 text-center" }, "Carregando...")) :
                    usersList.map(u => React.createElement('tr', { key: u.id, className: "hover:bg-blue-50 even:bg-slate-50" },
                        React.createElement('td', {className:"px-6 py-4 border-r border-slate-200"}, React.createElement('span', { className: 'font-medium text-slate-800' }, u.usuario)),
                        React.createElement('td', {className:"px-6 py-4 border-r border-slate-200"}, u.nome),
                        React.createElement('td', {className:"px-6 py-4 border-r border-slate-200"}, getRoleBadge(u.nivel_permissao)),
                        React.createElement('td', {className:"px-6 py-4 border-r border-slate-200"}, new Date(u.data_criacao).toLocaleDateString('pt-BR')),
                        React.createElement('td', {className:"px-6 py-4 text-center"}, 
                            React.createElement('button', { onClick: () => confirmDeleteUser(u), className: "text-gray-400 hover:text-red-600 transition-colors" }, 
                                React.createElement(LucideIcon, {name: 'Trash2', className: 'h-5 w-5'})
                            )
                        )
                    ))
                )
            )
        ),
        showConfirmModal && React.createElement(ConfirmationModal, { message: `Deseja realmente excluir o usuário "${userToDelete?.usuario}"?`, onConfirm: handleDeleteUser, onCancel: () => setShowConfirmModal(false) })
    );
}

/* FIM DO CÓDIGO ATUALIZADO */

            // ================================================================
            // 4. COMPONENTE PRINCIPAL (App)
            // ================================================================
 /* INÍCIO DO CÓDIGO FINAL E CORRIGIDO PARA A FUNÇÃO App */

function App() {
    const [user, setUser] = React.useState(() => {
        const savedUser = localStorage.getItem('userSession');
        return savedUser ? JSON.parse(savedUser) : null;
    });

    const [currentPage, setCurrentPage] = React.useState('dashboard');
    const [toast, setToast] = React.useState({ show: false, message: '', type: '' });
    const [isSidebarOpen, setIsSidebarOpen] = React.useState(false);
    const [openMenu, setOpenMenu] = React.useState('');
    const [isSidebarCollapsed, setIsSidebarCollapsed] = React.useState(false);

    const handleLogin = (userData) => {
        localStorage.setItem('userSession', JSON.stringify(userData));
        setUser(userData);
        setCurrentPage('dashboard');
    };

    const handleLogout = () => {
        localStorage.removeItem('userSession');
        setUser(null);
    };

    const showToast = (message, type = 'success') => setToast({ show: true, message, type });
    const closeToast = () => setToast({ show: false, message: '', type: '' });

    const toggleMenu = (menu) => {
        if (isSidebarCollapsed) {
            setIsSidebarCollapsed(false);
        } else {
            setOpenMenu(openMenu === menu ? '' : menu);
        }
    };

    const toggleSidebarCollapse = () => {
        setIsSidebarCollapsed(!isSidebarCollapsed);
        if (!isSidebarCollapsed) {
            setOpenMenu('');
        }
    };

    const renderPage = () => {
        switch (currentPage) {
            case 'dashboard': return React.createElement(Dashboard, { user, showToast });
            case 'ticketAbastecimentos': return React.createElement(TicketAbastecimentos, { user, showToast });
            case 'ctaAbastecimentos': return React.createElement(CtaAbastecimentos, { user, showToast });
            case 'ctaCarregamentos': return React.createElement(CtaCarregamentos, { user, showToast });
            case 'afericoes': return React.createElement(Afericoes, { user, showToast });
            case 'cadastroFiliais': return user.nivel_permissao === 'administrador' ? React.createElement(CadastroFiliais, { user, showToast }) : null;
            case 'userManagement': return React.createElement(UserManagement, { user, showToast });
            default: return React.createElement(Dashboard, { user, showToast });
        }
    };
    
    if (!user) {
        return React.createElement(LoginPage, { onLogin: handleLogin });
    }

    const MenuItem = ({ page, icon, text }) => {
       const isActive = currentPage === page;
       return React.createElement('li', null,
            React.createElement('button', {
               onClick: () => { setCurrentPage(page); setIsSidebarOpen(false); },
               className: `flex items-center w-full px-4 py-2 rounded-lg transition-colors ${isSidebarCollapsed ? 'justify-center' : ''} ${isActive ? 'bg-blue-600 text-white' : 'hover:bg-gray-700 text-gray-300'}`
            },
               React.createElement(LucideIcon, { name: icon, className: `h-5 w-5 flex-shrink-0 ${!isSidebarCollapsed && 'mr-3'}` }),
               !isSidebarCollapsed && React.createElement('span', {className: 'truncate'}, text)
           )
        );
    };
    
    const MenuCategory = ({ title, icon, children, menuKey }) => {
        const isOpen = openMenu === menuKey;
        return (
            React.createElement('li', { className: "mb-2" },
                React.createElement('button', {
                    onClick: () => toggleMenu(menuKey),
                    className: `flex items-center w-full px-4 py-2 rounded-lg transition-colors ${isSidebarCollapsed ? 'justify-center' : ''} ${!isSidebarCollapsed ? 'justify-between' : ''} ${isOpen && !isSidebarCollapsed ? 'bg-gray-700' : 'hover:bg-gray-700'} text-gray-200`
                },
                    React.createElement('span', {className: 'flex items-center truncate'},
                        React.createElement(LucideIcon, { name: icon, className: `h-5 w-5 flex-shrink-0 ${!isSidebarCollapsed && 'mr-3'}` }),
                        !isSidebarCollapsed && React.createElement('span', {className: 'truncate'}, title)
                    ),
                    !isSidebarCollapsed && React.createElement(LucideIcon, { name: isOpen ? "ChevronUp" : "ChevronDown", className: "h-5 w-5 flex-shrink-0" })
                ),
                !isSidebarCollapsed && isOpen && React.createElement('ul', { className: "ml-4 mt-2 space-y-2 border-l border-gray-700 pl-4" }, children)
            )
        );
    };

    return (
        React.createElement('div', { className: "flex min-h-screen bg-gray-100" },
            // ATUALIZADO: Ajuste de tamanho da barra lateral (w-72 e w-24)
            React.createElement('aside', { className: `fixed inset-y-0 left-0 bg-gray-800 text-white p-4 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition-all duration-300 z-30 flex flex-col ${isSidebarCollapsed ? 'w-24' : 'w-72'}` },
                
                React.createElement('div', { className: "flex items-center justify-center mb-8" },
                    React.createElement('img', { 
                        src: "https://ikypygpbdmoxozfmwewr.supabase.co/storage/v1/object/sign/logo/LOGO_TERSYS-removebg-preview%20(1)%20(1).png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9lMGJiMDk5Zi1jZmE5LTQ5Y2UtYjUwNy0wZmE2ZWZkYWYxOTIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJsb2dvL0xPR09fVEVSU1lTLXJlbW92ZWJnLXByZXZpZXcgKDEpICgxKS5wbmciLCJpYXQiOjE3NTkyMzU4NTYsImV4cCI6MjA3NDU5NTg1Nn0.R8XPKzBUjrjR3kcJijIvDaCGpGMlvyMKA6lsqiSOcEQ", 
                        alt: "Logo", 
                        // ATUALIZADO: Ajuste de tamanho do logo
                        className: `cursor-pointer transition-all duration-300 ${isSidebarCollapsed ? 'h-12 w-auto' : 'h-16 w-auto'}`,
                        onClick: () => setCurrentPage('dashboard') 
                    })
                ),
                
                React.createElement('nav', { className: "flex-grow" },
    React.createElement('ul', { className: "space-y-2" },
        React.createElement(MenuItem, { page: 'dashboard', icon: 'LayoutDashboard', text: 'Dashboard' }),
        
        React.createElement(MenuCategory, { title: "Importação", icon: "FileText", menuKey: "importacao" },
            React.createElement(MenuItem, { page: 'ticketAbastecimentos', icon: 'Ticket', text: 'Ticket Abastecimentos' }),
            React.createElement(MenuItem, { page: 'ctaAbastecimentos', icon: 'Fuel', text: 'CTA Abastecimentos' }),
            React.createElement(MenuItem, { page: 'ctaCarregamentos', icon: 'Ship', text: 'CTA Carregamentos' })
        ),
        
        React.createElement(MenuItem, { page: 'afericoes', icon: 'Beaker', text: 'Aferições' }),
        
        // ÍCONE ATUALIZADO: Trocado 'PlusCircle' por 'FileText'
        user.nivel_permissao === 'administrador' && React.createElement(MenuCategory, { title: "Cadastros", icon: "PlusCircle", menuKey: "cadastros" },
            React.createElement(MenuItem, { page: 'cadastroFiliais', icon: 'Building', text: 'Filiais (DE/PARA)' }),
            React.createElement(MenuItem, { page: 'userManagement', icon: 'Users', text: 'Usuários' })
        )
    )
),

                // GARANTIDO: Botão de recolher/expandir está aqui
                React.createElement('div', {className: 'mt-auto pt-4 border-t border-gray-700'},
                    React.createElement('button', { 
                        onClick: toggleSidebarCollapse, 
                        className: "w-full flex items-center p-3 rounded-lg text-gray-400 hover:bg-gray-700 justify-center mb-2" 
                    },
                        React.createElement(LucideIcon, { name: isSidebarCollapsed ? "ChevronsRight" : "ChevronsLeft", className: "w-6 h-6" })
                    ),
                    React.createElement('button', { 
                        onClick: handleLogout, 
                        className: `w-full flex items-center p-3 rounded-lg text-red-400 hover:bg-gray-700 ${isSidebarCollapsed ? 'justify-center' : ''}` 
                    },
                        React.createElement(LucideIcon, { name: "LogOut", className: `w-6 h-6 ${!isSidebarCollapsed && 'mr-3'}` }),
                        !isSidebarCollapsed && 'Sair'
                    )
                )
            ),
            
            React.createElement('main', { className: "flex-1 p-4 md:p-8 flex flex-col" },
                React.createElement('header', { className: "w-full bg-white p-4 rounded-xl shadow-lg mb-8 flex justify-between items-center" },
                    React.createElement('button', { className: "md:hidden text-gray-700 p-2", onClick: () => setIsSidebarOpen(true) }, React.createElement(LucideIcon, { name: "Menu" })),
                    React.createElement('div', { className: "text-right text-sm text-gray-600" },
                        React.createElement('p', null, "Usuário: ", React.createElement('strong', null, user.nome)),
                        React.createElement('p', {className: "capitalize"}, "Permissão: ", React.createElement('strong', null, user.nivel_permissao))
                    )
                ),
                React.createElement('div', { className: "flex-grow" }, renderPage()),
                toast.show && React.createElement(Toast, { message: toast.message, type: toast.type, onClose: closeToast })
            )
        )
    );
}

/* FIM DO CÓDIGO FINAL E CORRIGIDO */
            // ================================================================
            // 5. INICIALIZAÇÃO
            // ================================================================
            const initializeSupabaseAndRenderApp = () => {
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    ReactDOM.render(React.createElement(App), document.getElementById('root'));
                } catch (e) {
                    console.error("Erro ao inicializar o cliente Supabase:", e);
                }
            };

            const supabaseScript = document.createElement('script');
            supabaseScript.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/dist/umd/supabase.min.js";
            supabaseScript.onload = initializeSupabaseAndRenderApp;
            document.head.appendChild(supabaseScript);
        }
    </script>
</body>
</html>
